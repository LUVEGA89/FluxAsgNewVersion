@{
    ViewBag.Title = "Evaluación vendedor";
}

<section class="content-header">
    <h1>
        Evaluación vendedor
        <small>Panel de control</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Reporte SAP</a></li>
        <li class="active">Evaluación vendedor</li>
    </ol>
</section>
<section class="content">

    <div class="row">
        <div class="col-md-4">
            <div class="box box-danger">
                <div class="box-header with-border">
                    <i class="fa fa-bar-chart-o"></i>

                    <h3 class="box-title">Vendedor</h3>

                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                    </div>
                </div>
                <div class="box-body">
                    <form class="form">
                        <div class="form-group">
                            <div class="input-group">
                                <div class="input-group-addon">
                                    <span class="glyphicon glyphicon-search"></span>
                                </div>
                                <input type="text" class="form-control" id="Vendedor" placeholder="Nombre del vendedor">
                            </div>
                            <div class="input-group">
                                <div class="input-group-addon">
                                    <i class="fa fa-calendar"></i>
                                </div>
                                    <input type="text" class="form-control pull-right" id="DelAl">
                            </div>
                        </div>
                        @*<div id="buscar" class="btn btn-block btn-success">Buscar</div>*@
                        @*<br />*@
                        <div class="panel panel-default">
                            <div class="panel-heading">Vendedores encontrados</div>

                            <table class="table table-bordered">

                                <tbody id="content"></tbody>
                            </table>

                        </div>
                    </form>


                </div>
                <!-- /.box-body-->
            </div>
        </div>
        <div class="col-md-8">
            <div class="box box-danger">
                <div class="box-header with-border">
                    <i class="fa fa-bar-chart-o"></i>

                    <h3 class="box-title">Vendedor: <span class="Bold" id="NombreVendedor"></span> </h3>

                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                    </div>
                </div>

                <div class="box-body">
                    <div class="row">
                        <div class="col-md-12">
                            <img id="ImgVendedor" src="dist/img/Users.png" class="img-circle center-block" alt="User Image">
                        </div>
                        @*<div class="col-md-6">
                            <div class="small-box bg-orange">
                                <div class="inner">
                                    <h4 id="VentaActual">0</h4>
                                    <p>Venta del mes</p>
                                </div>
                                <div class="icon">
                                    <i class="ion ion-stats-bars"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="small-box bg-green">
                                <div class="inner">
                                    <h4 id="MetaActual">0</h4>
                                    <p>Meta del mes</p>
                                </div>
                                <div class="icon">
                                    <i class="ion ion-stats-bars"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="small-box bg-teal">
                                <div class="inner">
                                    <h4 id="VentaAnualActual">0</h4>
                                    <p>Venta año actual</p>
                                </div>
                                <div class="icon">
                                    <i class="ion ion-stats-bars"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="small-box bg-gray">
                                <div class="inner">
                                    <h4 id="VentaAnualAnterior">0</h4>
                                    <p>Venta año anterior</p>
                                </div>
                                <div class="icon">
                                    <i class="ion ion-stats-bars"></i>
                                </div>
                            </div>
                        </div>*@
                        <br />
                        <div class="col-md-12">
                            <p class="lead hide">Amount Due 2/22/2014</p>
                            <div class="table-responsive">

                                <table class="table ">
                                    <thead>
                                        <tr>
                                            <th style="width:40%"></th>
                                            <th class="text-center">Anterior</th>
                                            <th class="text-center">Actual</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <th class="text-right">Meta:</th>
                                            <td><span id=""></span></td>
                                            <td><span id="Meta"></span></td>
                                        </tr>
                                        <tr>
                                            <th class="text-right">Carta factura:</th>
                                            <td><span id="CartaFacturaAñoPasado"></span></td>
                                            <td><span id="CartaFactura"></span></td>
                                        </tr>
                                        <tr>
                                            <th class="text-right">Factura:</th>
                                            <td><span id="FacturaAñoPasado"></span></td>
                                            <td><span id="Factura"></span></td>
                                        </tr>
                                        <tr>
                                            <th class="text-right">Total:</th>
                                            <td><span id="TotalAnterior"></span></td>
                                            <td><span id="TotalActual"></span></td>
                                        </tr>
                                        <tr>
                                            <th class="text-right">Cumplimiento:</th>
                                            <td><span id="PorcentajeCumplimientoAnterior"> - </span></td>
                                            <td><span id="PorcentajeCumplimiento"></span></td>
                                        </tr>
                                        <tr>
                                            <th class="text-right">Número de pedidos:</th>
                                            <td><span id="NoPedidosAnteriores"></span></td>
                                            <td><span id="NoPedidosActuales"></span></td>
                                        </tr>
                                        <tr>
                                            <th class="text-right">Monto promedio por pedidos:</th>
                                            <td><span id="PromedioPorPedidoAnterior"></span></td>
                                            <td><span id="PromedioPorPedidoActual"></span></td>
                                        </tr>
                                        <tr>
                                            <th class="text-right">Número de clientes por periodo:</th>
                                            <td><span id="NoClientesAnteriores"></span></td>
                                            <td><span id="NoClientesActuales"></span></td>
                                        </tr>
                                        <tr>
                                            <th class="text-right">% Cartera:</th>
                                            <td><span id="PorcentajeCumplimientoCarteraAnterior"></span></td>
                                            <td><span id="PorcentajeCumplimientoCartera"></span></td>
                                        </tr>
                                        <tr>
                                            <th class="text-right">Monto promedio por clientes:</th>
                                            <td><span id="PromedioMontoPorClienteAnterior"></span></td>
                                            <td><span id="PromedioMontoPorClienteActual"></span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /.box-body-->
            </div>
        </div>
        
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="box box-danger">
                <div class="box-header with-border">
                    <i class="fa fa-bar-chart-o"></i>

                    <h3 class="box-title">Top ventas por estado</h3>

                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                    </div>
                </div>

                <div class="box-body">
                    <div id="bar-chart" style="height: 300px;"></div>
                </div>
                <!-- /.box-body-->
            </div>
        </div>
        <div class="col-md-6">
            <div class="box box-danger">
                <div class="box-header with-border">
                    <i class="fa fa-bar-chart-o"></i>

                    <h3 class="box-title">Clientes por estado</h3>

                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                    </div>
                </div>

                <div class="box-body">
                    <div id="donut-chart" style="height: 400px; padding: 0px; position: relative;">

                    </div>
                </div>
                <!-- /.box-body-->
            </div>
        </div>

    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="box box-danger">
                <div class="box-header with-border">
                    <i class="fa fa-bar-chart-o"></i>

                    <h3 class="box-title">Top ventas vs clientes</h3>

                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                    </div>
                </div>
                <div class="box-body">
                    <table class="table table-bordered">
                        <thead>
                            <tr style="font-weight: bold;">
                                <td>Nombre</td>
                                <td>Monto de venta año anterior</td>
                                <td>Monto de venta año Actual</td>
                                <td>Mes mayor venta</td>
                            </tr>
                        </thead>
                        <tbody id="Ventasclientes"></tbody>
                    </table>
                </div>
                <!-- /.box-body-->
            </div>
        </div>
    </div>
    <div class="row hidden">
        <div class="col-md-6">
            <div class="box box-danger">
                <div class="box-header with-border">
                    <i class="fa fa-bar-chart-o"></i>

                    <h3 class="box-title">Venta por estado </h3>

                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                    </div>
                </div>
                <div class="box-body">
                    <div class="pad">
                        <!-- Map will be created here -->
                    </div>
                </div>
            </div>

        </div>
    </div>
    <script>
        var formatNumber = {
            separador: ",", // separador para los miles
            sepDecimal: '.', // separador para los decimales
            formatear: function (num) {
                num += '';
                var splitStr = num.split('.');
                var splitLeft = splitStr[0];
                var splitRight = splitStr.length > 1 ? this.sepDecimal + splitStr[1] : '';
                var regx = /(\d+)(\d{3})/;
                while (regx.test(splitLeft)) {
                    splitLeft = splitLeft.replace(regx, '$1' + this.separador + '$2');
                }
                return this.simbol + splitLeft + splitRight;
            },
            new: function (num, simbol) {
                this.simbol = simbol || '';
                return this.formatear(num);
            }
        }
    </script>

    <script>
        $('#DelAl').daterangepicker({
            locale: {
                cancelLabel: 'Limpiar',
                daysOfWeek: [
                    "Do",
                    "Lu",
                    "Ma",
                    "Mi",
                    "Ju",
                    "Vi",
                    "Sa"
                ],
                monthNames: [
                     "Enero",
                     "Febrero",
                     "Marzo",
                     "Abril",
                     "Mayo",
                     "Junio",
                     "Julio",
                     "Agosto",
                     "Septiembre",
                     "Octubre",
                     "Noviembre",
                     "Diciembre"
                ]
            }
        });

        //La forma en que despliega los datos en el input cuando da click en aplicar
        $('#DelAl').on('apply.daterangepicker', function (ev, picker) {
            $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));
        });

        //Borrar los datos del input cuando se da clic en limpiar
        $('#DelAl').on('cancel.daterangepicker', function (ev, picker) {
            $(this).val('');
        });

        $("#Vendedor").on('keyup', function (e) {

            FindVendedor();
        });

        function FindVendedor() {
            //$.confirm({
            //    title: '¡Confirmar!',
            //    content: 'Se procedera a buscar al vendedor: ' + $("#Vendedor").val(),
            //    type: 'blue',
            //    buttons: {
            //        confirm: {
            //            text: 'Confirmar',
            //            action: function () {
            $.post('@Url.Action("BuscarVendedor", "Evaluacion")', {
                Vendedor: $("#Vendedor").val()
            }, function (data) {

                $("#content").html('');
                /* Vemos que la respuesta no este vacía y sea una arreglo */
                if (data != null && $.isArray(data.Context)) {
                    /* Recorremos tu respuesta con each */
                    $.each(data.Context, function (index, value) {
                        /* Vamos agregando a nuestra tabla las filas necesarias */
                        $("#content").append("<tr><td class='hidden'>" + value.Sequence + "</td><td>" + value.Nombre + "</td><td><div onclick='getDetalleVendedor(" + value.Sequence + ")' class='btn btn-info'><span class='glyphicon glyphicon-eye-open'></span> Detalles</div></td></tr>");
                        //console.log(value.Sequence);
                        //console.log(value.Nombre);
                    });
                } else {
                    $.alert("No se encontro ningun vendendor con el nombre: " + $("#Vendedor").val());
                }


            });
            //            }
            //        },
            //        cancel: {
            //            text: 'Cancelar',
            //            action: function () {
            //                $.alert('El proceso ha sido cancelado')
            //            }
            //        }
            //    }
            //});
        }
        $("#buscar").click(function () {
            FindVendedor();
        });


        function getDetalleVendedor(Sequence) {
            @*$.post('@Url.Action("DetalleAgente", "Evaluacion")', {
                Vendedor: Sequence
            }, function (data) {
                if (data != null) {
                    $("#MetaActual").html('')
                    $("#VentaActual").html('')
                    $("#VentaAnualActual").html('')
                    $("#VentaAnualAnterior").html('')

                    $("#MetaActual").html(formatNumber.new(data.Context.MetaDelMes.toFixed(2), "$"))
                    $("#VentaActual").html(formatNumber.new(data.Context.MontoDelMes.toFixed(2), "$"))
                    $("#VentaAnualActual").html(formatNumber.new(data.Context.MontoDelAño.toFixed(2), "$"))
                    $("#VentaAnualAnterior").html(formatNumber.new(data.Context.MontoDelAñoPasado.toFixed(2), "$"))
                    $("#ImgVendedor").attr("src", "http://192.168.2.188/Imagenes/Vendedores/" + Sequence + ".jpg")
                    $("#NombreVendedor").html(data.Context.Nombre);

                } else {
                    $.alert("No se encontro ningun vendendor con el nombre: ");
                }
            });*@
            var drp = $('#DelAl').data('daterangepicker');
            var Del = drp.startDate.format('YYYY/MM/DD');
            var Al = drp.endDate.format('YYYY/MM/DD');

            $.post('@Url.Action("InformacionVentas", "Venta")', {
                Sequence: Sequence,
                Del: Del,
                Al: Al
            }, function (data) {
                if (data != null) {
                    console.log(data);

                    $("#NombreVendedor").html(data.Context.Nombre);
                    $("#Meta").html(formatNumber.new(data.Context.Meta.toFixed(2), "$"));
                    $("#CartaFactura").html(formatNumber.new(data.Context.CartaFactura.toFixed(2), "$"));
                    $("#Factura").html(formatNumber.new(data.Context.Factura.toFixed(2), "$"));
                    $("#CartaFacturaAñoPasado").html(formatNumber.new(data.Context.CartaFacturaAñoPasado.toFixed(2), "$"));
                    $("#FacturaAñoPasado").html(formatNumber.new(data.Context.FacturaAñoPasado.toFixed(2), "$"));
                    $("#TotalActual").html(formatNumber.new((data.Context.CartaFactura + data.Context.Factura).toFixed(2), "$"));
                    $("#TotalAnterior").html(formatNumber.new((data.Context.CartaFacturaAñoPasado + data.Context.FacturaAñoPasado).toFixed(2), "$"));
                    $("#NoPedidosActuales").html(data.Context.NoPedidosActuales);
                    $("#NoPedidosAnteriores").html(data.Context.NoPedidosAnteriores);
                    $("#PromedioPorPedidoActual").html(formatNumber.new(data.Context.PromedioPorPedidoActual.toFixed(2), "$"));
                    $("#PromedioPorPedidoAnterior").html(formatNumber.new(data.Context.PromedioPorPedidoAnterior.toFixed(2), "$"));
                    $("#NoClientesActuales").html(data.Context.NoClientesActuales);
                    $("#NoClientesAnteriores").html(data.Context.NoClientesAnteriores);
                    $("#PromedioMontoPorClienteActual").html(formatNumber.new(data.Context.PromedioMontoPorClienteActual.toFixed(2), "$"));
                    $("#PromedioMontoPorClienteAnterior").html(formatNumber.new(data.Context.PromedioMontoPorClienteAnterior.toFixed(2), "$"));

                    $("#PorcentajeCumplimiento").html(data.Context.PorcentajeCumplimiento.toFixed(2) + " %");
                    $("#PorcentajeCumplimientoCartera").html(data.Context.PorcentajeCumplimientoCartera.toFixed(2) + " %");
 
                    $("#ImgVendedor").attr("src", "https://192.168.2.188/Imagenes/Vendedores/" + Sequence + ".jpg")

                } else {
                    $.alert("Ocurrio un error al procesar la solicitud");
                }
            });
            getTopVentasEstados(Sequence);
            getTopVentasEstadoPorcentaje(Sequence);
            TopVentasVsClientes(Sequence);
        }
        function getTopVentasEstados(Sequence) {
            $.post('@Url.Action("VentasEstados", "Evaluacion")', {
                Vendedor: Sequence
            }, function (data) {
                if (data != null && $.isArray(data.Context)) {
                    var DatosArray = [];
                    $.each(data.Context, function (index, value) {
                        DatosArray.push([value.Estado, value.Monto]);
                    });

                    /*
                     * BAR CHART
                     * ---------
                     */
                    var bar_data = {
                        data: DatosArray,
                        color: "#3c8dbc"
                    };

                    $.plot("#bar-chart", [bar_data], {
                        grid: {
                            borderWidth: 1,
                            borderColor: "#f3f3f3",
                            tickColor: "#f3f3f3",
                            hoverable: true
                        },
                        series: {
                            bars: {
                                show: true,
                                barWidth: 0.5,
                                align: "center"
                            }
                        },
                        xaxis: {
                            mode: "categories",
                            tickLength: 0
                        }
                    });
                    //Initialize tooltip on hover
                    $('<div class="tooltip-inner" id="line-chart-tooltip"></div>').css({
                        position: "absolute",
                        display: "none",
                        opacity: 0.8
                    }).appendTo("body");
                    $("#bar-chart").bind("plothover", function (event, pos, item) {

                        if (item) {
                            var x = item.datapoint[0].toFixed(2),
                                y = item.datapoint[1].toFixed(2);
                            $("#line-chart-tooltip").html(formatNumber.new(item.series.data[parseInt(x)][1].toFixed(2), "$"))
                                .css({ top: item.pageY + 5, left: item.pageX + 5 })
                                .fadeIn(200);
                        } else {
                            $("#line-chart-tooltip").hide();
                        }

                    });
                    /* END BAR CHART */

                } else {
                    $.alert("No se encontro ningun vendendor con el nombre: ");
                }


            });
        }

        function getTopVentasEstadoPorcentaje(Sequence) {
            $.post('@Url.Action("ClientesEstadosPorcentaje", "Evaluacion")', {
                Vendedor: Sequence
            }, function (data) {

                if (data != null && $.isArray(data.Context)) {
                    /* Recorremos tu respuesta con each */
                    $("#donut-chart").html('');
                    $("#donut-chart").append('');

                    var DatosArray = [];
                    $.each(data.Context, function (index, value) {
                        DatosArray.push({ label: value.Estado + ' ' + value.Porcentaje.toFixed(2) + ' %', data: value.Porcentaje, color: dame_color_aleatorio() });
                    });

                    var donutData = DatosArray;

                    $.plot("#donut-chart", donutData, {
                        series: {
                            pie: {
                                show: true
                            }
                        },
                        grid: {
                            hoverable: true
                        },
                        legend: {
                            show: true,
                            labelFormatter: function (label, series) {
                                // series is the series object for the label
                                return '<label>' + label + '</label>';

                            }
                        }
                        //series: {
                        //    pie: {
                        //        show: true,
                        //        radius: 1,
                        //        label: {
                        //            show: true,
                        //            radius: 1,
                        //            formatter: labelFormatter,
                        //            background: {
                        //                opacity: 0.5,
                        //                color: '#000'
                        //            }
                        //        }
                        //    }
                        //},
                        //grid: {
                        //    hoverable: true
                        //},
                        //legend: {
                        //    show: false,
                        //},
                        //xaxis: {
                        //    mode: "categories",
                        //    tickLength: 0
                        //}
                    });
                } else {
                    $.alert("No se encontro ningun vendendor con el nombre: " + $("#Vendedor").val());
                }


            });
        }

        function TopVentasVsClientes(Sequence) {
            $.post('@Url.Action("VentasClientes", "Evaluacion")', {
                Vendedor: Sequence
            }, function (data) {

                $("#Ventasclientes").html('');
                /* Vemos que la respuesta no este vacía y sea una arreglo */
                if (data != null && $.isArray(data.Context)) {
                    /* Recorremos tu respuesta con each */
                    $.each(data.Context, function (index, value) {
                        /* Vamos agregando a nuestra tabla las filas necesarias */
                        $("#Ventasclientes").append("<tr><td style='font-weight: bold;'>" + value.Nombre + "</td><td >" + formatNumber.new(value.VentaAñoAnterior.toFixed(2), "$") + "</td><td >" + formatNumber.new(value.VentaAñoActual.toFixed(2), "$") + "</td><td >" + value.MesMayorVenta + "</td></tr>");
                        //console.log(value.Sequence);
                        //console.log(value.Nombre);
                    });
                } else {
                    $.alert("No se encontro ningun vendendor con el nombre: " + $("#Vendedor").val());
                }


            });
        }

    </script>
</section>


<script>





    /*
     * DONUT CHART
     * -----------
     */





</script>