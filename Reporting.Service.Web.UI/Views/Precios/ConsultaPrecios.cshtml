@{
    ViewBag.Title = "ConsultaPrecios";
}
@model Reporting.Service.Web.UI.Models.Producto
<style>
    #reference-table {
        z-index: 99;
        display: none;
        right: 0px;
        position: absolute;
        height: auto;
    }

    .direct-chat-messages {
        -webkit-transform: translate(0, 0);
        -ms-transform: translate(0, 0);
        -o-transform: translate(0, 0);
        transform: translate(0, 0);
        padding: 10px;
        height: 500px;
        overflow: auto;
    }
    /*
        #reference-table{
        z-index:99;
        width:auto;
        height:auto;
        display:none;
        position:absolute;
        left:auto;
        right:auto;
        top:0 auto;
    }

    .reference-table {
        border-style: solid;
        border-width: 5px;
    }
            */
</style>
<section class="content-header">
    <h1>
        Productos
        <small>Consulta de precios</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Productos </a></li>
        <li class="active"> Consulta Precios</li>
        <li class="active">APG</li>
    </ol>
</section>
<section class="content">
    
    <div class="row">
        <!--------------------------Caja de Referencias Tipo chat------------------------------------>
        <div class="col-md-3" id="reference-table">
            <div class="box box-danger direct-chat direct-chat-danger">
                <div class="box-header with-border">
                    <h3 class="box-title">Busqueda de referencias</h3>
                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                        <!--<button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>-->
                    </div>
                </div>
                <div class="box-body">
                    <div class="direct-chat-messages">
                        <div class="direct-chat-msg">
                            <div class="box box-custom">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th style="width: 10px">SKU</th>
                                            <th style="width: 30px">LISTA</th>
                                            <th style="width: 20px">PRECIOS CON IVA</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-search-reference"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="box-footer">
                    <form action="#" method="post">
                        <div class="input-group">
                            <input name="message" placeholder="Referencia ..." class="form-control" id="txt-search-reference" type="text">
                            <span class="input-group-btn">
                                <button type="submit" class="btn btn-success btn-flat" id="btn-search-reference">Buscar</button>
                            </span>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!------------------------Primer caja para modificacion de precios--------------------------->
        <div class="col-md-12">
            
            <div class="box box-danger">
                <div class="box-header">
                    <i class="fa fa-level-down"></i>
                    <h3 class="box-title">Precios SAP</h3>
                    <div class="box-tools pull-right">
                        <button id="btn-DetalleSku" type="button" class="btn btn-box-tool"><i class="fa fa-file-excel-o"></i></button>
                    </div>
                </div>
                <div class="box-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="table-responsive">
                                <!-----------------------------------Tabla de Precios------------------------------>
                                <table id="busca-precios" class="table table-bordered busca-precios-class">
                                    <thead>
                                        <tr>
                                            <!-------------------Botones de busqueda-------------------->
                                            <th colspan="7" style="background-color: #d4d4d4;">
                                                <input type="text" id="ItemCode" class="form-control" placeholder="Ingresa el SKU">
                                                <div class="btn-group">

                                                    <button type="button" class="btn btn-primary" id="click-buscar">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Buscar&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</button>

                                                </div>
                                            </th>


                                            <!-------------------Grupo de cabeceras-------------------->
                                            <th colspan="3" class="thlpp1">SAP 40<br /> ULTRA</th>
                                            <th colspan="2" class="colorefxhp">SAP 39 PREMIUM</th>
                                            <th colspan="2" class="thlpp1">SAP 38 EXCELENCIA</th>
                                            <th colspan="3" class="colorefxhp">SAP 15 (FR)</th>
                                            <th colspan="3" class="thlpp1">SAP 6<br />Retail A</th>
                                            <th colspan="3" class="colorefxhp">SAP 3 <br />Retail AA</th>
                                            <th colspan="3" class="thlpp1">SAP 2<br />Retail AAA</th>
                                            <th colspan="4" class="colorefxhp">Mayoreo Tiendas Locales 33</th>
                                            <th colspan="4" class="thlpp1">Mayoreo Foraneas 25</th>
                                            <th colspan="4" class="colorefxhp">Publico Suc 14</th>
                                            <th colspan="4" class="thlpp1">Mayoreo WEB 48</th>
                                            <th colspan="4" class="colorefxhp">Publico WEB 47</th>
                                            <th colspan="4" class="thlpp1">Mayoreo Franquicias 29</th>
                                            <th colspan="4" class="colorefxhp">Publico Franquicias 28</th>
                                            <th colspan="4" class="thlpp1">Distribuidor Local 22</th>
                                            <th colspan="4" class="colorefxhp">Distribuidor Foraneo 42</th>

                                        </tr>
                                        <tr class="thlppc">
                                            <!-------------------Cabecera Busqueda(40)-------------------->
                                            <th class="colorefx">SKU</th>
                                            <th class="colorefx" style="width:300px;">Tipo Precio</th>
                                            <th class="colorefx" style="width:230px;">FAM SIAT</th>
                                            <th class="colorefx">PZS MAY</th>
                                            <th class="colorefx">PZS MAY COR</th>
                                            <th class="colorefx">CMex S/IVA (SAP 41)</th>
                                            <th class="colorefx">STGP S/IVA (SAP 10)</th>
                                            <!-------------------Cabecera SAP(40)------------------------>
                                            <th class='coloref'>S/I</th>
                                            <th class='coloref'>C/IVA</th>
                                            <th class='coloref'>MARGEN</th>
                                            <!-------------------Cabecera SAP 39(F2)--------------------->
                                            <th class='colorefxp'>S/I</th>
                                            <th class='colorefxp'>C/IVA</th>
                                            <!-------------------Cabecera SAP 38 (F1)-------------------->
                                            <th class='coloref'>S/I</th>
                                            <th class='coloref'>C/IVA</th>
                                            <!-------------------Cabecera SAP 15 (FR)-------------------->
                                            <th class='colorefxp'>S/I</th>
                                            <th class='colorefxp'>C/IVA</th>
                                            <th class='colorefxp'>MARGEN</th>
                                            <!-------------------Cabecera Retail A-------------------->
                                            <th class='coloref'>S/I</th>
                                            <th class='coloref'>C/IVA</th>
                                            <th class='coloref'>MARGEN</th>
                                            <!-------------------Cabecera Retail AA-------------------->
                                            <th class='colorefxp'>S/I</th>
                                            <th class='colorefxp'>C/IVA</th>
                                            <th class='colorefxp'>MARGEN</th>
                                            <!-------------------Cabecera Retail AAA-------------------->
                                            <th class='coloref'>S/I</th>
                                            <th class='coloref'>C/IVA</th>
                                            <th class='coloref'>MARGEN</th>
                                            <!-------------------Mayoreo Tiendas Locales 33--------------->
                                            <th class='colorefxp'>P. Minimo</th>
                                            <th class='colorefxp'>S/I</th>
                                            <th class='colorefxp'>C/IVA</th>
                                            <th class='colorefxp'>MARGEN VS STGP</th>
                                            <!-------------------Mayoreo Foraneas 25--------------------->
                                            <th class='coloref'>P. Minimo</th>
                                            <th class="coloref">S/I</th>
                                            <th class="coloref">C/IVA</th>
                                            <th class="coloref">MARGEN VS STGP</th>
                                            <!-------------------Mayoreo Publico Suc 14------------------>
                                            <th class='colorefxp'>P. Minimo</th>
                                            <th class='colorefxp'>S/I</th>
                                            <th class='colorefxp'>C/IVA</th>
                                            <th class='colorefxp'>MARGEN VS STGP</th>
                                            <!-------------------Mayoreo WEB 48-------------------------->
                                            <th class='coloref'>P. Minimo</th>
                                            <th class="coloref">S/I</th>
                                            <th class="coloref">C/IVA</th>
                                            <th class="coloref">MARGEN VS FRN</th>
                                            <!-------------------Publico WEB 47-------------------------->
                                            <th class='colorefxp'>P. Minimo</th>
                                            <th class='colorefxp'>S/I</th>
                                            <th class='colorefxp'>C/IVA</th>
                                            <th class='colorefxp'>MARGEN VS FRN</th>
                                            <!-------------------Mayoreo Franquicias 29------------------>
                                            <th class='coloref'>P. Minimo</th>
                                            <th class="coloref">S/I</th>
                                            <th class="coloref">C/IVA</th>
                                            <th class="coloref">MARGEN VS FRN</th>
                                            <!-------------------Publico Franquicias 28------------------>
                                            <th class='colorefxp'>P. Minimo</th>
                                            <th class='colorefxp'>S/I</th>
                                            <th class='colorefxp'>C/IVA</th>
                                            <th class='colorefxp'>MARGEN VS FRN</th>
                                            <!-------------------Distribuidor  Local 22------------------>
                                            <th class='coloref'>P. Minimo</th>
                                            <th class='coloref'>S/I</th>
                                            <th class='coloref'>C/IVA</th>
                                            <th class='coloref'>MARGEN VS FRN</th>
                                            <!-------------------Distribuidor  Foraneo 42------------------>
                                            <th class='coloref'>P. Minimo</th>
                                            <th class='coloref'>S/I</th>
                                            <th class='coloref'>C/IVA</th>
                                            <th class='coloref'>MARGEN VS FRN</th>
                                        </tr>
                                    </thead>
                                    <tbody id="detalle-lista-precios"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="cargandoPrecios" style="display:none;" class="overlay">
                        <i class="fa fa fa-refresh fa-spin"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
        

    
</section>

<script type="text/javascript">

    //Busca la lista de precios por item code
    function myFunctionSearchReference() {
        let ItemCode = $('#txt-search-reference').val();
        $.post('@Url.Action("ListaPrecioBusquedasReferencia", "Precios")', {
            ItemCode
        }, function (data) {
           
            if (data != null && $.isArray(data.Context) ) {
                $("#table-search-reference").html('');

                $.each(data.Context, function (index, value) {
                    if (value.PriceList == 9) {
                        value.PriceList = 'Carta Factura'
                    }
                    if (value.PriceList == 15) {
                        value.PriceList = 'FRN';
                        let add_super = value.Price * 0.93;
                        value.Price = add_super * 1.16;
                    }
                    if (value.PriceList == 33) {
                        value.PriceList = 'Mayoreo Tiendas Locales';
                        value.Price = (value.Price * 1.16);
                    }
                    if (value.PriceList == 25) {
                        value.PriceList = 'Mayoreo Foraneas';
                        value.Price = (value.Price * 1.16);
                    }
                    if (value.PriceList == 14) {
                        value.PriceList = 'Publico Sucursales y Web';
                        value.Price = (value.Price * 1.16);
                    }
                    if (value.PriceList == 29) {
                        value.PriceList = 'Mayoreo Franquicias';
                        value.Price = (value.Price * 1.16);
                    }
                    if (value.PriceList == 28) {
                        value.PriceList = 'Publico Franquicias';
                        value.Price = (value.Price * 1.16);
                    }
                    $("#table-search-reference").append(
                        "<tr>\
                            <td class=''>"+value.ItemCode + "</td>\
                            <td class='lista-precio-"+index+"'>" + value.PriceList + "</td>\
                            <td>" + formatNumber.new(value.Price.toFixed(2), "$ ") + "</td>\
                         </tr>");

                });
            } else {
                swal("Error en la api: ListaPrecioBusquedas");
            }
        });
    }
    //Busca la lista de precios por item code
    function myFunctionSearch() {
        
        if ($('#ItemCode').val() == "") {
            swal("Atención", "Ingresa un SKU", "warning");
            return;
        }
        let ItemCode = $('#ItemCode').val();
        let User = localStorage.getItem("UserEmail");
        //Se muestra estado de carga al usuario
        $('#cargandoPrecios').show();    

        $.post('@Url.Action("ListaPrecioBusquedas", "Precios")', {
            ItemCode
        }, function (data) {
            if (data != null && $.isArray(data.Context)) {

                if (data.Context.length == 0) {
                    $('#cargandoPrecios').hide();  
                    swal("Atención","No se encontró registro de este SKU","warning")
                    return
                }
                
                $("#detalle-lista-precios").html('');
                $.each(data.Context, function (index, value) {
                    
                        $("#detalle-lista-precios").append(
                            //Renglon de los datos obtenidos del SKU (oculto)
                            "<tr class='Listas' style='background:#cce6ff' id='tr-change-color-" + index + "'>\
                                <td>" + value.ItemCode + "</td>\
                                <td>"+value.TipoPrecio + "</td >\
                                <td>" + value.FamSIAT + "</td>\
                                <td>" + value.PzaMay + "</td>\
                                <td>" + value.PzaMayCorp + "</td>\
                                <td class='wht'>$ " + formatNumber.new(value.CMex.toFixed(3)) + "</td>\
                                <td class='wht'>$ " + formatNumber.new(value.STGP10.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.Lista40.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.Lista40_iva.toFixed(3)) + "</td>\
                                <td class='colore wht'>% " + formatNumber.new(value.Mbvsstgp_40.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>$ " + formatNumber.new(value.Lista39.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>$ " + formatNumber.new(value.Lista39_iva.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.Lista38.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.Lista38_iva.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>$ " + formatNumber.new(value.Lista15.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>$ " + formatNumber.new(value.Lista15_iva.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>% " + formatNumber.new(value.Mbvsstgp_15.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.Lista6.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.Lista6_iva.toFixed(3)) + "</td>\
                                <td class='colore wht'>% " + formatNumber.new(value.Mbvsstgp_6.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>$ " + formatNumber.new(value.Lista3.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>$ " + formatNumber.new(value.Lista3_iva.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>% " + formatNumber.new(value.Mbvsstgp_3.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.Lista2.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.Lista2_iva.toFixed(3)) + "</td>\
                                <td class='colore wht'>% " + formatNumber.new(value.Mbvsstgp_2.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>$ " + formatNumber.new(value.PMin33.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>$ " + formatNumber.new(value.Lista33.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>$ " + formatNumber.new(value.Lista33_iva.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>% " + formatNumber.new(value.Mbvsstgp_33.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.PMin25.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.Lista25.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.Lista25_iva.toFixed(3)) + "</td>\
                                <td class='colore wht'>% " + formatNumber.new(value.Mbvsstgp_25.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>$ " + formatNumber.new(value.PMin14.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>$ " + formatNumber.new(value.Lista14.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>$ " + formatNumber.new(value.Lista14_iva.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>% " + formatNumber.new(value.Mbvsstgp_14.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.PMin48.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.Lista48.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.Lista48_iva.toFixed(3)) + "</td>\
                                <td class='colore wht'>% " + formatNumber.new(value.Mbvsstgp_48.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>$ " + formatNumber.new(value.PMin47.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>$ " + formatNumber.new(value.Lista47.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>$ " + formatNumber.new(value.Lista47_iva.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>% " + formatNumber.new(value.Mbvsstgp_47.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.PMin29.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.Lista29.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.Lista29_iva.toFixed(3)) + "</td>\
                                <td class='colore wht'>% " + formatNumber.new(value.Mbvsstgp_29.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>$ " + formatNumber.new(value.PMin28.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>$ " + formatNumber.new(value.Lista28.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>$ " + formatNumber.new(value.Lista28_iva.toFixed(3)) + "</td>\
                                <td class='colorefp wht'>% " + formatNumber.new(value.Mbvsstgp_28.toFixed(3)) + "</td>\
                                <td class='colore  wht'>$ " + formatNumber.new(value.PMin22.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.Lista22.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.Lista22_iva.toFixed(3)) + "</td>\
                                <td class='colore wht'>% " + formatNumber.new(value.Mbvsstgp_22.toFixed(3)) + "</td>\
                                <td class='colore  wht'>$ " + formatNumber.new(value.PMin42.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.Lista42.toFixed(3)) + "</td>\
                                <td class='colore wht'>$ " + formatNumber.new(value.Lista42_iva.toFixed(3)) + "</td>\
                                <td class='colore wht'>% " + formatNumber.new(value.Mbvsstgp_42.toFixed(3)) + "</td>\
                        </tr >");
                      
                    
                   
                    $(".hidden-price-id-" + index).hide();
                   
                    //AJAX para combo del tipo de precio 
                    $.ajax({
                        contentType: "application/json; charset=utf-8",
                        url: '@Url.Action("GetTipoPrecios", "Precios")',
                        async: false,
                        timeout: 3000,
                        type: 'POST',
                        dataType: "json",
                        success: function (data) {
                            if (data.Context != null) {
                                let selected = $('#selected-tipoprecio-' + index);
                                $.each(data.Context, function (index, value1) {
                                    if (value1.Descripcion == value.TipoPrecio) {
                                        selected.append(
                                            "<option selected='selected' value='" + value1.Identifier + "'>" + value1.Descripcion + "</option>");
                                    }
                                    else {
                                        selected.append(
                                            "<option class='SelectedTipoPrecio' value='" + value1.Identifier + "'>" + value1.Descripcion + "</option>");
                                    }
                                });
                            }
                        },
                    });


                });
                $('#cargandoPrecios').hide(); 
            } else {
                
                $('#cargandoPrecios').hide();
                swal("Error","Error en la api: ListaPrecioBusquedas","error");
            }
         });
    }

   
    
</script>

<script>

  

    //Function enter lista de precios search ----------TECLA ENTER
    $("#ItemCode").keypress(function (e) {
        if (e.keyCode == 13) {
            myFunctionSearch();
        }
    });
    //Funcion para evento click y buscar skus----------BOTON BUSCAR
    $("#click-buscar").on("click", function (e) {
        e.preventDefault();
        myFunctionSearch();
    });
    //Function enter lista de precios search
    $("#txt-search-reference").keypress(function (e) {
        if (e.keyCode == 13) {
            myFunctionSearchReference();
        }
    });
    //Funcion para evento click y buscar skus
    $("#btn-search-reference").on("click", function (e) {
        e.preventDefault();
        myFunctionSearchReference();
    });

    //Valida unicamente numeros
    function isNumberKey(evt) {
        var charCode = (evt.which) ? evt.which : event.keyCode
        if (charCode > 31 && (charCode < 48 || charCode > 57))
            return false;
        return true;
    }
    //Valida que no existan letras
    $(document).on("keyup", ".decimal", function () {
        var val = $(this).val();
        if (isNaN(val)) {
            val = val.replace(/[^0-9\.]/g, '');
            if (val.split('.').length > 2)
                val = val.replace(/\.+$/, "");
        }
        $(this).val(val);
    });
    //Tabla de referencia movinle
    $('.click').click(function () {
        $('#reference-table').show();
        $('#reference-table').draggable();
    });
    $('#close-reference-price').click(function () {
        $('#reference-table').hide();
    });
   
    //Formato de dinero
    var formatNumber = {
        separador: ",",
        sepDecimal: '.',
        formatear: function (num) {
            num += '';
            var splitStr = num.split('.');
            var splitLeft = splitStr[0];
            var splitRight = splitStr.length > 1 ? this.sepDecimal + splitStr[1] : '';
            var regx = /(\d+)(\d{3})/;
            while (regx.test(splitLeft)) {
                splitLeft = splitLeft.replace(regx, '$1' + this.separador + '$2');
            }
            return this.simbol + splitLeft + splitRight;
        },
        new: function (num, simbol) {
            this.simbol = simbol || '';
            return this.formatear(num);
        }
    }
    
</script>