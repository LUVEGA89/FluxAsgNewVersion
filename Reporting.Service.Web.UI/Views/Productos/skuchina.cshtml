@model Reporting.Service.Web.UI.Models.SkuChinaModel
@{
    ViewBag.Title = "SKU china";
}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.js"></script>

<style>
    .input-group .input-group-addon {
        min-width: 100px !important;
    }
</style>

<section class="conntent-header">
    <h1>
        Productos
        <small>Panel de control</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Productos</a></li>
        <li class="active">China (SKU´s)</li>
    </ol>
</section>
<section class="content">
    <div class="row">
        <div class="col-md-12">
            <div class="box box-danger">
                <div class="box-header with-border">
                    <h3 class="box-title">China (SKU´s)</h3>
                    <!--<button type="button" id="btn-descargaReport-FacEmitida" class="btn btn-xs pull-right btn-spacing bg-blue" data-toggle="modal" style="display:none;padding:5px; color:white; border-radius:5px;"> Descargar reporte <i class="glyphicon glyphicon-download" style="width:20px"></i></button>-->
                    <div class="box-tools ">
                        FILTROS
                    </div>
                </div>
                <div class="box-body">
                    <div class="row">
                        <div class="col-lg-6 col-md-6">
                            <div class="form-group">
                                <div class="input-group">
                                    <span class="input-group-addon">Familia:</span>
                                    <select name="cbxFamilia" id="cbxFamilia" class="form-control consultar">
                                        @foreach (var td in this.Model.Familias)
                                        {
                                            <option value="@td.Nombre">@td.Nombre </option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6">
                            <div class="input-group">
                                <span class="input-group-addon">
                                    <span class="glyphicon glyphicon-search"></span>
                                </span>
                                <input class="form-control" id="Sku" onkeyup="ProductosChinaSku()" placeholder="Sku" type="text">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6 col-md-6">
                            <div class="form-group">
                                <div class="input-group">
                                    <span class="input-group-addon">Categoria:</span>
                                    <select name="cbxCategoria" id="cbxCategoria" class="form-control consultar">
                                        <option value="SELECCIONE">SELECCIONE</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6">
                            <ul class="list-inline pull-left">
                                <li><button type="reset" class="btn btn-primary" style="min-width:135px !important;"><i class="glyphicon glyphicon-stop list-inline pull-left"></i> Nuevos </button></li>
                            </ul>
                            <ul class="list-inline pull-right">
                                <li><button class="btn btn-danger DonwloadPdf"><i class="glyphicon glyphicon-download"></i> Descargar busqueda en PDF</button></li>
                            </ul>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6 col-md-6">
                            <div class="form-group">
                                <div class="input-group">
                                    <span class="input-group-addon">Clasificacion:</span>
                                    <select name="cbxClasificacion" id="cbxClasificacion" class="form-control consultar">
                                        <option value="SELECCIONE">SELECCIONE</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6">
                            <ul class="list-inline pull-left">
                                <li><button class="btn btn-success" style="min-width:135px !important;"><i class="glyphicon glyphicon-stop list-inline pull-left"></i> Activos </button></li>
                            </ul>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6 col-md-6">
                            <div class="form-group">
                                <div class="input-group">
                                    <span class="input-group-addon">Tipo:</span>
                                    <select name="cbxTipo" id="cbxTipo" class="form-control consultar">
                                        <option value="SELECCIONE">SELECCIONE</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6">
                            <ul class="list-inline pull-left">
                                <li><button class="btn btn-danger" style="min-width:135px !important;"><i class="glyphicon glyphicon-stop list-inline pull-left"></i> Descontinuados </button></li>
                            </ul>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12 col-md-12">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h3 class="panel-title">Resultado</h3>
                                </div>
                                <div class="panel-body" id="detalle-listado">

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="box-footer">

                </div>
                <div id="ButtonsWait" style="display:none;" class="overlay">
                    <i class="fa fa-refresh fa-spin"></i>
                </div>
            </div>
        </div>
    </div>
</section>
<div class="modal fade" id="Comentarios" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="TituloComentarios"></h4>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <span class="input-group-addon">Comentarios</span>
                    <textarea id="TextAreaComentarios" class="form-control"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="BtnGuardarComentario">Guardar</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="DetallesSku" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12" id="generales"> </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
<!--Modal Anexos-->
<div class="modal fade" id="modalAnexos" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="col-md-6">
                    <h5 class="modal-title">Detalle de las evidencias</h5>
                </div>
                <div class="col-md-6">
                    <button type="button" class="close pull-right" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">x</span>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div class="box-header">
                    <i class="fa fa-level-down"></i>
                    <h3 class="box-title">Evidencias</h3>
                </div>
                <div class="box-body" style="display: block;">

                    <div class="table-responsive table-responsive-custom">
                        <table class="table table-bordered" id="tablaAnex">
                            <thead>
                                <tr class="table-primary">
                                    <th class="th-stationery">Archivo</th>
                                    <th class="th-stationery">Descargar</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyAnex"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
<script src="https://unpkg.com/jspdf-autotable@2.3.1/dist/jspdf.plugin.autotable.js"></script>
<script>
    var IsAdminOrDireccion = false;
    @if (User.IsInRole("Administrador") || User.IsInRole("Direccion") || User.IsInRole("AlmacenAdmin")) {
        <text>
            IsAdminOrDireccion = true;
        </text>
    }



    INITModule();
	var CurrentSearch;

    function INITModule() {
        //Desabilitar los combos
        $("#cbxCategoria").prop('disabled', true);
        $("#cbxClasificacion").prop('disabled', true);
        $("#cbxTipo").prop('disabled', true);
    }

    $("#cbxFamilia").change(function () {
        $("#cbxCategoria").prop('disabled', false).val("SELECCIONE");
        $("#cbxClasificacion").prop('disabled', true).val("SELECCIONE");
        $("#cbxTipo").prop('disabled', true).val("SELECCIONE");

        $.post('@Url.Action("GetCategorias", "Productos")',
            {
                Familia: $("#cbxFamilia").val()
            },
            function (data) {
                if (data != null && $.isArray(data.Context)) {

                    $("#cbxCategoria").html('');

                    $.each(data.Context, function (index, value) {
                        $("#cbxCategoria").append('<option value="'+value.nameCate+'">'+value.nameCate+'</option>');
                    });

                } else {
                    $.alert("No se encontraron categorias");
                }
            });

        ProductosChina();
    });

    $("#cbxCategoria").change(function () {
        $("#cbxClasificacion").prop('disabled', false).val("SELECCIONE");
        $("#cbxTipo").prop('disabled', true).val("SELECCIONE");

        $.post('@Url.Action("GetClasificaciones", "Productos")',
            {
                Categoria: $("#cbxCategoria").val()
            },
            function (data) {
                if (data != null && $.isArray(data.Context)) {

                    $("#cbxClasificacion").html('');

                    $.each(data.Context, function (index, value) {
                        $("#cbxClasificacion").append('<option value="' + value.Nombre + '">' + value.Nombre + '</option>');
                    });

                } else {
                    $.alert("No se encontraron clasificaciones");
                }
            });

        ProductosChina();
    });

    $("#cbxClasificacion").change(function () {
        $("#cbxTipo").prop('disabled', false).val("SELECCIONE");

        $.post('@Url.Action("GetTipos", "Productos")',
            {
                Categoria: $("#cbxCategoria").val(),
                Clasificacion: $("#cbxClasificacion").val()
            },
            function (data) {
                if (data != null && $.isArray(data.Context)) {

                    $("#cbxTipo").html('');

                    $.each(data.Context, function (index, value) {
                        $("#cbxTipo").append('<option value="' + value.Nombre + '">' + value.Nombre + '</option>');
                    });

                } else {
                    $.alert("No se encontraron tipos");
                }
            });

        ProductosChina();
    });

    $("#cbxTipo").change(function () {
        ProductosChina();
    });

    //$(".consultar").change(function () {
      //  ProductosChina();
    //});

    function ProductosChinaSku() {
        $("#cbxFamilia").val("SELECCIONE");
        $("#cbxCategoria").val("SELECCIONE");
        $("#cbxClasificacion").val("SELECCIONE");
        $("#cbxTipo").val("SELECCIONE");

        $.post('@Url.Action("ListaProductosChina", "Productos")', {
            Sku: $("#Sku").val(),
            Familia: $("#cbxFamilia").val(),
            Categoria: $("#cbxCategoria").val(),
            Clasificacion: $("#cbxClasificacion").val(),
            Tipo: $("#cbxTipo").val()
        },
                        function (data) {
                            if (data != null && $.isArray(data.Context)) {

                                $("#detalle-listado").html('');
                                var i = 1;
                                var inicio = '<div class="row">';
                                var fin = '<div>';
                                var items = '';
                                var status;
                                var TotalRegistros = data.Context.length;
                                var romper = 1;
                                var costousd = 0;
                                //alert(data.Context.length);
								CurrentSearch = data.Context;
                                $.each(data.Context, function (index, value) {
                                    if (value.Activo == 1) { //Activo
                                        status = 'btn-success';
                                        status1 = 'success';
                                    }else if(value.Activo == 2){ //Nuevo
										status = 'btn-primary';
                                        status1 = 'primary';
									} else {    //Descontinuado
                                        status = 'btn-danger';
                                        status1 = 'danger';
                                    }

                                    if (IsAdminOrDireccion) {
                                        costousd = formatNumber.new(value.Costo_USD, 'USD ');
                                        //console.log("Es Admin");
                                    }
                                    else {
                                        costousd = formatNumber.new(0.0, 'USD ');
                                    }

                                    if (i <= 3 && TotalRegistros >= 3) {
                                        items = items + '<div class="col-md-4 col-sm-6 col-xs-12">\
                                                                    <div class="thumbnail" >\
                                                                        <img style="height:400px !important;" src="https://apps.fussionweb.com/sive/Products/1_SAP/' + value.SKU + '.jpg" alt="...">\
                                                                        <div class="caption">\
                                                                            <span class="" style="font-size:110% !Important"><strong>Modelo : </strong>' + value.SKU + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>Stock CEDIS : </strong>' + value.Stock_CEDIS + '</span> </br> \
                                                                            <span class="" style="font-size:110% !Important"><strong>Costo USD : </strong>' + costousd + '</span> </br> \
                                                                            <span class="" style="font-size:110% !Important"><strong>Tipo de precio : </strong>' + value.TipoPrecio + '</span> </br> \
                                                                            <span class="" style="font-size:110% !Important"><strong>Precio ultra c/iva : </strong>' + formatNumber.new(value.PrecioUltra.toFixed(2), '$ ') + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>Canal : </strong>' + value.Canal + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>StatusC : </strong>' + value.StatusC + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>Cliente : </strong>' + value.Cliente + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>Marca : </strong>' + value.Marca + '</span> </br>\
                                                                        </div>\
                                                                        <div class="btn ' + status + ' btn-block" onclick="VerDetalle(\'' + value.SKU + '\')">\
                                                                            <span class="glyphicon glyphicon-zoom-in"></span> Ver\
                                                                        </div>\
                                                                        <div class="btn ' + status + ' btn-block" onclick="GuardarComentario(\'' + value.SKU + '\')">\
                                                                            <span class="glyphicon glyphicon-text-color"></span> Comentario\
                                                                        </div>\
                                                                    </div>\
                                                                </div>';
                                    }
                                    if (i == 3) {
                                        $("#detalle-listado").append(inicio + items + fin);
                                        items = '';
                                        i = 0;
                                        TotalRegistros = TotalRegistros - 3
                                        //alert(data.Context.length);
                                        if (TotalRegistros < 3 && data.Context.length != 3) {
                                            return true;
                                        }

                                    }
                                    if (TotalRegistros < 3 && data.Context.length != 3) {
                                        /*if(romper = 1){
                                            items = '';
                                            romper = 0;
                                        }*/

                                        items = items + '<div class="col-md-4 col-sm-6 col-xs-12">\
                                                                    <div class="thumbnail" >\
                                                                        <img style="height:400px !important;" src="https://apps.fussionweb.com/sive/Products/1_SAP/' + value.SKU + '.jpg" alt="...">\
                                                                        <div class="caption">\
                                                                            <span class="" style="font-size:110% !Important"><strong>Modelo : </strong>' + value.SKU + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>Stock CEDIS : </strong>' + value.Stock_CEDIS + '</span> </br> \
                                                                            <span class="" style="font-size:110% !Important"><strong>Costo USD : </strong>' + costousd + '</span> </br> \
                                                                            <span class="" style="font-size:110% !Important"><strong>Tipo de precio : </strong>' + value.TipoPrecio + '</span> </br> \
                                                                            <span class="" style="font-size:110% !Important"><strong>Precio ultra c/iva : </strong>' + formatNumber.new(value.PrecioUltra.toFixed(2), '$ ') + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>Canal : </strong>' + value.Canal + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>StatusC : </strong>' + value.StatusC + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>Cliente : </strong>' + value.Cliente + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>Marca : </strong>' + value.Marca + '</span> </br>\
                                                                        </div>\
                                                                        <div class="btn ' + status + ' btn-block" onclick="VerDetalle(\'' + value.SKU + '\')">\
                                                                            <span class="glyphicon glyphicon-zoom-in"></span> Ver\
                                                                        </div>\
                                                                        <div class="btn ' + status + ' btn-block" onclick="GuardarComentario(\'' + value.SKU + '\')">\
                                                                            <span class="glyphicon glyphicon-text-color"></span> Comentario\
                                                                        </div>\
                                                                    </div>\
                                                                </div>';
                                        TotalRegistros = TotalRegistros - 1;
                                        //alert(JSON.stringify(items));
                                        //alert("se pintan los ultimos registros: " + TotalRegistros);
                                    }
                                    if (TotalRegistros <= 0 && data.Context.length != 3) {
                                        //alert("Total debe ser igual a cero: "+TotalRegistros);
                                        $("#detalle-listado").append(inicio + items + fin);
                                    }


                                    i++;
                                });
                            } else {
                                $.alert("No se encontraron registros");
                            }
                        });
    }

    function ProductosChina() {
        $("#Sku").val('');

        $.post('@Url.Action("ListaProductosChina", "Productos")', {
            Sku: $("#Sku").val(),
            Familia: $("#cbxFamilia").val(),
            Categoria: $("#cbxCategoria").val(),
            Clasificacion: $("#cbxClasificacion").val(),
            Tipo: $("#cbxTipo").val()
        },
                        function (data) {
                            if (data != null && $.isArray(data.Context)) {

                                $("#detalle-listado").html('');
                                var i = 1;
                                var inicio = '<div class="row">';
                                var fin = '<div>';
                                var items = '';
                                var status;
                                var TotalRegistros = data.Context.length;
                                var romper = 1;
                                var costousd = 0;
                                //alert(data.Context.length);
								CurrentSearch = data.Context;
                                $.each(data.Context, function (index, value) {
                                    if (value.Activo == 1) {
                                        status = 'btn-success';
                                        status1 = 'success';
                                    } else if(value.Activo == 2){
										status = 'btn-primary';
                                        status1 = 'primary';
									}
									else {
                                        status = 'btn-danger';
                                        status1 = 'danger';
                                    }

                                    if (IsAdminOrDireccion) {
                                        costousd = formatNumber.new(value.Costo_USD, 'USD ');
                                        //console.log("Es Admin");
                                    }
                                    else {
                                        costousd = formatNumber.new(0.0, 'USD ');
                                    }

                                    if (i <= 3 && TotalRegistros >= 3) {
                                        items = items + '<div class="col-md-4 col-sm-6 col-xs-12">\
                                                                    <div class="thumbnail" >\
                                                                        <img style="height:400px !important;" src="https://apps.fussionweb.com/sive/Products/1_SAP/' + value.SKU + '.jpg" alt="...">\
                                                                        <div class="caption">\
                                                                            <span class="" style="font-size:110% !Important"><strong>Modelo : </strong>' + value.SKU + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>Stock CEDIS : </strong>' + value.Stock_CEDIS + '</span> </br> \
                                                                            <span class="" style="font-size:110% !Important"><strong>Costo USD : </strong>' + costousd + '</span> </br> \
                                                                            <span class="" style="font-size:110% !Important"><strong>Tipo de precio : </strong>' + value.TipoPrecio + '</span> </br> \
                                                                            <span class="" style="font-size:110% !Important"><strong>Precio ultra c/iva : </strong>' + formatNumber.new(value.PrecioUltra.toFixed(2), '$ ') + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>Canal : </strong>' + value.Canal + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>StatusC : </strong>' + value.StatusC + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>Cliente : </strong>' + value.Cliente + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>Marca : </strong>' + value.Marca + '</span> </br>\
                                                                        </div>\
                                                                        <div class="btn ' + status + ' btn-block" onclick="VerDetalle(\'' + value.SKU + '\')">\
                                                                            <span class="glyphicon glyphicon-zoom-in"></span> Ver\
                                                                        </div>\
                                                                        <div class="btn ' + status + ' btn-block" onclick="GuardarComentario(\'' + value.SKU + '\')">\
                                                                            <span class="glyphicon glyphicon-text-color"></span> Comentario\
                                                                        </div>\
                                                                    </div>\
                                                                </div>';
                                    }
                                    if (i == 3) {
                                        $("#detalle-listado").append(inicio + items + fin);
                                        items = '';
                                        i = 0;
                                        TotalRegistros = TotalRegistros - 3
                                        //alert(data.Context.length);
                                        if (TotalRegistros < 3 && data.Context.length != 3) {
                                            return true;
                                        }

                                    }
                                    if (TotalRegistros < 3 && data.Context.length != 3) {
                                        /*if(romper = 1){
                                            items = '';
                                            romper = 0;
                                        }*/

                                        items = items + '<div class="col-md-4 col-sm-6 col-xs-12">\
                                                                    <div class="thumbnail" >\
                                                                        <img style="height:400px !important;" src="https://apps.fussionweb.com/sive/Products/1_SAP/' + value.SKU + '.jpg" alt="...">\
                                                                        <div class="caption">\
                                                                            <span class="" style="font-size:110% !Important"><strong>Modelo : </strong>' + value.SKU + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>Stock CEDIS : </strong>' + value.Stock_CEDIS + '</span> </br> \
                                                                            <span class="" style="font-size:110% !Important"><strong>Costo USD : </strong>' + costousd + '</span> </br> \
                                                                            <span class="" style="font-size:110% !Important"><strong>Tipo de precio : </strong>' + value.TipoPrecio + '</span> </br> \
                                                                            <span class="" style="font-size:110% !Important"><strong>Precio ultra c/iva : </strong>' + formatNumber.new(value.PrecioUltra.toFixed(2), '$ ') + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>Canal : </strong>' + value.Canal + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>StatusC : </strong>' + value.StatusC + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>Cliente : </strong>' + value.Cliente + '</span> </br>\
                                                                            <span class="" style="font-size:110% !Important"><strong>Marca : </strong>' + value.Marca + '</span> </br>\
                                                                        </div>\
                                                                        <div class="btn ' + status + ' btn-block" onclick="VerDetalle(\'' + value.SKU + '\')">\
                                                                            <span class="glyphicon glyphicon-zoom-in"></span> Ver\
                                                                        </div>\
                                                                        <div class="btn ' + status + ' btn-block" onclick="GuardarComentario(\'' + value.SKU + '\')">\
                                                                            <span class="glyphicon glyphicon-text-color"></span> Comentario\
                                                                        </div>\
                                                                    </div>\
                                                                </div>';
                                        TotalRegistros = TotalRegistros - 1;
                                        //alert(JSON.stringify(items));
                                        //alert("se pintan los ultimos registros: " + TotalRegistros);
                                    }
                                    if (TotalRegistros <= 0 && data.Context.length != 3) {
                                        //alert("Total debe ser igual a cero: "+TotalRegistros);
                                        $("#detalle-listado").append(inicio + items + fin);
                                    }


                                    i++;
                                });

                            } else {
                                $.alert("No se encontraron registros");
                            }
                        });
    }

    $("#BtnGuardarComentario").click(function () {
        if ($("#TextAreaComentarios").val() == "" ) {
            swal({
                title: 'Error',
                text: 'Es necesario agregar un comentario.',
                icon: 'error'
            });
            return;
        }

        $.post('@Url.Action("GuardarComentario", "Productos")', {
            Sku: SkuGlobal,
            Comentario: $("#TextAreaComentarios").val()
        }, function (data) {
            if(data != null){
                swal({
                    title: 'Ok',
                    text: 'El comentario se guardó correctamente.',
                    icon: 'success'
                });
                $("#TextAreaComentarios").val("");
                $('#Comentarios').modal('hide');
            } else{
                swal({
                    title: 'Error',
                    text: 'Error al intentar guardar el comentario.',
                    icon: 'error'
                });
                $("#TextAreaComentarios").val("");
                $('#Comentarios').modal('hide');
            }

        });
    });

    function GuardarComentario(sku) {
        $("#TituloComentarios").text("Comentarios para " + sku);
        SkuGlobal = sku;
        $("#TextAreaComentarios").val("");
        $('#Comentarios').modal('show');
    }
    function VerDetalle(sku) {
        $("#table-anexos").html('');
        $.post('@Url.Action("DetalleProductosChina", "Productos")', {
            Sku: sku
        },  function (data) {
               if (data != null ) {

                   console.log(data)
                   var costousd = 0;
                   var costomx = 0;
                   var codigoproveedor = "";
                   var nombreproveedor = "";

                   let fechaultimallegada = "";
                   if (data.Context.UltimaFechaLlegada != null)
                   {
                       fechaultimallegada = moment(data.Context.UltimaFechaLlegada).format('DD/MM/YYYY');
                   }

                   if (IsAdminOrDireccion) {
                       codigoproveedor = data.Context.Codigo;
                       nombreproveedor = data.Context.Proveedor;
                       costomx = formatNumber.new(data.Context.Costo_MXN, "");
                       costousd = formatNumber.new(data.Context.Costo_USD, "");
                       //console.log("Es Admin");
                   }
                   else {
                       costomx = formatNumber.new(costomx, "");
                       costousd = formatNumber.new(costousd, "");
                   }

                  $("#generales").html('');
                   $("#generales").html('<section class="invoice">\
                                            <div class="row">\
                                                <div class="col-xs-12">\
                                                   <h2 class="page-header">\
                                                       <i class="fa fa-globe"></i> Producto:'+ data.Context.SKU +'\
                                                   </h2>\
                                                </div>\
                                            </div>\
                                            <div class="row invoice-info">\
                                                <div class="col-sm-6 invoice-col">\
                                                    <b>General</b><br>\
                                                    <br>\
                                                    <b>SKU:</b> '+ data.Context.SKU +'<br>\
                                                    <b>Proveedor: </b> '+ codigoproveedor +'<br>\
                                                    <b>Proveedor: </b> '+ nombreproveedor +'<br>\
                                                    <b>Stock CEDIS: </b> '+ formatNumber.new(data.Context.Stock_CEDIS,'') +'<br />\
                                                    <b>Costo USD: </b> '+ costousd +'<br />\
                                                    <b>Costo MXN: </b> '+ costomx +'<br />\
                                                    <b>Empaque: </b> '+ data.Context.Empaque + '<br>\
                                                    <b>Master: </b> '+ data.Context.Master + '<br>\
                                                    <b>Inner: </b> '+ data.Context.Inner + '<br>\
                                                    <b>Accesorios: </b> '+ data.Context.Accesorios +'<br>\
                                                    <b>Marca: </b> ' + data.Context.Marca + '\
                                                </div>\
                                                <div class="col-sm-6 invoice-col">\
                                                    <b>Especificaciones</b><br>\
                                                    <br>\
                                                    <b>Descripción: </b> '+ data.Context.Articulo +'<br>\
                                                    <b>Familia: </b> '+ data.Context.Familia +'<br>\
                                                    <b>Categoria: </b> '+ data.Context.Categoria +'<br>\
                                                    <b>Clasificación: </b> ' + data.Context.Clasificacion + '<br>\
                                                    <b>Tipo: </b> '+ data.Context.Tipo + '<br>\
                                                    <b>IGI: </b> ' + data.Context.Igi + ' %<br>\
                                                    <b>NOM #: </b> ' + data.Context.Nom + '<br>\
                                                    <b>NOM Vigencia: </b> ' + data.Context.NomVigencia + '<br>\
                                                    <b>Ultima fecha llegada: </b> ' + fechaultimallegada + '<br>\
                                                    <b>Cantidad recibida por última vez: </b> ' + data.Context.CantidadRecibida + '<br\
                                                </div>\
                                            </div><br />\
                                            <div class="row">\
                                                <div class="col-md-4 col-xs-12">\
                                                    <div class="table-responsive">\
                                                        <table class="table table-bordered">\
															<thead><tr><th colspan="3" style="text-align: center;">FACTURA</th></tr><tr><th></th><th>S/IVA</th><th>C/IVA</th></tr></thead>\
                                                            <tbody id="preciofactura">\
                                                            </tbody>\
                                                        </table>\
                                                    </div>\
                                                </div>\
                                                <!--<div class="col-md-4 col-xs-12">\
                                                    <div class="table-responsive">\
                                                        <table class="table table-bordered">\
															<thead><tr><th colspan="3" style="text-align: center;">CARTA FACTURA</th></tr><tr><th></th><th>NETO</th></tr></thead>\
                                                            <tbody id="preciocartafactura">\
                                                            </tbody>\
                                                        </table>\
                                                    </div>\
                                                </div>-->\
                                                <div>\
                                                    <div class="col-md-4 col-xs-12">\
                                                        <div class="table-responsive">\
                                                            <table class="table table-bordered">\
																<thead><tr><th colspan="3" style="text-align: center;">SUCURSALES</th></tr><tr><th></th><th>S/IVA</th><th>C/IVA</th></th></thead>\
                                                                <tbody id="ListasPrecios">\
                                                                </tbody>\
                                                            </table>\
                                                        </div>\
                                                    </div>\
                                                    <div class="col-xs-12">\
                                                        <p class="lead">Ordenes de compra</p>\
                                                        <div class="table-responsive">\
                                                            <table class="table table-bordered">\
                                                                <thead><tr><th>Folio</th><th>Proveedor</th><th>Fecha</th><th>Cantidad</th><th>Precio</th></tr></thead>\
                                                                <tbody id="OrdenesCompra">\
                                                                </tbody>\
                                                            </table>\
                                                        </div>\
                                                    </div>\
                                                    <div class="col-xs-12">\
                                                        <p class="lead">Envios</p>\
                                                        <div class="table-responsive">\
                                                            <table class="table table-bordered">\
                                                                <thead><tr><th>Folio</th><th>Codigo</th><th>Proveedor</th><th>Fecha</th><th>Llega puerto</th><th>Llega cedis</th><th>Cantidad</th><th>Precio</th></tr></thead>\
                                                                <tbody id="Envios">\
                                                                </tbody>\
                                                            </table>\
                                                        </div>\
                                                    </div>\
													<div class="col-md-12"><p class="lead">Especificaciones</p><a data-fancybox="gallery" href="https://apps.fussionweb.com/productos/Especificaciones/'+ data.Context.SKU + '.jpg"><img style="width: 100%;"  src="https://apps.fussionweb.com/productos/Especificaciones/' + data.Context.SKU +'.jpg" alt="..."></a></div>\
                                                    <div class="col-xs-12">\
                                                        <p class="lead">Comentarios</p>\
                                                        <div class="table-responsive">\
                                                            <table class="table table-bordered">\
                                                                <thead><tr><th>Fecha</th><th>Usuario</th><th>Comentario</th></tr></thead>\
                                                                <tbody id="ComentariosSku">\
                                                                </tbody>\
                                                            </table>\
                                                        </div>\
                                                    </div>\
                                                    <div class="box-footer">\
                                                        <p class="lead">Anexos</p>\
                                                        <table class="table table-bordered table-striped">\
                                                            <thead>\
                                                                <tr>\
                                                                    <th class="col-md-5">Nombre</th>\
                                                                    <th class="col-md-7">Link</th>\
                                                                </tr>\
                                                            </thead>\
                                                            <tbody id="table-anexos">\
                                                            </tbody>\
                                                        </table>\
                                                    </div>\
                                                </div>\
                                            </div>\
                                        </section>');

               } else {
                  $.alert("No se encontraron registros");
                }
            }).done(function () {
                PreciosFacturaChina(sku);
                PreciosCartaFacturaChina(sku);
                ListasPreciosChina(sku);
                OrdenesCompra(sku);
                Envios(sku);
                Comentarios(sku);
                GetAnexos(sku);
                $('#DetallesSku').modal('show');
            });
    }
    function PreciosFacturaChina(sku) {
        $.post('@Url.Action("PreciosFacturaChina", "Productos")', {
            Sku: sku
        },
            function (data) {
                if (data != null && $.isArray(data.Context)) {

                    $("#preciofactura").html('');
                    $.each(data.Context, function (index, value) {
                        console.log(formatNumber.new((value.Precio * 1.16), '$'));
                        $("#preciofactura").append('<tr>\
                                                        <th>'+ value.Nombre +'</th>\
                                                        <td>'+ formatNumber.new(value.Precio.toFixed(2), '$') +'</td>\
                                                        <td>'+ formatNumber.new((value.Precio * 1.16).toFixed(2), '$') +'</td>\
                                                    </tr>');
                    });
                } else {
                    $.alert("No se encontraron registros");
                }
            });
    }
    function PreciosCartaFacturaChina(sku) {
        $.post('@Url.Action("PreciosCartaFacturaChina", "Productos")', {
            Sku: sku
        },
            function (data) {
                if (data != null && $.isArray(data.Context)) {

                    $("#preciocartafactura").html('');
                    $.each(data.Context, function (index, value) {
                        console.log(value);
                        $("#preciocartafactura").append('<tr>\
                                                        <th>'+ value.Nombre +'</th>\
                                                        <td>'+ formatNumber.new(value.Precio.toFixed(2), '$') +'</td>\
                                                    </tr>');
                    });
                } else {
                    $.alert("No se encontraron registros");
                }
            });
    }
    function ListasPreciosChina(sku) {
        $.post('@Url.Action("ListasPreciosChina", "Productos")', {
            Sku: sku
        },
            function (data) {
                if (data != null && $.isArray(data.Context)) {

                    $("#ListasPrecios").html('');
                    $.each(data.Context, function (index, value) {
                        console.log(value);
                        $("#ListasPrecios").append('<tr>\
                                                        <th>'+ value.Nombre +'</th>\
                                                        <td>'+ formatNumber.new(value.Precio.toFixed(2), '$') +'</td>\
                                                        <td>'+ formatNumber.new((value.Precio * 1.16).toFixed(2), '$') +'</td>\
                                                    </tr>');
                    });
                } else {
                    $.alert("No se encontraron registros");
                }
            });
    }
    function OrdenesCompra(sku) {
        $.post('@Url.Action("OrdenesCompra", "Productos")', {
            Sku: sku
        },
            function (data) {
                console.log(data);
                if (data != null && $.isArray(data.Context)) {
                    var nombreProveedor = "";
                    var precio = 0.0;

                    $("#OrdenesCompra").html('');
                    $.each(data.Context, function (index, value) {
                        console.log(value);

                        if (IsAdminOrDireccion) {
                            nombreProveedor = value.Proveedor
                            precio = formatNumber.new(value.Precio, 'USD ');
                        }
                        else {
                            precio = formatNumber.new(precio, 'USD ');
                        }

                        $("#OrdenesCompra").append('<tr>\
                                                        <th>'+ value.Folio + '</th>\
                                                        <td>'+ nombreProveedor +'</td>\
                                                        <td>'+ moment(value.Fecha).format('DD/MM/YYYY') + '</td>\
                                                        <td>'+ formatNumber.new(value.Cantidad, '') +'</td>\
                                                        <td>'+ precio  +'</td>\
                                                    </tr>');
                    });
                } else {
                    $.alert("No se encontraron registros");
                }
            });
    }
    function Comentarios(sku) {
        $.post('@Url.Action("Comentarios","Productos")', {
            Sku: sku
        },
        function (data) {
            console.log(data);
            if (data != null && $.isArray(data.Context)) {
                $("#ComentariosSku").html('');
                $.each(data.Context, function (index, value) {
                    console.log(value);
                    $("#ComentariosSku").append('<tr>\
                                                <td>'+ moment(value.Fecha).format('DD/MM/YYYY') + '</td>\
                                                <td>'+ value.Usuario + '</td>\
                                                <td>'+ value.Comentario + '</td>\
                                            </tr>');
                });


            } else {
                $.alert("No se encontraron comentarios para el sku "+sku);
            }
        });
    }
    function Envios(sku) {
        $.post('@Url.Action("Envios", "Productos")', {
            Sku: sku
        },
            function (data) {
                if (data != null && $.isArray(data.Context)) {
                    var nombreProveedor = "";
                    var codigoProveedor = "";
                    var precio = 0.0;
                    $("#Envios").html('');
                    $.each(data.Context, function (index, value) {
                        console.log(value);
                        if (IsAdminOrDireccion) {
                            nombreProveedor = value.Proveedor;
                            codigoProveedor = value.Codigo;
                            precio = formatNumber.new(value.Precio.toFixed(3), 'USD ')
                        }
                        else {
                            precio = formatNumber.new(precio, 'USD ');
                        }
                        $("#Envios").append('<tr>\
                                                        <th>'+ value.Folio + '</th>\
                                                        <td>'+ codigoProveedor +'</td>\
                                                        <td>'+ nombreProveedor +'</td>\
                                                        <td>'+ moment(value.Fecha).format('DD/MM/YYYY') + '</td>\
                                                        <td>'+ moment(value.LlegaPuerto).format('DD/MM/YYYY') + '</td>\
                                                        <td>'+ moment(value.LlegaCedis).format('DD/MM/YYYY') + '</td>\
                                                        <td>'+ formatNumber.new(value.Cantidad, '') +'</td>\
                                                        <td>' + precio + '</td>\
                                                    </tr>');
                    });
                } else {
                    $.alert("No se encontraron registros");
                }
            });
    }
    var formatNumber = {
        separador: ",", // separador para los miles
        sepDecimal: '.', // separador para los decimales
        formatear: function (num) {
            num += '';
            var splitStr = num.split('.');
            var splitLeft = splitStr[0];
            var splitRight = splitStr.length > 1 ? this.sepDecimal + splitStr[1] : '';
            var regx = /(\d+)(\d{3})/;
            while (regx.test(splitLeft)) {
                splitLeft = splitLeft.replace(regx, '$1' + this.separador + '$2');
            }
            return this.simbol + splitLeft + splitRight;
        },
        new: function (num, simbol) {
            this.simbol = simbol || '';
            return this.formatear(num);
        }
    }

	$("#btnPanelDescargaPDF").show();
	$("#ButtonsWait").hide();

var splitRegex = /\r\n|\r|\n/g;
jsPDF.API.textEx = function (text, x, y, hAlign, vAlign) {
    var fontSize = 5;// this.internal.getFontSize() / this.internal.scaleFactor;

    // As defined in jsPDF source code
    var lineHeightProportion = 1.15;

    var splittedText = null;
    var lineCount = 1;
    if (vAlign === 'middle' || vAlign === 'bottom' || hAlign === 'center' || hAlign === 'right') {
        splittedText = typeof text === 'string' ? text.split(splitRegex) : text;

        lineCount = splittedText.length || 1;
    }

    // Align the top
    y += fontSize * (2 - lineHeightProportion);

    if (vAlign === 'middle')
        y -= (lineCount / 2) * fontSize;
    else if (vAlign === 'bottom')
        y -= lineCount * fontSize;

    if (hAlign === 'center' || hAlign === 'right') {
        var alignSize = fontSize;
        if (hAlign === 'center')
            alignSize *= 0.5;

        if (lineCount > 1) {
            for (var iLine = 0; iLine < splittedText.length; iLine++) {
                this.text(splittedText[iLine], x - this.getStringUnitWidth(splittedText[iLine]) * alignSize, y);
                y += fontSize;
            }
            return this;
        }
        x -= this.getStringUnitWidth(text) * alignSize;
    }

    this.text(text, x, y);
    return this;
};

	$(".DonwloadPdf").click(function (e) {
		e.preventDefault();

        if (CurrentSearch === undefined)
        {
            swal({
                title: 'Error',
                text: 'Es necesario aplicar algún filtro de busqueda.',
                icon: 'error'
            });
            return;
        }

        var pdf = new jsPDF();
        var width = pdf.internal.pageSize.getWidth();
        var height = pdf.internal.pageSize.getHeight();

		pdf.setFontSize(10);

        var itemswidth = 3;
        var itemsheight = 3;
        var widthimg = (width / itemswidth) - 5;
        var heightimg = (height / itemsheight) - 5;
        var marginleft = 5;
        var margintop = 10;
        var page = 1;
        var auxwidth = 0;
        var auxheight = 0;
        var auxwidthbool = false;
        var auxheightbool = false;

		/*Datos autor*/
		pdf.setProperties({
			title: 'Sku china',
			subject: '',
			author: 'Luis Vega Villegas',
			keywords: '',
			creator: 'Luis Vega Villegas'
		});

		var sinImagen = 'data:image/jpeg;base64,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';

		//Encabezado
		var encabezado = "";

		encabezado += $("#cbxFamilia").val() == 'SELECCIONE' ? '' : 'Familia: ' + $("#cbxFamilia").val() + '  ';
		encabezado += $("#cbxCategoria").val() == 'SELECCIONE' ? '' : 'Categoria: ' + $("#cbxCategoria").val() + '  ';
		encabezado += $("#cbxClasificacion").val() == 'SELECCIONE' ? '' : 'Clasificación: ' + $("#cbxClasificacion").val() + '  ';
		encabezado += $("#cbxTipo").val() == 'SELECCIONE' ? '' : 'Tipo: ' + $("#cbxTipo").val() + '  ';
		encabezado += $("#Sku").val() == '' ? '' : 'Sku: ' + $("#Sku").val() + '  ';

		pdf.textEx(encabezado, 2, 2, 'middle', 'middle');
		pdf.setFontSize(9);
        $.each(CurrentSearch, function (index, value) {
			console.log("stock: "+JSON.stringify(value));
            var sku = value.SKU;
			var stock = value.Stock_CEDIS;
            Cargar(sku, function (response) {
                data = JSON.parse(response);
                var imgs = jQuery.parseJSON(data.result);
                //addImage(margen a la izquierda, margen hacia arriba, ancho, alto)
				var Tipo = "";
				var Theme = "plain";
				if (value.Activo == 1) {
					pdf.setTextColor(0, 161, 53); //Verde
					Tipo = "ACTIVO";
					Theme = "grid";
				} else if(value.Activo == 2){
					pdf.setTextColor(8, 97, 255); //Azul
					Tipo = "NUEVO";
					Theme = "striped";
				}
				else {
					pdf.setTextColor(255, 25, 48); //Rojo
					Tipo = "DESCONTINUADO";
					Theme = "plain";
				}


				var columns = [
							{title: sku, dataKey: "Content"},
							{title: Tipo, dataKey: "Body"}
						];

				  var rows = [
							{Content:"StockCedis: " + stock, Body:"TipoPrecio: " + value.TipoPrecio},
							{Content:"USD: " + value.Costo_USD, Body:"Ultra c/iva: " + value.PrecioUltra.toFixed(2)},
							{Content:"Canal: ", Body: value.Canal},
							{Content:"StatusC: " + value.StatusC, Body:"Cliente: " + value.Cliente},
						];

				pdf.autoTable(columns, rows, {
					theme: Theme, //striped(azul), grid(verde)
					styles: {font: 'arial', fontSize: 9, cellPadding: 0},
					tableWidth: widthimg - 5,
					margin: {left: (widthimg * auxwidth) + marginleft},
					startY: (heightimg * auxheight) + margintop - 3,
					headerStyles: {halign: "center"},
					columnStyles:{ Content:{halign: "center"}, Body:{halign: "center"}}
				});


				//pdf.textEx("Sku: " + sku + " || Ultra c/iva: " + value.PrecioUltra.toFixed(2), ((widthimg * auxwidth) + marginleft) -0 , ((heightimg * auxheight) + margintop) -4, 'middle', 'middle');
				//pdf.textEx("StockCedis: " + stock + " || USD: " + value.Costo_USD + " || TipoPrecio: " + value.TipoPrecio, ((widthimg * auxwidth) + marginleft) -0 , ((heightimg * auxheight) + margintop) -2, 'middle', 'middle');

				if(imgs.Imagen1 === ""){
					pdf.addImage(sinImagen, 'jpg', (widthimg * auxwidth) + marginleft, (heightimg * auxheight) + margintop + 15, widthimg-5, heightimg-19);
				}else{
					pdf.addImage(imgs.Imagen1, 'jpg', (widthimg * auxwidth) + marginleft, (heightimg * auxheight) + margintop + 15, widthimg-5, heightimg-19);
				}

                auxwidth++;

                if (auxwidth == itemswidth) {
                    auxwidthbool = true;
                    auxwidth = 0;
                    auxheight++;
                }
                if (auxheight == itemsheight) {
                    auxheightbool = true;
                    auxheight = 0;
                }

                if(auxheightbool && auxheightbool){
                    page++;
                    pdf.addPage();
                    pdf.setPage(page);
                    auxwidthbool = false;
                    auxheightbool = false;
                }
            });
        });

        pdf.save('Sku china');
    });

    Cargar = function (sku, callback) {
        var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
        xobj.open('GET', 'https://apps.fussionweb.com/FussionRestApi/Producto/GetImagenes?sku=' + sku, false);
        xobj.onreadystatechange = function () {
            if (xobj.readyState == 4 && xobj.status == "200") {
                callback(xobj.responseText);
            }
        };
        xobj.send(null);
    }

    function GetAnexos(sku) {
        $.post('@Url.Action("GETAnexos", "Productos")', {
            Sku: sku
        }, function (data) {
            console.log(data);
            if (data.Context != null && $.isArray(data.Context)) {

                $("#table-anexos").html('');
                $.each(data.Context, function (index, value) {

                    $("#table-anexos").append('<tr>\
                                                        <td>'+ value.Nombre + '</td>\
                                                        <td><a href="@Url.Content("~/Documentos/")'+ value.Archivo + '" target="_blank"> Descargar </a></td>\
                                                    </tr>');
                });

            }
        });

    }
</script>