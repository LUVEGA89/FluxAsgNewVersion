@{
    ViewBag.Title = "Comprobacion de viaticos";
}
<style>

    .green {
        color: green;
    }

    .red {
        color: red;
    }

    td {
        text-align: center;
        vertical-align: middle;
    }

    .modal-lg {
        width: 95% !important;
        height: 100% !important;
    }
</style>


<section class="content-header">
    <h1>
        Comprobación
        <small>Panel de control</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Comprobación</a></li>
        <li class="active">Viaticos</li>
    </ol>
</section>
<section class="content">

    <div class="row">
        <div class="col-md-12">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Solicitudes</h3>
                </div>
                <div class="box box-body with-border">
                    <div class="col-md-12 table-responsive">
                        <table id="tabla-solicitud" class="table table-hover">
                            <thead>
                                <tr>
                                    <td>Folio</td>
                                    <td>Folio SAP</td>
                                    <td>Cheque</td>
                                    <td>Registrado El</td>
                                    <td>Fecha requisición</td>
                                    <td>Sucursal</td>
                                    <td>Monto</td>
                                    <td>Estado</td>
                                    <td></td>
                                </tr>
                            </thead>
                            <tbody id="tbody-solicitudes"></tbody>
                        </table>
                    </div>

                </div>
                <div class="box box-footer">
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="modal-viaticos" aria-hidden="true" role="dialog">
        <div class="modal-dialog modal-lg">

            <div class="modal-content">

                <div class="modal-header">
                    <h4 class="modal-title">Detalle de viaticos</h4>                    
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="box-body">
                    <div class="col-md-12">

                        <div class="col-md-6 col-sm-6 invoice-col">
                            <address>
                                <span>Folio de solicitud: #<span id="viatico-Identifier"></span></span><br>
                                <span>Folio SAP: <span id="viatico-keySap"></span></span><br>
                                <span id="viatico-userid" class="hidden"></span>
                                <span>Solicitado por: <span id="viatico-user"></span></span><br>
                            </address>
                        </div>

                        <div class="col-md-6 col-sm-6 invoice-col">
                            <address>
                                <span>Sucursal: <span id="viatico-sucursal"></span></span><br />
                                <span>Cheque: <span id="viatico-cheque"></span></span>
                            </address>
                        </div>
                    </div>
                </div>

                <div class="modal-body">
                    <span id="load-modal" class="modal-title"></span>
                    <div class="col-md-12 col-xs-12 col-sm-12 table-responsive">
                        <table id="table-conceptos" class="table table-striped table-bordered col-md-12 col-xs-12 col-sm-12">
                            <thead>
                                <tr>
                                    <td class="th-stationery">Concepto</td>
                                    <td class="th-stationery">Solicitado</td>                                    
                                    <td class="th-stationery">Comprobado</td>
                                    <td class="th-stationery">Diferencia</td>
                                    <td class="th-stationery">Detalle</td>
                                </tr>
                            </thead>
                            <tbody id="tbody-viaticos"></tbody>
                            <tfoot></tfoot>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="form-group">
                        <button type="button" class="btn btn-success pull-right" style="margin-right: 20px;">Enviar Aprobacion Finanzas</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-facturas" aria-hidden="true" role="dialog">
        <div class="modal-dialog modal-lg">

            <div class="modal-content">

                <div class="modal-header">
                    <h4 class="modal-title">Detalle de conceptos</h4>
                    <span class="modal-title"></span>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="box-body">
                    <div class="col-md-12">

                        <div class="col-md-6 col-sm-6 invoice-col">
                            <address>
                                <span>Folio de Solicitud: #<span id="factura-Identifier"></span></span><br>
                                <span>Concepto: <span id="factura-concepto-detalle"></span></span><br>
                                <span>Folio SAP: <span id="factura-foliosap"></span></span><br>
                                <span id="factura-conceptoid" class="hidden"></span>
                                <span>Solicitado por: <span id="factura-username"></span></span><br>
                            </address>
                        </div>

                        <div class="col-md-6 col-sm-6 invoice-col">
                            <address>
                                <span>Sucursal: <span id="factura-sucursal"></span></span><br />
                                <span>Cheque: <span id="factura-cheque"></span></span><br>
                                <span>Monto solicitado: <span id="factura-monto-solicitado"></span></span><br>
                                <span class="hidden" id="factura-monto-solicitado-hidden"></span>
                                @*<span>Monto capturado por el usuario: <span id="factura-monto-capturado"></span></span><br>
                                <span id="factura-monto-capturado-hidden" class="hidden"></span>*@
                                @*OBJETOS HIDDEN PARA VALIDACION DE FACTURA Y MONTOS*@
                            </address>
                        </div>
                    </div>
                </div>

                <div class="box-body">
                    <div class="col-md-12">
                        <div class="col-md-8">

                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                
                                <button id="btn-adjuntar-pdf" type="button" class="btn btn-info pull-right" data-toggle="modal" data-target="#modalFactura">Adjuntar PDF</button>
                                <button id="btn-adjuntar-xml" type="button" class="btn btn-info pull-right" data-toggle="modal" data-target="#modalFactura">Adjuntar XML</button>
                                <button type="button" data-dismiss="modal" class="btn btn-default pull-right">Cancelar</button>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="modal-body">
                    <span id="load-modal" class="modal-title"></span>
                    <div class="col-md-12">
                        <table class="table table-responsive col-md-12 col-xs-12 col-sm-12">
                            <thead>
                                <tr>
                                    <td class="th-stationery">Folio</td>
                                    <td class="th-stationery">Uso CFDI</td>
                                    <td class="th-stationery">Concepto SAT</td>
                                    <td class="th-stationery">Fecha Emisión</td>
                                    <td class="th-stationery">Forma de pago</td>
                                    <td class="th-stationery">Monto</td>
                                    <td class="th-stationery">UUID</td>
                                    <td class="th-stationery">PDF</td>
                                    <td class="th-stationery">Remover</td>
                                </tr>
                            </thead>
                            <tbody id="tbody-facturas"></tbody>
                            <tfoot>
                                <tr>

                                    <td colspan="8">
                                        <span class="pull-right">Monto Solicitado: <span id="factura-fotter-monto-solicitado"></span></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="8">
                                        <span class="pull-right">Monto Comprobado: <span id="factura-fotter-monto-comprobado"></span></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="8">
                                        <span class="pull-right">Diferencia: <span id="factura-fotter-monto-diferiencia"></span></span>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-facturas-view" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Detalle de PDF selecionado</h4>
                    <span class="modal-title"></span>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body">
                    <div class="col-md-12">
                        <div class="box box-widget widget-user">
                            <div class="widget-user-image">
                            </div>
                            <div class="widget-user-header bg-blue">
                                <div class="row" id="carrousel-dinamic">

                                </div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>

                </div>

                <div class="modal-footer">

                </div>
            </div>
        </div>
    </div>

    <div id="modal-view-XML" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Seleccionar un XML para adjuntar un PDF</h4>
                    <span class="text-danger modal-title">* Solo puedes adjuntar un pdf por cada XML</span>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body">
                    <div class="col-md-12">


                    </div>

                </div>

                <div class="modal-footer">
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalFactura" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Subir Archivo XML o PDF</h4>
                </div>
                <div class="modal-body">
                    <div class="col-md-12">
                        <form method="post" id="frmFactura" name="frmFactura" enctype="multipart/form-data">
                            <input type="hidden" id="FileType" name="FileType" />
                            <input type="hidden" id="Viatico" name="Viatico" />                            
                            <input type="hidden" id="ViaticoConcepto" name="ViaticoConcepto" />
                            <input type="hidden" id="MontoSolicitado" name="MontoSolicitado" />
                            <input id="FilePDFXML" name="FilePDFXML[]" type="file" class="btn btn-default btn-block" accept="">
                            <small class="text-danger">*Importante: Adjuntar solo un archivo XML o PDF de acuerdo a la selección del botton. El primer archivo a cargar debe ser un XML.</small>
                            <ul id="archivos-list"></ul>
                        </form>

                        <div class="modal-footer">
                            <button id="btn-factura-adjunto-clear" type="button" class="btn btn-default">Limpiar</button>
                            <button id="btn-validarXML" type="button" class="btn btn-primary">Validar XML</button>
                            <button id="btn-validarPDF" type="button" class="btn btn-primary">Validar PDF</button>
                        </div>
                    </div>

                </div>
                <div class="modal-body box-danger" id="div-view-conceptos-xml">
                    <div class="col-md-12">
                        <div class="col-md-6 col-sm-6 invoice-col">
                            <address>
                                <span>UUID: <span id="factura-concepto-UUID"></span></span><br>
                                <span>Uso CFDI: <span id="factura-concepto-UsoCFDI"></span></span><br>
                                <span>Total del XML con IVA: <span id="factura-concepto-TotalIVA"></span></span><br>
                            </address>
                        </div>

                        <div class="col-md-6 col-sm-6 invoice-col">
                            <address>
                                <span>Fecha Timbrado: <span id="factura-concepto-fechatimbrado"></span></span><br>
                                <span>Forma Pago: <span id="factura-concepto-FormaPago"></span></span><br>
                            </address>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <table id="detalle-xml" class="table table-responsive table-striped">
                            <thead>
                                <tr>
                                    <td class="th-stationery">Descripción</td>
                                    <td class="th-stationery">ProductoServicioSAT</td>
                                    <td class="th-stationery" style="min-width:70px !important;">Importe</td>
                                    <td class="th-stationery">Cantidad</td>
                                    <td style="min-width:100px !important;" class="th-stationery">Total IVA</td>
                                    <td class="th-stationery">Estado</td>
                                    <td class="th-stationery">Seleccionar</td>
                                </tr>
                            </thead>
                            <tbody id="tbody-detalleXML"></tbody>

                            <tfoot>
                                <tr>
                                    <td colspan="5">
                                        <span class="pull-right">Total utilizado: <span id="factura-total-utilizado"></span></span>
                                    </td>
                                </tr>                                
                            </tfoot>
                        </table>

                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                    <button id="btn-continuarXML" type="button" class="btn btn-primary">Continuar</button>
                </div>
            </div>
        </div>
    </div>

</section>

<script>



    initModule();

    function initModule() {
        GetViaticos();

        clearDatos();
    }

    $(function () {
        $('#div-view-conceptos-xml').hide();

        arrayConceptosIndex = [];
        arrayConceptos = [];
        
    });


    function GetViaticos() {
        $.post('@Url.Action("GetViaticos", "Viaticos")',
            function (data) {

                if (data.Context != null && $.isArray(data.Context)) {

                    var table = $('#tabla-solicitud').DataTable();
                    table.destroy();
                    $("#tbody-solicitudes").html('');

                    $.each(data.Context, function (index, value) {
                        $("#tbody-solicitudes").append("<tr>\
                            <td>"+ value.Sequence + "</td>\
                            <td>"+ value.FolioSAP + "</td>\
                            <td>"+ value.Cheque + "</td>\
                            <td>"+ moment(value.RegistradoEl).format('DD/MM/YYYY') + "</td>\
                            <td>"+ moment(value.FechaRequisicion).format('DD/MM/YYYY') + "</td>\
                            <td>"+ value.Sucursal + "</td>\
                            <td>"+ formatNumber.new(value.Total, "$ ") + "</td>\
                            <td>"+ value.Estado + "</td>\
                            <td>\
                                <button onclick='LoadViaticos(" + value.Sequence + "," + value.FolioSAP + "," + value.Cheque + ",\"" + value.Sucursal + "\",\"" + value.Usuario.UserId + "\",\"" + value.Usuario.Email + "\")' data-toggle='modal' data-target='#modal-viaticos' class='btn btn-default'><i class='fa fa-eye'></i></button>\
                            </td>\
                        </tr>");
                    });
                   

                    $('#tabla-solicitud').DataTable({
                        "lengthMenu": [[10, 20, 30, -1], [10, 20, 30, "All"]],
                        dom: 'Bfrtip',
                        buttons: [
                            'excel'
                        ],                        
                        "scrollX": true,
                        "paging": true,
                        "lengthChange": true,
                        "searching": true,
                        "ordering": true,
                        "info": true,
                        "autoWidth": false,
                        "language": {
                            "url": "//cdn.datatables.net/plug-ins/1.10.13/i18n/Spanish.json"
                        }
                    });
                    
                }
                else {
                    if (data.Message != 'Success') {
                        alert("Ocurrio un error al procesar la solicitud, mensaje: "+ data.Message);
                    }
                }
            });
    }

    function clearDatos() {
        $('#viatico-Identifier').text('');
        $('#viatico-keySap').text('');
        $('#viatico-sucursal').text('');
        $('#viatico-sucursal').text('');
    }

    function LoadViaticos(Identifier, FolioSAP, Cheque, Sucursal,UserId,UserName) {

        $('#viatico-Identifier').text(Identifier);
        $('#viatico-keySap').text(FolioSAP);
        $('#viatico-cheque').text(Cheque);
        $('#viatico-sucursal').text(Sucursal);
        $('#viatico-userid').text(UserId);
        $('#viatico-user').text(UserName);


        $.post('@Url.Action("GetSolicitud", "Viaticos")', {
            Folio: Identifier
        }, function (data) {
            if (data.Context != null) {

                $('#tbody-viaticos').html('');
                $.each(data.Context, function (index, value) {

                    var color = 'color: red;';
                    if (value.Estado == 1) {
                        color = 'color: green;';
                    }

                    let Diferiencia = 0;
                    let StyleDiferiencia = '';
                    Diferiencia = value.Monto - value.MontoSubido;

                    if(Diferiencia > 0){
                        StyleDiferiencia = 'color: red;';
                    }
                    else{
                        StyleDiferiencia = 'color: green;';
                    }                    

                    //<td><input id="monto-capturado-' + index + '" type="text" name="monto-capturado-' + index + '" onkeypress="return filterFloat(event,this);" placeholder="0.00" ></td>\
                    let ConceptoDetalle = '' + value.SequenceItem + ' - ' + value.Producto + ' - (' + value.CentroCosto + ') : ' + formatNumber.new(value.Monto.toFixed(2), "$ ") + '';
                    $("#tbody-viaticos").append('<tr>\
                        <td><span id="labelItem-' + value.SequenceItem + '" class="text" style="' + color + '" >' + value.SequenceItem + ' - ' + value.Producto + ' - (' + value.CentroCosto + ') : ' + formatNumber.new(value.Monto.toFixed(2), "$ ") + '</span></td>\
                        <td>' + formatNumber.new(value.Monto.toFixed(2), "$ ") + '</span></td>\
                        <td>' + formatNumber.new(value.MontoSubido.toFixed(2), "$ ") + '</span></td>\
                        <td><span style="' + StyleDiferiencia + '">' + formatNumber.new(Diferiencia.toFixed(2), "$ ") + '</span></td>\
                        <td>\
                            <button onclick="LoadFacturas(' + value.SequenceItem + ',' + value.Sequence + ',' + value.FolioSAP + ',' + value.Cheque + ',\'' + value.Sucursal + '\',\'' + value.Usuario.UserId + '\',\'' + value.Usuario.Email + '\',\'' + ConceptoDetalle + '\',' + value.Monto + ','+index+')" data-toggle="modal" data-target="#modal-facturas" class="btn btn-default"><i class="fa fa-eye"></i></button>\
                        </td>\
                    </tr>');
                });
            }
            else {
                if (data.Message != 'Success') {
                    alert('Ocurrio un error inesperado, mensaje:' + data.Message);
                }
            }
        });
    };

    $('#xml-selected').click(function (e) {
        e.preventDefault();


    });


    @*CARGAR FACTURAS *@
    function LoadFacturas(SequenceItem, Identifier, FolioSAP, Cheque, Sucursal, UserId, UserName, Concepto, MontoSolicitado, indexPosition) {

        $('#factura-Identifier').text(Identifier);
        $('#factura-conceptoid').text(SequenceItem);
        $('#factura-foliosap').text(FolioSAP);
        $('#factura-sucursal').text(Sucursal);
        $('#factura-cheque').text(Cheque);

        $('#factura-username').text(UserName);
        $('#factura-monto-solicitado-hidden').text(MontoSolicitado);
        $('#factura-monto-solicitado').text(formatNumber.new(MontoSolicitado.toFixed(2), "$ "));

        $('#factura-concepto-detalle').text(Concepto);


        $('#factura-fotter-monto-solicitado').text(formatNumber.new(MontoSolicitado.toFixed(2), "$ "));

        //let MontoCapturadoUser = $('#monto-capturado-' + indexPosition + '').val();


        //if (MontoCapturadoUser == '' || MontoCapturadoUser == 0.00) {
        //    MontoCapturadoUser = 0.0;
        //    $('#factura-monto-capturado').removeClass('text-success');
        //    $('#factura-monto-capturado').addClass('text-danger');
        //}
        //else {
        //    parseFloat(MontoCapturadoUser);
        //    $('#factura-monto-capturado').removeClass('text-danger');
        //    $('#factura-monto-capturado').addClass('text-success');
        //}

        //// monto capturado por el usuario
        //$('#factura-monto-capturado').text(formatNumber.new(parseFloat(MontoCapturadoUser).toFixed(2), "$ "));
        //$('#factura-monto-capturado-hidden').val(MontoCapturadoUser);

        $('#Viatico').val(Identifier);
        //$('#ViaticoDetalle').val(V);
        $('#ViaticoConcepto').val(SequenceItem);
        @*MODAL DE CARGA DE XML Y PDF*@
        $('#MontoSolicitado').val(MontoSolicitado);


        $.post('@Url.Action("GetFacturas", "Viaticos")', {
            Folio: SequenceItem
        }, function (data) {
            if (data != null) {

                if (data.Context.length > 0) {

                    let TotalComprobado = 0, TotalSolicitado = 0, TotalDiferiencia=0;
                    $('#tbody-facturas').html('');

                    $.each(data.Context, function (index, value) {

                        TotalComprobado = TotalComprobado + value.Monto;

                        let FilePDF = "";

                        if (value.FileExistPDF) {
                            FilePDF = '<button onClick="viewFacturas(' + SequenceItem + ')" data-toggle="modal" data-target="#modal-facturas-view"  class="btn btn-default"><i class="fa fa-file-pdf-o" aria-hidden="true"></i></i></button>';
                        }
                        else {
                            FilePDF = '<button disabled class="btn btn-default"><i class="fa fa-file-pdf-o" aria-hidden="true"></i></i></button>';
                        }

                        let ProductoServicioSAT = '';
                        if (value.ProductoServicioSAT === null) {
                            ProductoServicioSAT = 'No definido';
                        }
                        else {
                            ProductoServicioSAT = '' + value.ProductoServicioSAT.Codigo + ' - ' + value.ProductoServicioSAT.Descripcion + '';
                        }

                        @*//@System.Configuration.ConfigurationManager.AppSettings[""].ToString();*@

                        let MontoIva = value.Monto + (value.Monto * 0.16);
                        parseFloat(MontoIva);
                        $('#tbody-facturas').append('<tr>\
                            <td>' + value.Sequence + '</td>\
                            <td>' + value.UsoCFDISAT.Codigo + '-' + value.UsoCFDISAT.Descripcion + '</td>\
                            <td>' + ProductoServicioSAT + '</td>\
                            <td>' + moment(value.FechaTimbrado).format('DD/MM/YYYY') + '</td>\
                            <td>' + value.FormaPagoSAT.Codigo + '-' + value.FormaPagoSAT.Descripcion + '</td>\
                            <td>' + formatNumber.new(MontoIva.toFixed(2), "$ ") + '</td>\
                            <td>\
                                <a target="_blank" href="https://apps.fussionweb.com/sie/PDF/'+ value.UUID + '.xml">' + value.UUID + '</a>\
                            </td>\
                            <td>'+FilePDF+'</td>\
                            <td>\
                                <a onclick="DelFactura(' + value.Sequence + ')" class="btn btn-default"><i class="fa fa-remove"></i></a>\
                            </td>\
                        </tr>');
                    });

                    parseFloat(TotalComprobado);
                    $('#factura-fotter-monto-comprobado').text(formatNumber.new(TotalComprobado.toFixed(2), "$ "));

                    if (MontoSolicitado != 0) {
                        TotalDiferiencia = MontoSolicitado - TotalComprobado;
                    }

                    $('#factura-fotter-monto-diferiencia').text(formatNumber.new(TotalDiferiencia.toFixed(2), "$ "));
                }
                else {
                    $('#tbody-facturas').html('<tr><td colspan="7"><h4 class="text-danger">Por el momento no se cargado facturas para comprobar los viaticos.  </h4></td></tr>');
                }
            }
            else {
                if (data.Message != 'Success') {
                    alert('Ocurrio un error inesperado, mensaje:' + data.Message);
                }
            }
        });
    }

    function viewFacturas(Identifier) {


        $.post('@Url.Action("GetViaticoDetalleFacturas", "Viaticos")',
        {
            ViaticoDetalle: Identifier
        }, function (data) {
            if (data.Context != null) {

                $("#carrousel-dinamic").html('');
                var aux = 0;
                var cabeceras = '';
                var detalles = '';
                //llenamos las cabeceras y los detalles..
                if (data.Context.length <= 0) {
                    cabeceras = cabeceras + '<li data-target="#carousel-generic1" data-slide-to="0" class="active"></li>';
                    detalles = detalles + '<div class="item active"><img src="../dist/img/employee.jpg" /></div>';
                    aux++;
                }
                else {

                    $.each(data.Context, function (index, value) {
                        let tipo = value.Tipo;

                        let URL = '';
                        @{
                            string UrlViaticos = @System.Configuration.ConfigurationManager.AppSettings["Url.Viaticos.Files"];
                            string UrlViaticosNoInternet = @System.Configuration.ConfigurationManager.AppSettings["Url.Viaticos.Files.NotInternet"];
                        }
                        URL = '@UrlViaticosNoInternet';
                        URL_FORMATTED = URL + value.FileName;
                        URL_FORMATTED = URL_FORMATTED.replace(/\\/g, '/');

                        if (aux == 0) {
                            cabeceras = cabeceras + '<li data-target="#carousel-generic1" data-slide-to="' + index + '" class="active"></li>';
                        } else {
                            cabeceras = cabeceras + '<li data-target="#carousel-generic1" data-slide-to="' + index + '"></li>';
                        }
                        if (aux == 0) {
                            detalles = detalles + '<div class="item active"><iframe align="center" style="width:100%; height:600px; max-height:800px;" src="' + URL_FORMATTED + '" /> <div class="carousel-caption"><p></p></div> </div > ';
                        } else {
                            detalles = detalles + '<div class="item"><iframe align="center" style="width:100%; height:600px; max-height:800px;" src="' + URL_FORMATTED + '" /> <div class="carousel-caption"><p></p></div> </div > ';
                        }
                        aux++;
                    });
                    //se dibuja el carrusel
                    $("#carrousel-dinamic").append(
                        "<div class='col-md-12' >" +
                            "<div id='carousel-generic1' class='carousel slide' data-ride='carousel' style='width:80%;margin-left:10%;'>" +
                            "<ol id='contenedor-carousel-cabecera' class='carousel-indicators'>" +
                            cabeceras +
                        "<\/ol>" +
                        "<div id='carousel-detalles' class='carousel-inner' role='listbox'>" +
                        detalles +
                        "<\/div>" +
                            "<a class='left carousel-control' href='#carousel-generic1' role='button' data-slide='prev'>" +
                            "<span class='glyphicon glyphicon-chevron-left' aria-hidden='true'><\/span>" +
                            "<span class='sr-only'>Previous<\/span>" +
                        "<\/a>" +
                        "<a class='right carousel-control' style='margin-right:20px !important; width: 55px !important;' href='#carousel-generic1' role='button' data-slide='next'>" +
                        "<span class='glyphicon glyphicon-chevron-right' aria-hidden='true'><\/span>" +
                        "<span class='sr-only'>Next<\/span>" +
                        "<\/a>" +
                        "<\/div>" +
                        "<\/div>");
                }
            }
        }).done(function (data) {            
        }).fail(function (data) {            
        }).always(function (data) {           
        });
    }



    function LoadFacturaDetail(Identifier, TotalComprobado) {@*VIATICO DETALLE *@

        $.post('@Url.Action("GetFacturas", "Viaticos")', {
            Folio: Identifier
        }, function (data) {
            if (data != null) {

                if (data.Context.length > 0) {

                    let TotalComprobado = 0, TotalSolicitado = 0, TotalDiferiencia = 0;
                    $('#tbody-facturas').html('');

                    $.each(data.Context, function (index, value) {

                        value.Monto = value.Monto + (value.Monto * 0.16);

                        TotalComprobado = TotalComprobado + value.Monto;

                        let FilePDF = "";

                        if (value.FileExistPDF) {
                            FilePDF = '<button onClick="viewFacturas(' + Identifier + ')" data-toggle="modal" data-target="#modal-facturas-view"  class="btn btn-default"><i class="fa fa-file-pdf-o" aria-hidden="true"></i></i></button>';
                        }
                        else {
                            FilePDF = '<button disabled class="btn btn-default"><i class="fa fa-file-pdf-o" aria-hidden="true"></i></i></button>';
                        }

                        let ProductoServicioSAT = '';
                        if (value.ProductoServicioSAT === null) {
                            ProductoServicioSAT = 'No definido';
                        }
                        else {
                            ProductoServicioSAT = '' + value.ProductoServicioSAT.Codigo + ' - ' + value.ProductoServicioSAT.Descripcion + '';
                        }

                        @*//@System.Configuration.ConfigurationManager.AppSettings[""].ToString();*@

                        $('#tbody-facturas').append('<tr>\
                            <td># ' + value.Sequence + '</td>\
                            <td>' + formatNumber.new(value.Monto.toFixed(2), "$ ") + '</td>\
                            <td>' + value.UsoCFDISAT.Codigo + '-' + value.UsoCFDISAT.Descripcion + '</td>\
                            <td>' + ProductoServicioSAT + '</td>\
                            <td>' + moment(value.FechaTimbrado).format('DD/MM/YYYY') + '</td>\
                            <td>' + value.FormaPagoSAT.Codigo + '-' + value.FormaPagoSAT.Descripcion + '</td>\
                            <td>\
                                <a target="_blank" href="https://apps.fussionweb.com/sie/Timbrado/'+ value.UUID + '.xml">' + value.UUID + '</a>\
                            </td>\
                            <td>'+ FilePDF + '</td>\
                            <td>\
                                <a onclick="DelFactura(' + value.Sequence + ')" class="btn btn-default"><i class="fa fa-remove"></i></a>\
                            </td>\
                        </tr>');
                    });

                    parseFloat(TotalComprobado);
                    $('#factura-fotter-monto-comprobado').text(formatNumber.new(TotalComprobado.toFixed(2), "$ "));

                    if (MontoSolicitado != 0) {
                        TotalDiferiencia = MontoSolicitado - TotalComprobado;
                    }

                    $('#factura-fotter-monto-diferiencia').text(formatNumber.new(TotalDiferiencia.toFixed(2), "$ "));
                }
                else {
                    $('#tbody-facturas').html('<tr><td colspan="7"><h4 class="text-danger">Por el momento no se cargado facturas para comprobar los viaticos.  </h4></td></tr>');
                }
            }
            else {
                if (data.Message != 'Success') {
                    alert('Ocurrio un error inesperado, mensaje:' + data.Message);
                }
            }
        });
    }

</script>

<script>
    function IsValidButton(value) {

        switch (value) {
            case 'PDF':
                $('#btn-validarXML').attr("disabled", false);
                break;
            case 'XML':
                $('#btn-validarPDF').attr("disabled", false);
                break;
        }
    }

    $('#btn-adjuntar-xml').click(function (e) {
        e.preventDefault();
        clearArchivosAdjuntos();


        $('#FileType').val('XML');
        $('#FilePDFXML').removeAttr("accept")
        $('#FilePDFXML').attr('accept', 'text/xml');

        @*INHABILITAR EL BOTON DE PDF *@
        $('#btn-validarXML').attr('disabled', false);
        $('#btn-validarPDF').attr('disabled', true);

        $('#btn-continuarXML').attr('disabled', true);
    });

    $('#btn-adjuntar-pdf').click(function (e) {
        e.preventDefault();
        clearArchivosAdjuntos();
        $('#FileType').val('PDF');
        $('#FilePDFXML').removeAttr("accept");
        $('#FilePDFXML').attr('accept', 'application/pdf');

        @*OCULTAR EL DIV DEL DEGLOSE DE CONCEPTOS DE XML*@
        $('#div-view-conceptos-xml').hide();

        @*INHABILITAR EL BOTON DEL XML*@
        @*INHABILITAR EL BOTON DE PDF *@
        $('#btn-validarXML').attr('disabled', true);
        $('#btn-validarPDF').attr('disabled', false);
    });

    $('#btn-validarPDF').click(function (e) {
        e.preventDefault();

        let length = $('#FilePDFXML').length;

        if (length > 0) {
            $('#btn-continuarXML').attr('disabled', false);
        }
        else {
            $('#btn-continuarXML').attr('disabled', true);
        }

    });



    $('#btn-validarXML').click(function (e) {
        e.preventDefault();

        $('#btn-continuarXML').prop("disabled", true);@*DESABILITAR EL BOTON DE CONTINUAR*@

        var formData = new FormData($("#frmFactura")[0]);
        var ruta = "@Url.Action("GetXMLDesgloseConceptos", "Viaticos")";
        $.ajax({
            url: ruta,
            type: "POST",
            data: formData,
            contentType: false,
            processData: false,
            success: function (data) {

                if (data.Context != null) {
                    $('#div-view-conceptos-xml').show();

                    $('#factura-concepto-UUID').text(data.Context.UUID);
                    $('#factura-concepto-fechatimbrado').text(moment(data.Context.FechaTimbrado).format('YYYY-MM-DDTHH:MM:SS'));
                    $('#factura-concepto-UsoCFDI').text(data.Context.UsoCFDI);
                    $('#factura-concepto-TotalIVA').text(formatNumber.new(data.Context.Monto.toFixed(2), "$ "));
                    $('#factura-concepto-FormaPago').text(data.Context.FormaPago);

                    $('#tbody-detalleXML').html('');

                    @*<td>' + moment(value.FechaTimbrado).format('DD/MM/YYYY') + '</td>\@*@

                    let TotalIVA = 0;
                    let TotalUtilizado = 0;

                    $.each(data.Context.Conceptos, function (index, value) {
                        
                        let TrStyle = ''; let tdChecked = ''; let LeyendaSAT = '';
                        if (value.IsOcupado) {
                            TrStyle = 'class=red';
                            tdChecked = 'disabled';

                            if (value.IsActivoSAT) {
                                LeyendaSAT = '<spam class="text-danger">Ocupado y permitido</spam>';
                            }
                            else{
                                LeyendaSAT = '<spam class="text-danger">Ocupado no permitido</spam>';
                            }
                        }
                        else {                         
                            if (value.IsActivoSAT) {
                                LeyendaSAT = '<spam class="text-success">Disponible permitido</spam>';
                            }
                            else {
                                tdChecked = 'disabled';
                                LeyendaSAT = '<spam class="text-danger">Disponible pendiente por configurar, CodigoSAT: ' + value.ClaveProdServ + '</spam>';
                            }
                        }                                                

                        TotalIVA = value.Importe + value.ConceptoTraslado.Importe;

                        TotalUtilizado = TotalUtilizado + TotalIVA;

                        $('#tbody-detalleXML').append('<tr ' + TrStyle + ' id="' + index + '">\
                            <td>' + value.Descripcion + '</td>\
                            <td>' + value.ClaveProdServ + '</td>\
                            <td>' + formatNumber.new(value.Importe.toFixed(2), "$ ") + '</td>\
                            <td>' + value.Cantidad + '</td>\
                            <td>' + formatNumber.new(TotalIVA.toFixed(2), "$ ") + '</td>\
                            <td>' + LeyendaSAT + '</td>\
                            <td><input '+tdChecked+' id="checkSelect-' + index + '" type="checkbox" name="checkSelect-' + index + '" value="checkSelect-' + index + '" onClick=addRow(' + index + ') ></td>\
                        </tr>');
                    });
                    parseFloat(TotalUtilizado);
                    $('#factura-total-utilizado').text(formatNumber.new(TotalUtilizado.toFixed(2), "$ "));
                }
                else{
                    if (data.Message != 'Success') {
                        $('.modal-backdrop').hide();
                        swal('Error', data.Message, 'error');
                        $('#modalFactura').hide();
                    }
                }
            }
        });

    });


    function addRow(index) {

        if ($('#checkSelect-' + index + '').prop('checked')) {
            AddRowItem(index);
            console.log(JSON.stringify(arrayConceptosIndex));
        } else {
            RemoveItemCreditNote(index);
        }
        if (arrayConceptosIndex.length == 0) {
            $('#btn-continuarXML').prop("disabled", true);@*INACTIVO*@
        }
        else {
            $('#btn-continuarXML').prop("disabled", false);@*ACTIVO*@
        }
    }


    function clearArchivosAdjuntos() {
        $('#tbody-detalleXML').html('');

        $('#factura-concepto-UUID').text('');
        $('#factura-concepto-UsoCFDI').text('');
        $('#factura-concepto-TotalIVA').text('');
        $('#factura-concepto-fechatimbrado').text('');
        $('#factura-concepto-FormaPago').text('');

        $('#div-view-conceptos-xml').hide();

        $('#FilePDFXML').val('');
        $('#archivos-list').html('');

        $('#btn-continuarXML').attr('disabled', true);

        arrayConceptosIndex = [];
        arrayConceptos = [];
    }
    $('#btn-factura-adjunto-clear').click(function (e) {
        e.preventDefault();
        clearArchivosAdjuntos();
    })

    $('#btn-continuarXML').click(function (e) {
        e.preventDefault();

        let FileType = $('#FileType').val();
        if (FileType == '') {
            swal('Tipo de documento', 'Se debe agregar un documento para guardar, actualmente no definido por el usuario', 'warning');
            return;
        }

        let ViaticoConcepto = $('#ViaticoConcepto').val();
        if (ViaticoConcepto == '') {
            swal('Alerta', 'Debe de definir el concepto del viatico actual.', 'warning');
            return;
        }

        let MontoSolicitado = $('#MontoSolicitado').val();
        if (MontoSolicitado == '') {
            swal('Alerta', 'Debe de el monto solicitado del concepto del viatico', 'warning');
            return;
        }

        switch (FileType) {
            case "XML":
                if (arrayConceptosIndex.length == 0) {
                    swal('Conceptos', 'Debe de seleccionar un concepto para continuar ', 'warning');
                    return;
                }
                if (FileType == 'PDF') {
                    swal('Alerta', 'El documento seleccionado no es documento XML, intente de nuevo.', 'warning');
                    return;
                }

                let DateTime = Date.parse($('#factura-concepto-fechatimbrado').text());

                let Total = $('#factura-concepto-TotalIVA').text();
                Total = Total.replace('$', '');

                $.each(arrayConceptosIndex, function (key, value) { @*RECORRER LOS TR SELECCIONADO*@
                    var objConcepto = new Object();

                    $('#'+value+' td').each(function (index) { @* TD GET VALUES *@
                        let value = $(this).text();
                        if (value != '') {
                            if (index == 0) {@*DESCRIPCION*@
                                objConcepto.Descripcion = value;
                            }
                            if (index == 1) {@*CLAVE PRODCUTOSERVICIO SAT*@
                                objConcepto.ClaveProdServ = parseInt(value);
                            }
                            if (index == 2) {@* IMPORTE*@
                                value = value.replace('$', '');
                                objConcepto.Importe = parseFloat(value).toFixed(2);
                            }
                            if (index == 3) {@* Cantidad*@
                                objConcepto.Cantidad = parseFloat(value).toFixed(2);
                            }
                        }
                    });
                    AddRowConcepto(objConcepto);
                });

                if(arrayConceptos.length ==0){
                    swal('Colección conceptos', 'La coleccion de conceptos esta vacia. intente de nuevo.', 'warning');
                    return;
                }

                @*DESEALZAR EL XML*@
                var formData = new FormData($('#frmFactura')[0]);
                formData.append('arrayConceptos', JSON.stringify(arrayConceptos));
                var ruta = "@Url.Action("AddViaticoDetalleFacturaConcepto", "Viaticos")";
                $.ajax({
                    url: ruta,
                    type: "POST",
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        if (data.Context != null) {
                            if (data.Context) {
                                swal('Conceptos', 'La coleccion de conceptos se guardo correctamente', 'success');
                                clearArchivosAdjuntos();
                                $('.modal').modal('hide'); // closes all active pop ups
                            }
                            else {
                                swal('Alerta', 'Ocurrio un error al guardar la colección de conceptos', 'error');
                            }
                        }
                        else {
                            if (data.Message != 'Success') {
                                swal('Error', 'Error generado: ' + data.Message, 'Error');
                                $('.modal').modal('hide');
                            }
                        }
                    }
                });

                break;
            case 'PDF':
                var formData = new FormData($('#frmFactura')[0]);                
                var ruta = "@Url.Action("AddViaticoDetalleFacturaConcepto", "Viaticos")";
                $.ajax({
                    url: ruta,
                    type: "POST",
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        if (data.Context != null) {
                            if (data.Context) {
                                swal('PDF', 'Se ha guardado correctamente el documento PDF', 'success');
                                clearArchivosAdjuntos();
                                $('.modal').modal('hide') // closes all active pop ups
                            }
                            else {
                                swal('Alerta', 'Ocurrio un error al guardar el documento PDF', 'error');
                            }
                        }
                        else {
                            if (data.Message != 'Success') {
                                swal('Documento PDF no guardado', 'Mensaje generado: '+ data.Message, 'error');                                
                            }
                        }
                    }
                });
                break;
            default:
                swal('Documento', 'Documento no definido intente de nuevo.', 'warning');               
                return;
        }

        //swal({
        //    title: "¿Agregar los conceptos?",
        //    text: "Se agragara los conceptos del XML al desglose de conceptos",
        //    icon: "warning",
        //    buttons: [
        //      'No, cancelar esta operación',
        //      'Si, estoy seguro'
        //    ],
        //    dangerMode: true,
        //}).then(function (isConfirm) {
        //    if (isConfirm) {
        //        swal({
        //            title: 'Operación confirmada',
        //            text: 'Los datos se mandaron correctamente',
        //            icon: 'success'
        //        }).then(function () {


        //        });
        //    } else {
        //        swal("Cancelado", "La operación ha sido cancelada", "error");
        //    }
        //});

    });



    var arrayConceptosIndex = [];
    function AddRowItem(index) {
        arrayConceptosIndex.splice(0, 0, index);
    }

    function RemoveItemCreditNote(indexRow) {
        console.log('Array before removing the element = ' + JSON.stringify(arrayConceptosIndex));
        arrayConceptosIndex = jQuery.grep(arrayConceptosIndex, function (value, index) {
            return (value != indexRow);
        }, false);
        console.log('Array after removing the element = ' + JSON.stringify(arrayConceptosIndex));
    }

    arrayConceptos = [];

    function AddRowConcepto(item) {
        arrayConceptos.splice(0, 0, item);
        console.log('Items ' + JSON.stringify(arrayConceptos));
    }

</script>

<script>
    $('#filesToUpload').change(function (e) {
        e.preventDefault();

        var $fileUpload = $("input[type='file']");
        if (parseInt($fileUpload.get(0).files.length) > 2) {
            //You can only upload a maximum of 2 files
            alert("Ha superado el número maximo permitido de 2 archivos");
            $('#filesToUpload').val('');
            $('#fileList').html('');
            return false;
        }

        var input = document.getElementById("filesToUpload");
        var ul = document.getElementById("fileList");
        while (ul.hasChildNodes()) {
            ul.removeChild(ul.firstChild);
        }
        for (var i = 0; i < input.files.length; i++) {
            var li = document.createElement("li");
            li.innerHTML = input.files[i].name;
            ul.appendChild(li);
        }
        if (!ul.hasChildNodes()) {
            var li = document.createElement("li");
            li.innerHTML = 'No Files Selected';
            ul.appendChild(li);
        }

    });

    $('#FilePDFXML').change(function (e) {
        e.preventDefault();

        var $fileUpload = $("input[type='file']");
        if (parseInt($fileUpload.get(0).files.length) > 2) {
            //You can only upload a maximum of 2 files
            alert("Ha superado el número maximo permitido de 2 archivos");
            $('#FilePDFXML').val('');
            $('#archivos-list').html('');
            return false;
        }

        var input = document.getElementById("FilePDFXML");
        var ul = document.getElementById("archivos-list");
        while (ul.hasChildNodes()) {
            ul.removeChild(ul.firstChild);
        }
        for (var i = 0; i < input.files.length; i++) {
            var li = document.createElement("li");
            li.innerHTML = input.files[i].name;
            ul.appendChild(li);
        }
        if (!ul.hasChildNodes()) {
            var li = document.createElement("li");
            li.innerHTML = 'Ningun archivo seleccionado.';
            ul.appendChild(li);
        }

    });


    var modal_counter = 0;
    $(document).ready(function () {
        $('.modal').on('shown.bs.modal', function () {
            modal_counter++;
        });
        $('.modal').on('hidden.bs.modal', function () {
            modal_counter--;
            if (modal_counter) {
                $('body').addClass('modal-open');
            }
            else {
                $('body').removeClass('modal-open');
            }
        });
    })

    var formatNumber = {
        separador: ",",
        sepDecimal: '.',
        formatear: function (num) {
            num += '';
            var splitStr = num.split('.');
            var splitLeft = splitStr[0];
            var splitRight = splitStr.length > 1 ? this.sepDecimal + splitStr[1] : '';
            var regx = /(\d+)(\d{3})/;
            while (regx.test(splitLeft)) {
                splitLeft = splitLeft.replace(regx, '$1' + this.separador + '$2');
            }
            return this.simbol + splitLeft + splitRight;
        },
        new: function (num, simbol) {
            this.simbol = simbol || '';
            return this.formatear(num);
        }
    };

    @*VALUDAR NUMEROS Y UN DECIMAL*@

    function filterFloat(evt, input) {
        // Backspace = 8, Enter = 13, ‘0′ = 48, ‘9′ = 57, ‘.’ = 46, ‘-’ = 43
        var key = window.Event ? evt.which : evt.keyCode;
        var chark = String.fromCharCode(key);
        var tempValue = input.value + chark;
        if (key >= 48 && key <= 57) {
            if (filter(tempValue) === false) {
                return false;
            } else {
                return true;
            }
        } else {
            if (key == 8 || key == 13 || key == 0) {
                return true;
            } else if (key == 46) {
                if (filter(tempValue) === false) {
                    return false;
                } else {
                    return true;
                }
            } else {
                return false;
            }
        }
    }
    function filter(__val__) {
        var preg = /^([0-9]+\.?[0-9]{0,2})$/;
        if (preg.test(__val__) === true) {
            return true;
        } else {
            return false;
        }

    }

</script>