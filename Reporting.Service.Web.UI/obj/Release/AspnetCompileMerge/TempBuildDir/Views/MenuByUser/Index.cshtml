

@model Reporting.Service.Web.UI.Models.MenuByUser
@{
    int primerNivel = 1;
    int subNivel = 1;
}
@{
    ViewBag.Title = "Index";
}

<style>
    #ListaModulos a {
        text-align: left;
    }

    #pnlVistas .panel-body {
        max-height: 300px;
        overflow-y: scroll;
    }

    #pnlCRUDVistas .panel-body {
        max-height: 300px;
        overflow-y: scroll;
    }

    #ModalModulos .modal-header {
        border-bottom: solid 2px orangered;
    }

    #ModalModulos .modal-footer {
        border-top: solid 2px orangered;
    }
    /*carga de imagenes, loader de espera*/
    .loader {
        position: fixed;
        left: 0px;
        top: 0px;
        width: 100%;
        height: 100%;
        z-index: 9999;
        opacity: .7;
        background: url('https://i.pinimg.com/originals/e9/29/1e/e9291eaddacd460280a34a151dcc5cc4.gif');
        background-color: rgb(14,30,47);
        background-repeat: no-repeat;
        background-position: 50% 50%;
    }
</style>
<section class="header">
    <div class="row">
        <div class="col-sm-12 col-sm-offset-1 col-xs-12 col-xs-offset-1">
            <h3>
                Administrador de vistas
                <small>/ Panel de control </small>
            </h3>
        </div>
    </div>
</section>
<section class="content">
    <div class="loader" hidden></div>
    <div class="row">
        <div class="col-sm-12 col-xs-12">
            <!----- Asignacion de permisos a usuarios ------->
            <div class="row">

                <div class="col-sm-6 col-xs-12">


                    <div class="box box-danger">

                        <div id="overlay-user" class="overlay">
                            <i class="fa fa-refresh fa-spin"></i>
                        </div>

                        <div class="box-header">
                            <div class="box-title">
                                <i class="glyphicon glyphicon-user"></i>
                                Asignación de vistas a usuarios
                            </div>
                        </div>
                        <div class="box-body">
                            <div class="table table-responsive">
                                <table id="tbUser">
                                    <thead>
                                        <tr style="text-align:center;">
                                            <th>Correo electrónico</th>
                                            <th>Opciones</th>
                                        </tr>
                                    </thead>
                                    <tbody class="tab-info">
                                        @foreach (var item in this.Model.usuarios)
                                        {
                                            <tr>
                                                <td>@item.Email</td>
                                                <td>
                                                    <button onclick="Acceso('@item.Email.ToString()','Identificador-@item.IdUser.ToString()','@item.UserName.ToString()')" class="btn btn-block btn-primary">
                                                        <i class="glyphicon glyphicon-edit"></i> Control de Acceso
                                                    </button>
                                                </td>
                                            </tr>
                                        }


                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>


                    <div class="box box-danger">

                        <div id="overlay-clone" class="overlay">
                            <i class="fa fa-refresh fa-spin"></i>
                        </div>


                        <div class="box-header with-border">
                            <div class="box-title">
                                <i class="glyphicon glyphicon-user"></i>
                                Clonar usuarios
                            </div>
                        </div>

                        <div class="box-body">

                            <!-- Correo origen -->
                            <div id="div-correo-origen" class="form-group">
                                <label>Usuario origen:</label>
                                <div class="input-group">
                                    <div class="input-group-addon">
                                        <i class="fa fa-at"></i>
                                    </div>
                                    <input id="input-correo-origen" type="text" class="form-control">
                                    <div id="btn-search-correo-origen" class="input-group-addon">
                                        <i class="fa fa-search"></i>
                                    </div>
                                </div>
                                <span id="spam-correo-origen" class="help-block"></span>
                            </div>

                            <div id="pnlVistasUser" class="panel panel-success">
                                <div class="panel-heading">
                                    <span class="panel-title">
                                        Vistas asignadas al usuario actual
                                    </span>
                                </div>
                                <div class="panel-body">
                                    <form id="frmVistas_user"></form>



                                </div>
                            </div>

                            <div id="panel-usuarios-destino" style="height:50%;" class="panel panel-success">
                                <div class="panel-heading">
                                    <span class="panel-title">
                                        Usuarios a asignar permisos
                                    </span>
                                </div>
                                <div class="panel-body">

                                    <div class="table table-responsive">
                                        <table id="table-usuarios-destino">
                                            <thead>
                                                <tr style="text-align:center;">
                                                    <th>Correo electrónico</th>
                                                    <th>Opciones</th>
                                                </tr>
                                            </thead>
                                            <tbody class="tab-info">
                                                @foreach (var item in this.Model.usuarios)
                                                {
                                                    <tr>
                                                        <td><span> @item.Email</span></td>
                                                        <td>
                                                            <span class="input-group-addon">
                                                                <input type="checkbox" name="View_user_destino" value="@item.Email">
                                                            </span>
                                                        </td>
                                                    </tr>
                                                }

                                            </tbody>
                                        </table>
                                    </div>

                                </div>
                            </div>

                        </div>
                        <div class="box-footer">
                            <div class="col-md-12">
                                <button id="btn-clonar-usuario" type="button" class="btn btn-success pull-right"><i class="fa fa-clone" aria-hidden="true"></i>&nbsp&nbsp Clonar &nbsp&nbsp</button>
                            </div>
                        </div>
                    </div>



                </div>

                <!------------- Manejo de vistas y de módulos ----------->

                <div class="col-sm-6 col-xs-12">
                    <div class="box box-info">

                        <div id="overlay-vista-principal" class="overlay">
                            <i class="fa fa-refresh fa-spin"></i>
                        </div>

                        <div class="box-header">
                            <span class="box-title">
                                <i class="glyphicon glyphicon-eye-open"></i>
                                Control de vistas de sistema.
                            </span>
                        </div>
                        <div class="box-body">

                            <div class="row">

                                <div class="col-sm-10 col-sm-offset-1 col-xs-12">
                                    <div class="btn-group pull-right">
                                        <button id="btnModulos" onclick="OpenModalAddModulo();" class="btn btn-link">
                                            <i class="glyphicon glyphicon-plus"></i>
                                            Agregar Módulos
                                        </button>
                                        <button id="btnModulos" onclick="OpenModalAddVista();" class="btn btn-link">
                                            <i class="glyphicon glyphicon-plus"></i>
                                            Agregar Vistas
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!--------------------  Panel de visualizacion de menu -------------->
                            <div class="panel panel-info">
                                <div class="panel-heading">
                                    <div class="panel-title">
                                        Vista principal de menú
                                    </div>
                                </div>
                                <div class="panel-body">
                                    <ul id="ListaModulos"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>
<!---------------------- Modal de Acceso a usuarios  ---------------------->
<div class="modal fade" id="ModalAccesoUsuario">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">
                    <i class="glyphicon glyphicon-edit"></i> Control de accesos de usuario
                </h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12 col-xs-12">
                        <input id="txtIdUsuarioModal" class='form-control' readonly style="display:none" />
                        <div class='form-group col-sm-12 col-xs-12'>
                            <div class='input-group col-sm-10 col-sm-offset-1 col-xs-12'>
                                <span class='input-group-addon'>Usuario:</span>
                                <input id="txtUsuarioModal" class='form-control' readonly />
                                <span class='input-group-addon'><i class='glyphicon glyphicon-user'></i></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12 col-xs-12">
                        <button id="btnAddModalModulo" onclick="OpenModalAddModulo();" class="btn btn-link pull-right">
                            <i class="glyphicon glyphicon-plus"></i> Agregar módulo
                        </button>
                        <button id="btnAddModalVista" onclick="OpenModalAddVista();" class="btn btn-link pull-right">
                            <i class="glyphicon glyphicon-plus"></i> Agregar Vista
                        </button>
                    </div>
                    <div id="pnlVistas" class="panel panel-danger">
                        <div class="panel-heading">
                            <span class="panel-title">
                                Seleccione las Vistas para agregar al usuario
                            </span>
                        </div>
                        <div class="panel-body">
                            <form id="frmVistas"></form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="col-md-12">

                    <div class="pull-right">

                        <div class="form-group">
                            <div class="col-md-12">
                                <div class="input-group">

                                    <div class="input-group-append">

                                        <button id="btnCancelarVistaUsuario" class="btn btn-primary btn-danger" type="button"><i class="glyphicon glyphicon-remove"></i> Cancelar</button>

                                        <button id="btnAgregarVistaUsuario" class="btn btn-primary btn-success" type="button"><i class="glyphicon glyphicon-plus"></i> Agregar</button>

                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!------------------- Modal de Clonar usuario ------------------>
<!------------------- Modal de Add Modulos ------------------>
<div class="modal fade" id="ModalAddModulos">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom:solid 2px orangered;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">
                    <i class="glyphicon glyphicon-th-list"></i> Módulos
                </h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-6 col-sm-offset-3 col-xs-12">
                        <table id="tbRadios" class="table">
                            <thead class="bg-info" style="border-radius:3px;">
                                <tr>
                                    <th><h5>Seleccionar módulo padre</h5></th>
                                    <th scope="col">
                                        <input class="checkbox" type="radio" name="Decision" id="radSi" value="1"> Si
                                    </th>
                                    <th scope="col">
                                        <input class="checkbox" type="radio" name="Decision" id="radNo" value="2" checked> No
                                    </th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                    <div id="SelectModuloPadre" class="form-group col-sm-12 col-xs-12" hidden>
                        <label for="txtAddModulosPadre" class="col-sm-4 control-label">Seleccione el padre</label>
                        <div class="input-group col-sm-7">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-tasks"></i></span>
                            <select id="txtAddModulosPadre" name="txtAddModulosPadre" class="form-control"></select>
                        </div>
                    </div>
                    <div class="col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label for="txtNombreModulo" class="col-sm-4 col-xs-12 control-label">Nombre del módulo</label>
                            <div class="input-group col-sm-7 col-xs-12">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-pencil"></i></span>
                                <input type="text" id="txtNombreModulo" name="txtNombreModulo"
                                       class="form-control" placeholder="Agregar nombre del módulo a crear" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="txtIconModulo" class="col-sm-4 col-xs-12 control-label">Icono del módulo</label>
                            <div class="input-group col-sm-7 col-xs-12">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-star-empty"></i></span>
                                <input type="text" id="txtIconModulo" name="txtIconModulo"
                                       class="form-control" placeholder="Agregar el icono del módulo" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top:solid 2px orangered;">
                <div class="row">
                    <div class="col-sm-10 col-xs-12 pull-right">
                        <div class="col-sm-4 pull-right">
                            <button id="btnAddModulo" class="btn btn-success btn-block"><i class="glyphicon glyphicon-plus"></i> Agregar</button>
                        </div>
                        <div class="col-sm-4 pull-right">
                            <button id="btnCancelarAddModulos" class="btn btn-danger btn-block"><i class="glyphicon glyphicon-remove"></i> Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!------------------- Modal de Add Vistas ------------------>
<div class="modal fade" id="ModalAddVistas">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom:solid 2px orangered;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">
                    <i class="glyphicon glyphicon-eye-open"></i> Vistas
                </h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!------------ Modal Parte Izquierda ---------------->
                    <div class="col-sm-6 col-xs-12">
                        <h4 class="text text-center" style="text-decoration-line:underline;">Formulario de nueva vista</h4>
                        <div class="form-group">
                            <label for="txtModulosPadre" class="col-sm-4 control-label">Seleccione el módulo</label>
                            <div class="input-group col-sm-7">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-tasks"></i></span>
                                <select id="txtModulosPadre" name="txtModulosPadre" class="form-control"></select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="txtNombreVista" class="col-sm-4 col-xs-12 control-label">Nombre de la vista</label>
                            <div class="input-group col-sm-7 col-xs-12">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-pencil"></i></span>
                                <input type="text" id="txtNombreVista" name="txtNombreVista"
                                       class="form-control" placeholder="Agregar nombre de la vista a crear" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="txtIconVista" class="col-sm-4 col-xs-12 control-label">Icono de la vista</label>
                            <div class="input-group col-sm-7 col-xs-12">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-star-empty"></i></span>
                                <input type="text" id="txtIconVista" name="txtIconVista"
                                       class="form-control" placeholder="Agregar el icono de la vista" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="txtControllerVista" class="col-sm-4 col-xs-12 control-label">Nombre del controller</label>
                            <div class="input-group col-sm-7 col-xs-12">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-cog"></i></span>
                                <input type="text" id="txtControllerVista" name="txtControllerVista"
                                       class="form-control" placeholder="Agregar el controlador de la vista" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="txtViewVista" class="col-sm-4 col-xs-12 control-label">Nombre de la view</label>
                            <div class="input-group col-sm-7 col-xs-12">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-list-alt"></i></span>
                                <input type="text" id="txtViewVista" name="txtViewVista"
                                       class="form-control" placeholder="Agregar el nombre de la view" />
                            </div>
                        </div>
                        <div class="form-group col-sm-12 col-xs-12">
                            <div class="col-sm-4 col-xs-6 pull-right">
                                <button id="btnAddVista" class="btn btn-primary btn-block"><i class="glyphicon glyphicon-plus"></i> Agregar</button>
                            </div>
                        </div>

                    </div>
                    <!------------ Modal Parte derecha ---------------->
                    <div class="col-sm-6 col-xs-12">
                        <div id="pnlCRUDVistas" class="panel panel-danger">
                            <div class="panel-heading">
                                <span class="panel-title">
                                    Vistas existentes y estatus
                                </span>
                            </div>
                            <div class="panel-body">
                                <form id="frmVistasEdit"></form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top:solid 2px orangered;">
                <div class="row">
                    <div class="col-sm-10 col-xs-12 pull-right">
                        <div class="col-sm-4 col-xs-6 pull-right">
                            <button id="btnCancelarAddVista" class="btn btn-danger btn-block"><i class="glyphicon glyphicon-remove"></i> Salir</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!------------------ Carga de datos ------------------->
<script>
    $(window).load(function () {

        $('#overlay-clone').hide();
        $('#overlay-user').hide();
        $('#overlay-vista-principal').hide();

    });
    initModule();

    var arrayViewUser = [];

    var arrayUser = [];

    function AddViewUser(_View, _activo) {
        var res = {
            View: _View,
            Email: $('#input-correo-origen').val(),
            Activo: _activo
        }
        arrayViewUser.splice(0, 0, res);
    }


    function searchEmailOrigen() {

        let UsuarioOrigen = $('#input-correo-origen').val();

        if (UsuarioOrigen == '') {
            swal("Correo similar", "El correo origen no puede estar vacio", "warning");
            return false;
        }
        $.post('@Url.Action("GetValidaCorreo", "MenuByUSer")',
            { Correo: $('#input-correo-origen').val() }
            ,function (data) {

            if (data.Context != null) {
                $('#pnlVistasUser').show();
                $('#panel-usuarios-destino').show();
                $('#div-correo-origen').removeClass('has-error').addClass('has-success');
                $('#spam-correo-origen').text('Correo origen disponible');

                GetVistasUsuarioClonar(UsuarioOrigen);
            }
            else {
                $('#pnlVistasUser').hide();
                $('#panel-usuarios-destino').hide();
                $('#div-correo-origen').removeClass('has-error').addClass('has-error');
                $('#spam-correo-origen').text('Correo origen no disponible');
            }
        }).done(function (data) {
            //console.log("second success");
        }).fail(function (data) {
            //console.log("error");
        }).always(function (data) {
            //console.log("finished");
        });
    }

    $("#input-correo-origen").change(function () {
        //searchEmailOrigen();
    });

    $('#btn-search-correo-origen').click(function () {
        $('#overlay-clone').show();
        searchEmailOrigen();
        $('#overlay-clone').hide();
    });

    $('input[type="checkbox"]').click(function () {
        if (this.checked) {
            let value = $(this).val();
            let Email = $('#input-correo-origen').val();
            if (value == Email) {
                alert("El correo destino es similar que correo origen al que desea agregar a la colección");
                return false;
            }
            arrayUser.push(value);
        }
        else {
            VerifyUserDestino($(this).val());
        }
    });

    function VerifyUserDestino( val) {

        console.log('Array before removing the element = ' + arrayUser);
        arrayUser = jQuery.grep(arrayUser, function (value) {
            return value != val;
        });
        console.log('Array after removing the element = ' + arrayUser);
    }


    function initModule() {
        $('#input-correo-origen').val('');
        $('#spam-correo-origen').text('');
        $('#div-correo-origen').removeClass('has-success');
        $('#div-correo-origen').removeClass('has-error');

        $('#pnlVistasUser').hide();
        $('#panel-usuarios-destino').hide();

        arrayViewUser = [];
        arrayUser = [];

        $('#frmVistas_user').html('');

        $("input[name='View_user_destino']:checkbox").removeAttr('checked');
    }
    // clonar usuarios

    $("#btn-clonar-usuario").click(function () {
        $('#overlay-clone').show();

        let Email = $('#input-correo-origen').val();

        if (Email == '') {
            alert("El correo origen no debe de estas vacio");
            $('#overlay-clone').hide();
            return false;
        }

        if (arrayUser.length == 0) {
            alert("La colección de correos destino no debe de estar vacio. Seleccionar un correo");
            $('#overlay-clone').hide();
            return false;
        }
        if (arrayViewUser.length == 0) {
            alert("La colección de los permisos del correo origen no puede estar vacio.");
            $('#overlay-clone').hide();
            return false;
        }
        $.post('@Url.Action("AddPermisosUsuario", "MenuByUSer")',
            {
                arrayViewUser: arrayViewUser,
                arrayUser: arrayUser
            }, function (data) {

                if (data.Context != null) {
                    $('#pnlVistasUser').show();
                    $('#panel-usuarios-destino').show();
                    $('#div-correo-origen').removeClass('has-error').addClass('has-success');
                    $('#spam-correo-origen').text('Correo origen disponible');
                    $('#pnlVistasUser').hide();

                    GetVistasUsuarioClonar(UsuarioOrigen);
                    initModule();
                }
                else {
                    $('#pnlVistasUser').hide();
                    $('#panel-usuarios-destino').hide();
                    $('#div-correo-origen').removeClass('has-error').addClass('has-error');
                    $('#spam-correo-origen').text('Correo origen no disponible');
                }
            }).done(function (data) {
                //console.log("second success");
            }).fail(function (data) {
                //console.log("error");
            }).always(function (data) {
                //console.log("finished");
            });

        $('#overlay-clone').hide();
    });

    $(document).ready(function () {
        tableComplet();
        GetModulos();
        GetVistas();
        VistaPrincipal();
    });
    function tableComplet() {
        $('#tbUser').DataTable({
            "lengthMenu": [[6, 10, 20, -1], [6, 10, 20, "All"]],
            "scrollY": "300px",
            "scrollCollapse": true,
            "paging": true,
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.10.13/i18n/Spanish.json"
            }
        });

        $('#table-usuarios-destino').DataTable({
            "lengthMenu": [[6, 10, 20, -1], [6, 10, 20, "All"]],
            "scrollY": "300px",
            "scrollCollapse": true,
            "paging": true,
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.10.13/i18n/Spanish.json"
            }
        });
    }
    //**************** Carga de Vistas para usuario seleccionado ***************
    function GetVistasUsuario(Email) {
        $("#frmVistas").html('');
        $("#frmVistasEdit").html('');
        $.ajax({
            contentType: "application/json; charset=utf-8",
            type: "post",
            url: '@Url.Action("GetVistasUsuarios", "MenuByUser")',
            async: false,
            data: '',
            dataType: 'JSON',
            success: function (response) {
                if (response.Context != null) {
                    var auxSeleccionado = new Array;
                    var auxInactivo = new Array;
                    var auxCont = 0;
                    var auxCont1 = 0;
                    $.each(response.Context, function (index, value) {
                        if (value.Activo == true) {
                            if (auxCont != value.Identifier) {
                                if (value.Email == Email) {
                                    if (value.VistaUserActivo == true) {
                                        $("#frmVistas").append(
                                            "<div class='form-group col-sm-12 col-xs-12'>" +
                                            "<div class='input-group col-sm-12 col-xs-12'>" +
                                            "<span class='input-group-addon'><i class='fa fa-circle text-info'></i></span>" +
                                            "<span class='input-group-addon'><i class='" + value.Icon + "'></i></span>" +
                                            "<input class='form-control' value='" + value.ModuloName + " > " + value.Nombre + "' readonly/>" +
                                            "<span class='input-group-btn'>" +
                                            "<button type='button' class='btn btn-info' onclick='ControlVistaUsuario(" + value.Identifier + ",0)'>Vista Seleccionada</button>" +
                                            "</span>" +
                                            "</div>" +
                                            "</div>"
                                        );
                                        auxSeleccionado.push(value.Identifier);
                                        auxCont = value.Identifier;
                                    } else {
                                        $("#frmVistas").append(
                                            "<div class='form-group col-sm-12 col-xs-12'>" +
                                            "<div class='input-group col-sm-12 col-xs-12'>" +
                                            "<span class='input-group-addon'><i class='fa fa-circle text-info'></i></span>" +
                                            "<span class='input-group-addon'><i class='" + value.Icon + "'></i></span>" +
                                            "<input class='form-control' value='" + value.ModuloName + " > " + value.Nombre + "' readonly/>" +
                                            "<span class='input-group-btn'>" +
                                            "<button type='button' class='btn btn-warning' onclick='ControlVistaUsuario(" + value.Identifier + ",1)'>Vista seleccionada pero inactiva</button>" +
                                            "</span>" +
                                            "</div>" +
                                            "</div>"
                                        );
                                        auxSeleccionado.push(value.Identifier);
                                        auxCont = value.Identifier;
                                    }
                                }
                            }
                        }
                    });
                    $.each(response.Context, function (index, value) {
                        if (value.Activo == false) {
                            if (auxCont1 != value.Identifier) {
                                $("#frmVistas").append(
                                    "<div class='form-group col-sm-12 col-xs-12'>" +
                                    "<div class='input-group col-sm-12 col-xs-12'>" +
                                    "<span class='input-group-addon'><i class='fa fa-circle text-danger'></i></span>" +
                                    "<span class='input-group-addon'><i class='" + value.Icon + "'></i></span>" +
                                    "<input class='form-control' value='" + value.ModuloName + " > " + value.Nombre + "' readonly/>" +
                                    "<span class='input-group-btn'>" +
                                    "<button type='button' class='btn btn-danger' disable>Vista inactiva</button>" +
                                    "</span>" +
                                    "</div>" +
                                    "</div>"
                                );
                                auxCont1 = value.Identifier;
                                auxInactivo.push(value.Identifier);
                            }
                        }
                    });
                    var auxRe = 0;
                    $.each(response.Context, function (index, value) {
                        if (auxRe != value.Identifier) {
                            if (!(FindValor(auxSeleccionado, value.Identifier) || FindValor(auxInactivo, value.Identifier))) {
                                $("#frmVistas").append(
                                    "<div class='form-group col-sm-12 col-xs-12'>" +
                                    "<div class='input-group col-sm-12 col-xs-12'>" +
                                    "<span class='input-group-addon'><i class='fa fa-circle text-success'></i></span>" +
                                    "<span class='input-group-addon'><i class='" + value.Icon + "'></i></span>" +
                                    "<input class='form-control' value='" + value.ModuloName + " > " + value.Nombre + "' readonly/>" +
                                    "<span class='input-group-addon'>" +
                                    "<input type='checkbox' name='Vista-" + value.Identifier + "' value='" + value.Identifier + "'/>" +
                                    "</span>" +
                                    "</div>" +
                                    "</div>"
                                );
                            }
                        }
                        auxRe = value.Identifier;
                    });
                } else
                {
                    console.log("response vista de usuario seleccionado");
                    console.log(response);
                }
            },
            error: function (data) {
                console.log("data de vista de usuario seleccionado");
                console.log(data);
            }
        });
    }

    function GetVistasUsuarioClonar(Email) {
        $("#frmVistas_user").html('');



        $.post('@Url.Action("GetPermisosVistaUsuario", "MenuByUSer")',
            { Correo: $('#input-correo-origen').val() }
            , function (data) {
                if (data != null) {
                    $('#pnlVistasUser').show();

                    // modulos
                    $.each(data.Context, function (index, value) {

                        $.each(value.vistas, function (index1, value1) {
                            let Estado = value1.Activo;
                            let CheckBox = '';
                            AddViewUser(value1.Identifier, Estado);
                            if (Estado) {
                                CheckBox = "<input type='checkbox' name='Vista_user_checked' checked value='vista_" + value1.Identifier + "'>";
                            }
                            else {
                                CheckBox = "<input type='checkbox' name='Vista_user_checked' value='vista_" + value1.Identifier + "'>";
                            }

                            $("#frmVistas_user").append(
                                "<div class='form-group col-sm-12 col-xs-12'>" +
                                    "<div class='input-group col-sm-12 col-xs-12'>" +
                                        "<span class='input-group-addon'><i class='fa fa-circle text-info'></i></span>" +
                                        "<span class='input-group-addon'><i class='" + value1.Icon + "'></i></span>" +
                                        "<input class='form-control' value='" + value.Nombre + " > " + value1.Nombre + "' readonly/>" +
                                        "<span class='input-group-addon'>" +
                                            CheckBox +
                                        "</span>" +
                                    "</div>" +
                                "</div>"
                            );
                        });


                        // submodulo
                        $.each(value.modulos, function (index2, value2) {

                            $.each(value2.vistas, function (index3, value3) {
                                let Estado1 = value3.Activo;
                                let CheckBox1 = '';
                                AddViewUser(value3.Identifier, Estado1);
                                if (Estado1) {

                                    CheckBox1 = "<input type='checkbox' name='Vista_user_checked' checked value='vista_" + value3.Identifier + "'>";
                                }
                                else {
                                    CheckBox1 = "<input type='checkbox' name='Vista_user_checked' value='vista_" + value3.Identifier + "'>";
                                }

                                $("#frmVistas_user").append(
                                    "<div class='form-group col-sm-12 col-xs-12'>" +
                                        "<div class='input-group col-sm-12 col-xs-12'>" +
                                            "<span class='input-group-addon'><i class='fa fa-circle text-info'></i></span>" +
                                            "<span class='input-group-addon'><i class='" + value3.Icon + "'></i></span>" +
                                            "<input class='form-control' value='" + value.Nombre + " > " + value2.Nombre + " > " + value3.Nombre + " ' readonly/>" +
                                            "<span class='input-group-addon'>" +
                                                CheckBox1 +
                                            "</span>" +
                                        "</div>" +
                                    "</div>"
                                );
                            });
                        });

                    });
                }
                else {
                }

            }).done(function (data) {
                //console.log("second success");
            }).fail(function (data) {
                //console.log("error");
            }).always(function (data) {
                //console.log("finished");
            });

    }


    function FindValor(array, valor) {
        for (var i = 0; i <= array.length; i++) {
            if (array[i] == valor) {
                return true;
            }
        }
    }
    //**************** Carga de Vistas ***************
    function GetVistas() {
        $("#frmVistasEdit").html('');
        $("#frmVistas").html('');
        $.ajax({
            contentType: "application/json; charset=utf-8",
            type: "post",
            url: '@Url.Action("GetVistas", "MenuByUser")',
            async: false,
            data: '',
            dataType: 'JSON',
            success: function (response) {
                if (response.Context != null) {
                    $.each(response.Context, function (index, value) {
                        if (value.Activo == true) {
                            $("#frmVistasEdit").append(
                                "<div class='form-group col-sm-12 col-xs-12'>" +
                                "<div class='input-group col-sm-12 col-xs-12'>" +
                                "<span class='input-group-addon'><i class='fa fa-circle text-success'></i></span>" +
                                "<span class='input-group-addon'><i class='" + value.Icon + "'></i></span>" +
                                "<input class='form-control' value='" + value.Nombre + "' readonly/>" +
                                "<span class='input-group-btn'>" +
                                "<button type='button' class='btn btn-success' onclick='EstadoVista(" + value.Identifier+",0)'>Desactivar</button>" +
                                "</span>" +
                                "</div>" +
                                "</div>"
                            );
                        } else {
                            $("#frmVistasEdit").append(
                                "<div class='form-group col-sm-12 col-xs-12'>" +
                                "<div class='input-group col-sm-12 col-xs-12'>" +
                                "<span class='input-group-addon'><i class='fa fa-circle text-danger'></i></span>" +
                                "<span class='input-group-addon'><i class='" + value.Icon + "'></i></span>" +
                                "<input class='form-control' value='" + value.Nombre + "' readonly/>" +
                                "<span class='input-group-btn'>" +
                                "<button type='button' class='btn btn-danger' onclick='EstadoVista(" + value.Identifier + ",1)'>Activar</button>" +
                                "</span>" +
                                "</div>" +
                                "</div>"
                            );
                        }
                    });
                } else
                {
                    console.log("response vistas");
                    console.log(response);
                }
            },
            error: function (data) {
                console.log("data vistas");
                console.log(data);
            }
        });
    }
    //**************** Carga de Vistas para visualizacion de menu principal ***************
    function VistaPrincipal() {
        $("#ListaModulos").html('');
        $.ajax({
            contentType: "application/json; charset=utf-8",
            type: "post",
            url: '@Url.Action("VistaPrincipal", "MenuByUser")',
            async: false,
            data: '',
            dataType: 'JSON',
            success: function (response) {
                if (response.Context != null) {
                    var cont = 0;
                    var cont2 = 0;
                    $.each(response.Context, function (index, value) {
                        $("#ListaModulos").append(
                            "<li class='list-header'>" +
                            "<a class='btn btn-link btn-block' id='menuNivel1' data-toggle='collapse' data-target='#nivel" + cont + "'>" +
                            "<i class='" + value.Icon + "'></i>" +
                            "<span>" + value.Nombre + "</span>" +
                            "<span class='pull-right-container'>" +
                            "<i class='fa fa-angle-left pull-right'></i>" +
                            "</span>" +
                            "</a>" +
                            "<ul id='nivel" + cont + "' class='collapse'></ul>" +
                            "</li>"
                        );
                        $.each(value.vistas, function (index2, value2) {
                            $("#nivel" + cont + "").append(
                                "<li>" +
                                "<a class='btn btn-link btn-block'>" + "<i class='" + value2.Icon + "'></i>" + value2.Nombre + "</a>" +
                                "</li>"
                            );
                        });
                        $.each(value.submodulos, function (index3, value3) {
                            $("#nivel" + cont + "").append(
                                "<li>" +
                                "<a class='btn btn-link btn-block' id='menuNivel2' data-toggle='collapse' data-target='#subnivel" + cont2 + "'>" +
                                "<i class='" + value3.Icon + "'></i>" + value3.Nombre +
                                "<span class='pull-right-container'>" +
                                "<i class='fa fa-angle-left pull-right'></i>" +
                                "</span>" +
                                "</a>" +
                                "</li>" +
                                "<ul id='subnivel" + cont2 + "' class='collapse'>" +
                                "</ul>"
                            );
                            $.each(value3.vistas, function (index4, value4) {
                                $("#subnivel" + cont2 + "").append(
                                    "<li>" +
                                    "<a class='btn btn-link btn-block'>" +
                                    "<i class='" + value4.Icon + "'>" + "</i>" + value4.Nombre +
                                    "</a>" +
                                    "</li>"
                                );
                            });
                            cont2++;
                        });
                        cont++;
                    });
                }
                else
                {
                    console.log("response Vista principal");
                    console.log(response);
                }
            },
            error: function (data) {
                console.log("data Vista principal");
                console.log(data);
            }
        });
    }
    //**************** Carga de Modulos ***************
    function GetModulos() {
        $("#txtModulosPadre").html('');
        $("#txtAddModulosPadre").html('');
        $.ajax({
            contentType: "application/json; charset=utf-8",
            type: "post",
            url: '@Url.Action("GetModulos", "MenuByUser")',
            async: false,
            data: '',
            dataType: 'JSON',
            success: function (response) {
                $("#txtModulosPadre").append(
                    "<option value='0' selected disabled>Seleccione una modulo</option>"
                );
                $("#txtAddModulosPadre").append(
                    "<option value='0' selected disabled>Seleccione una modulo</option>"
                );
                if (response.Context != null) {
                    $.each(response.Context, function (index, value) {
                        $("#txtModulosPadre").append(
                            "<option value='" + value.Identifier + "'>" + value.Nombre +
                            "</option>"
                        );
                        $("#txtAddModulosPadre").append(
                            "<option value='" + value.Identifier + "'>" + value.Nombre +
                            "</option>"
                        );
                    });
                } else
                {
                    console.log("response");
                    console.log(response);
                }
            },
            error: function (data) {
                console.log("data");
                console.log(data);
            }
        });
    }
</script>
<!----------------  Manejo de Acceso a usuarios -------->
<script>
    function ControlVistaUsuario(IdVista,Estado) {
        var IdUsuario = $("#txtIdUsuarioModal").val();
        var Email = $("#txtUsuarioModal").val();
        var vista = {
            "IdUsuario": IdUsuario,
            "Identifier": IdVista,
            "Activo": Estado
        };
        $(".loader").show();
        $.ajax({
            contentType: "application/json; charset=utf-8",
            type: "post",
            url: '@Url.Action("ControlVistaUsuario", "MenuByUser")',
            async: false,
            data: JSON.stringify(vista),
            dataType: 'JSON',
            success: function (response) {
                GetVistasUsuario(Email)
                $(".loader").hide();
            },
            error: function (data) {
                GetVistasUsuario(Email);
                console.log("data");
                console.log(data);
                $(".loader").hide();
            }
        });
    }
    function Acceso(Email, IdUser, UserName) {
        $("#txtIdUsuarioModal").val(IdUser);
        $("#txtUsuarioModal").val(Email);
        GetVistasUsuario(Email);
        $("#ModalAccesoUsuario").modal("show");
    }
    //********** Buttons de manejo de modal eventos Hide and Show
    $("#btnCancelarVistaUsuario").click(function () {
        $("#txtIdUsuarioModal").val('');
        $("#txtUsuarioModal").val('');
        $("#ModalAccesoUsuario").modal("hide");
    });
    //*********** Seleccion de vistas
    function obtenerSeleccionVistas(Email,IdUser) {
        let tamaño = $("#frmVistas input[type='checkbox']").toArray().length;
        var elemnt = { users: [], vistas: []};
        elemnt.users.push({
            "Email": Email,
            "IdUser": IdUser
        });
        var input = $("#frmVistas input[type='checkbox']").toArray();
        for (var i = 0; i < tamaño; i++) {
            if (input[i].checked == true) {
                let valor = input[i].attributes.value;
                elemnt.vistas.push({
                    "Identifier": valor.value
                });
            }
        }
        return elemnt;
    }
    function DeseleccionarInput() {
        var input = $("#frmVistas input[type='checkbox']").toArray();
        for (var i = 0; i < input.length; i++) {
            input[i].checked = false;
        }
    }
    //**************************************************
    //************** Alta de usuario con sus vistas
    $("#btnAgregarVistaUsuario").click(function () {
        let Email = $("#txtUsuarioModal").val();
        let IdUser = $("#txtIdUsuarioModal").val();
        if (Email == "") {
            swal("Alerta!", "Debe seleccionar un usuario", "warning");
            return;
        }
        var inputs = obtenerSeleccionVistas(Email, IdUser);
        $(".loader").show();
        $.ajax({
            contentType: "application/json; charset=utf-8",
            type: "post",
            url: '@Url.Action("AddVistaUser", "MenuByUser")',
            async: false,
            data: JSON.stringify(inputs),
            dataType: 'JSON',
            success: function (response) {
                DeseleccionarInput();
                GetVistasUsuario(Email)
                $("#ModalModulos").modal("show");
                $(".loader").hide();
            },
            error: function (data) {
                DeseleccionarInput();
                GetVistasUsuario(Email);
                console.log("data");
                console.log(data);
                $(".loader").hide();
            }
        });
    });
</script>
<!----------- Apertura y cierre de modal vistas y modulos ------>
<script>
    //***************  Apertura y cierre de modal vistas y modulos *****************************
    function OpenModalAddModulo() {
        $("#ModalAddModulos").modal("show");
    }
    function OpenModalAddVista() {
        GetVistas();
        $("#ModalAddVistas").modal("show");
    }
    $("#btnCancelarAddVista").click(function () {
        $("#ModalAddVistas").modal("hide");
    });
    $("#btnCancelarAddModulos").click(function () {
        $("#ModalAddModulos").modal("hide");
    });
</script>
<!----------- Modal Agregar modulos nuevos ------>
<script>
    //************ Manejo de Radios **************
    $("#radSi").change(function () {
        $("#SelectModuloPadre").show();
        $("#radSi").attr('checked', true);
        $("#radNo").attr('checked', false);
    });
    $("#radNo").change(function () {
        $("#SelectModuloPadre").hide();
        $("#txtAddModulosPadre").val("0");
        $("#radSi").attr('checked', false);
        $("#radNo").attr('checked', true);
    });
    //************************  Add modulos ************************************************
    function LimpiarModuloAdd() {
        $("#txtNombreModulo").val('');
        $("#txtIconModulo").val('');
    }
    $("#btnAddModulo").click(function () {
        let Nombre = $("#txtNombreModulo").val();
        let Icon = $("#txtIconModulo").val();
        let Padre = $("#txtAddModulosPadre").val();
        if (Nombre=="") {
            swal("Alerta!", "Debe de agregar un nombre de Módulo", "warning");
            return;
        }
        if (Icon=="") {
            swal("Alerta!", "Debe de agregar un Icon al Módulo", "warning");
            return;
        }
        $(".loader").show();
        $.ajax({
            contentType: "application/json; charset=utf-8",
            type: "post",
            url: '@Url.Action("AddModulo", "MenuByUser")',
            async: false,
            data: '{Nombre:"' + Nombre + '",Icon:"' + Icon + '",Padre:"' + Padre + '"}',
            dataType: 'JSON',
            success: function (response) {
                GetModulos();
                $("#ModalAddModulos").modal("hide");
                LimpiarModuloAdd();
                $(".loader").hide();
            },
            error: function (data) {
                console.log("data");
                console.log(data);
                GetModulos();
                $("#ModalAddModulos").modal("hide");
                LimpiarModuloAdd();
                $(".loader").hide();
            }
        });
    });

</script>
<!------------- Manejo de vistas CRUD -------------->
<script>
    function LimpiarVistaAdd() {
        $("#txtModulosPadre").val(0);
        $("#txtNombreVista").val('');
        $("#txtIconVista").val('');
        $("#txtControllerVista").val('');
        $("#txtViewVista").val('');
    }
    //**************  ADD  ******************
    $("#btnAddVista").click(function () {
        let modulo = $("#txtModulosPadre").val();
        let nombre = $("#txtNombreVista").val();
        let icono = $("#txtIconVista").val();
        let controller = $("#txtControllerVista").val();
        let view = $("#txtViewVista").val();
        if (modulo == "" || nombre == "" || icono == "" || controller == "" || view == "") {
            swal("Alerta!", "Debe acompletar el formulario", "warning");
            return;
        }
        var vista = {
            "Modulo": modulo,
            "Nombre": nombre,
            "Icon": icono,
            "Controller": controller,
            "View": view
        };
        $(".loader").show();
        $.ajax({
            contentType: "application/json; charset=utf-8",
            type: "post",
            url: '@Url.Action("AddVista", "MenuByUser")',
            async: false,
            data: JSON.stringify(vista),
            dataType: 'JSON',
            success: function (response) {
                LimpiarVistaAdd();
                GetVistas();
                $(".loader").hide();
            },
            error: function (data) {
                console.log("data");
                console.log(data);
                GetVistas();
                $(".loader").hide();
            }
        });
    });
    //**********   Update estado de la vista  ****************
    function EstadoVista(IdVista, Estado) {
        let Email = $("#txtUsuarioModal").val();
        console.log(Email);
        var vista = {
            "Identifier": IdVista,
            "Activo": Estado
        };
        $(".loader").show();
        $.ajax({
            contentType: "application/json; charset=utf-8",
            type: "post",
            url: '@Url.Action("UpdateVista", "MenuByUser")',
            async: false,
            data: JSON.stringify(vista),
            dataType: 'JSON',
            success: function (response) {
                if (Email != "") {
                    GetVistasUsuario(Email);
                    GetVistas();
                    VistaPrincipal();
                    $(".loader").hide();
                } else {
                    GetVistas();
                    VistaPrincipal();
                    $(".loader").hide();
                }
            },
            error: function (data) {
                console.log("data");
                console.log(data);
                if (Email != "") {
                    GetVistasUsuario(Email);
                    GetVistas();
                    VistaPrincipal();
                    $(".loader").hide();
                } else {
                    GetVistas();
                    VistaPrincipal();
                    $(".loader").hide();
                }
            }
        });
    }
</script>
