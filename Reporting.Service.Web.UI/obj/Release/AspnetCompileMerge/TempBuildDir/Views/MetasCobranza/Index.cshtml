

@{
    ViewBag.Title = "Index";
}
<style>
    .hide-table-inbursa {
        display: none;
    }

    .datepicker {
        z-index: 1151 !important;
    }

    #exceltable {
        display: none !important;
    }

    .nav-tabs-custom > .nav-tabs > li.active {
        border-top-color: #dd4b39 !important;
    }

    #loading-steuben-bancomer {
        z-index: 10;
    }

    .info-box-icon {
        height: 110px !important;
        line-height: 110px !important;
    }
</style>


<section class="content-header">
    <h1>
        Metas cobranza
        <small>Panel de control</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Finanzas</a></li>
        <li class="active">Metas cobranza</li>
    </ol>
</section>
<section class="content">
    <div class="row">
        <div class="col-md-12">
            <div class="box box-danger">
                <div class="box-header with-border">
                    <i class="fa fa-money"></i>

                    <h3 class="box-title">Metas cobranza</h3>

                    <div class="box-tools pull-right">
                        <!--<button id="DetalleExcelVentas" type="button" class="btn btn-box-tool"><i class="fa fa-file-excel-o"></i></button>-->
                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                    </div>
                </div>
                <div id="VentasRefresh" style="display:none;" class="overlay">
                    <i class="fa fa-cog fa-spin fa-5x"></i>
                </div>
                <div class="box-body">
                    <div class="col-md-4">
                        <div class="form-group">
                            <div class="form-group">
                                <label>Fijar meta:</label>
                                <div class="input-group">
                                    <div class="input-group-addon">
                                        <i class="glyphicon glyphicon-calendar"></i>
                                    </div>
                                    <input type="text" class="form-control pull-right" id="fecha-meta">
                                </div>
                            </div>
                            <div class="form-group">
                                <div id="btnPagos" class="btn btn-primary btn-block"><i class="fa fa-eye"></i> Mostrar detalles</div>
                            </div>
                            <div class="form-group">
                                <div id="btnGuardarMeta" class="btn btn-success btn-block"><i class="fa fa-save"></i> Guardar metas</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-6 col-sm-6 col-xs-6" style="height:auto">
                                <div class="info-box" style="height:110px !important;">
                                    <span class="info-box-icon bg-light-blue"><i class="fa fa-dollar"></i></span>
                                    <div class="info-box-content">
                                        <div class="col-md-12">
                                            <span class="info-box-text pull-left">Vencido Fecha Meta</span>
                                            <span class="info-box-text pull-right" id="acumulado-vencidas-anio-anterior"></span>
                                        </div>

                                        <div class="col-md-12">
                                            <span class="info-box-text pull-left">Mayoreo</span>
                                            <span class="info-box-text pull-right" id="lb-mayoreo-anterior"></span>
                                        </div>
                                        <div class="col-md-12">
                                            <span class="info-box-text pull-left">Retail</span>
                                            <span class="info-box-text pull-right" id="lb-retail-anterior"></span>
                                        </div>

                                        <div class="col-md-12">
                                            <span class="info-box-text pull-left">Internet</span>
                                            <span class="info-box-text pull-right" id="lb-internet-anterior"></span>
                                        </div>
                                        <div class="col-md-12">
                                            <span class="info-box-text pull-left">Franquicia</span>
                                            <span class="info-box-text pull-right" id="lb-franquicia-anterior"></span>
                                        </div>

                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-sm-6 col-xs-6">
                                <div class="info-box" style="height:110px !important;">
                                    <span class="info-box-icon bg-aqua hidden-sm-down"><i class="fa fa-dollar"></i></span>
                                    <div class="info-box-content">

                                        <div class="col-md-12">
                                            <span class="info-box-text pull-left">Meta Mayoreo</span>
                                            <input type="number" class="form-control pull-right" style="height: 23px !important; max-width: 120px;" id="meta-mayoreo">
                                        </div>
                                        <div class="col-md-12">
                                            <span class="info-box-text pull-left">Meta Retail</span>
                                            <input type="number" class="form-control pull-right" style="height: 23px !important; max-width: 120px;" id="meta-retail">
                                        </div>
                                        <div class="col-md-12">
                                            <span class="info-box-text pull-left">Meta Internet</span>
                                            <input type="number" class="form-control pull-right" style="height: 23px !important; max-width:120px;" id="meta-internet">
                                        </div>
                                        <div class="col-md-12">
                                            <span class="info-box-text pull-left">Meta Franquicia</span>
                                            <input type="number" class="form-control pull-right" style="height: 23px !important; max-width:120px;" id="meta-franquicia">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 col-sm-6 col-xs-6">
                                <div class="info-box" style="height:110px !important;">
                                    <span class="info-box-icon bg-green"><i class="fa fa-dollar"></i></span>
                                    <div class="info-box-content">
                                        <div class="col-md-12">
                                            <span class="info-box-text pull-left">Vencido Fecha Hoy</span>
                                            <span id="acumulado-vencidas-anio-actual" class="info-box-text pull-right"></span>
                                        </div>

                                        <div class="col-md-12">
                                            <span class="info-box-text pull-left">Mayoreo</span>
                                            <span class="info-box-text pull-right" id="lb-mayoreo-actual"></span>
                                        </div>
                                        <div class="col-md-12">
                                            <span class="info-box-text pull-left">Retail</span>
                                            <span class="info-box-text pull-right" id="lb-retail-actual"></span>
                                        </div>

                                        <div class="col-md-12">
                                            <span class="info-box-text pull-left">Internet</span>
                                            <span class="info-box-text pull-right" id="lb-internet-actual"></span>
                                        </div>
                                        <div class="col-md-12">
                                            <span class="info-box-text pull-left">Franquicia</span>
                                            <span class="info-box-text pull-right" id="lb-franquicia-actual"></span>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="Contenido">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="alert alert-danger" role="alert">
                                    <div id="btnSyncPagos" class="btn btn-success"><i class="fa fa-history"></i> Sincronizar pagos</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div id="tabs-principal" class="nav-tabs-custom">
                                    <ul class="nav nav-tabs">
                                        <li id="tab-1" class="active"><a data-toggle="tab" href="#tab-opcion-mayoreo" aria-expanded="false" id="tab-opcion-mayoreo">Mayoreo</a></li>
                                        <li id="tab-2"><a data-toggle="tab" href="#tab-opcion-retail" aria-expanded="false" id="tab-opcion-retail">Retail</a></li>
                                        <li id="tab-3"><a data-toggle="tab" href="#tab-opcion-internet" aria-expanded="false" id="tab-opcion-internet">Internet</a></li>
                                        <li id="tab-4"><a data-toggle="tab" href="#tab-opcion-franquicia" aria-expanded="false" id="tab-opcion-franquicia">Franquicia</a></li>
                                    </ul>
                                    <div class="tab-content">
                                        <div class="table-responsive" class="tab-pane fade in active">
                                            <table id="Metas" class="table table-bordered">
                                                <thead>
                                                    <tr>
                                                        <td>Fecha de meta</td>
                                                        <td>Vencido año actual</td>
                                                        <td>Meta año actual</td>
                                                        <td>Cobrado año actual</td>
                                                        <td>Registrado el</td>
                                                        <td>Cumplimineto meta año actual</td>
                                                    </tr>
                                                </thead>
                                                <tbody id="DetalleMetas"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="alert alert-danger" role="alert">
                                    Detalles
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="table-responsive">
                                    <table id="Detalles" class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <td>Factura</td>
                                                <td>Fecha factura</td>
                                                <td>Fecha vencimiento</td>
                                                <td>Cardcode</td>
                                                <td>Cardname</td>
                                                <td>Canal</td>
                                                <td>Saldo</td>
                                            </tr>
                                        </thead>
                                        <tbody id="DetalleDetalles"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div id="VentasRefresh1" style="display:none;" class="overlay">
                            <i class="fa fa-cog fa-spin fa-5x"></i>
                        </div>
                        <!-- /.box-body-->
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    // aplicar la fecha

    $('#fecha-meta').daterangepicker({
        singleDatePicker: true,
        showDropdowns: true,
        minYear: 2000,
        maxYear: parseInt(moment().format('YYYY'), 10) + 1
    });
    // aplica para recargar datos de solo mayoreo
    $('#tab-opcion-retail').click(function () {
        ObtenerMetas(2);
        ObtenerFacturaDetalle(2);
    });
    $('#tab-opcion-mayoreo').click(function () {
        ObtenerMetas(1);
        ObtenerFacturaDetalle(1);
    });
    $('#tab-opcion-internet').click(function () {
        ObtenerMetas(3);
        ObtenerFacturaDetalle(3);
    });
    $('#tab-opcion-franquicia').click(function () {
        ObtenerMetas(4);
        ObtenerFacturaDetalle(4);
    });

	//Variables globales
	var FechaMeta, VencidoAnioPasado, VencidoAnioActual, MetaAnioPasado, MetaAnioActual, CobradoAnioPasado, CobradoAnioActual, MetaExistente = 0;

	$("#Contenido").hide();

    // carga por defecto mayoreo
    ObtenerMetas(1);

    function ObtenerFacturaDetalle(idcanal) {
        var drp = $('#fecha-meta').data('daterangepicker');
        var Del = drp.startDate.format('YYYY/MM/DD');
        var Al = drp.endDate.format('YYYY/MM/DD');
        $('#VentasRefresh').show();
        // llena los detalles de facturas por cada evento
        $.post('@Url.Action("ObtenerDetallesMetas", "MetasCobranza")',
            {
                Del: Del,
                Al: Al,
                IdCanal: idcanal
            }, function (data) {
            if (data != null) {
                if ($.isArray(data.Context)) {

                    var VP = $('#Detalles').DataTable();
                    VP.destroy();
                    $("#DetalleDetalles").html('');
                    $.each(data.Context, function (index, value) {
                        $("#DetalleDetalles").append('<tr>\
                            <td>'+ value.IdFactura + '</td>\
                            <td>' + moment(value.FechaFactura).format('YYYY-MM-DD') + '</td>\
                            <td>' + moment(value.FechaVencimiento).format('YYYY-MM-DD') + '</td>\
                            <td> '+ value.CarCode + '</td >\
                            <td> '+ value.CardName + '</td >\
                            <td> '+ value.Canal + '</td >\
                            <td>'+ formatNumber.new(value.Saldo.toFixed(2), "$") + '</td>\
                        </tr>');
                    });


                    $('#Detalles').DataTable({
                        "lengthMenu": [[10, 20, 30, -1], [10, 20, 30, "All"]],
                        dom: 'Bfrtip',
                        buttons: [
                            'excel', 'pdf'
                        ],
                        "paging": true,
                        "searching": true,
                        "language": {
                            "url": "//cdn.datatables.net/plug-ins/1.10.13/i18n/Spanish.json"
                        }
                    });
                }

                $('#VentasRefresh').hide();
                $("#Contenido").show();

            } else {
                $('#VentasRefresh').hide();
                swal("No se encontraron registros");
                $("#Contenido").hide();
            }
        });


    }

    function ObtenerMetas(idcanal) {
        var drp = $('#fecha-meta').data('daterangepicker');
        var Del = drp.startDate.format('YYYY/MM/DD');
        var Al = drp.endDate.format('YYYY/MM/DD');

		$('#VentasRefresh').show();
        $.post('@Url.Action("ObtenerMetas", "MetasCobranza")', { IdCanal: idcanal }, function (data) {
            if (data != null) {
                if ($.isArray(data.Context)) {
                    var VP = $('#Metas').DataTable();
                    VP.destroy();
                    $("#DetalleMetas").html('');
                    $.each(data.Context, function (index, value) {
                                                $("#DetalleMetas").append('<tr>\
                                                <td>'+ moment(value.FechaMeta).format('YYYY-MM-DD')+'</td>\
												<td>'+ formatNumber.new(value.Vencido.toFixed(2), "$") + '</td>\
												<td>'+ formatNumber.new(value.MetaMonto.toFixed(2), "$") + '</td>\
												<td>'+ formatNumber.new(value.Cobrado.toFixed(2), "$") + '</td>\
												<td>' + moment(value.RegistradoEl).format('YYYY-MM-DD') + '</td>\
												<td>' + ((value.Cobrado / value.MetaMonto) * 100).toFixed(2) + ' %</td>\
                                            </tr>');
                    });
                    $('#Metas').DataTable({
                        "lengthMenu": [[10, 20, 30, -1], [10, 20, 30, "All"]],
						dom: 'Bfrtip',
						buttons: [
							'excel', 'pdf'
						],
                        "paging": true,
                        "searching": true,
                        "language": {
                            "url": "//cdn.datatables.net/plug-ins/1.10.13/i18n/Spanish.json"
                        }
                    });
                }

                $('#VentasRefresh').hide();
                $("#Contenido").show();
            }
            else {
				$('#VentasRefresh').hide();
                swal("No se encontraron registros");
				$("#Contenido").hide();
            }
        });




    }



	$("#btnGuardarMeta").hide();

    // canal de mayoreo
    var MayoreoNombre, MayoreoMetaMonto, MayoreoMontoVencido;
    // canal de retail
    var RetailNombre, RetailMetaMonto, RetailMontoVencido;
    // canal de internet
    var InternetNombre, InternetMetaMonto, InternetMontoVencido;
    // canal de franquicia
    var FranquiciaNombre, FranquiciaMetaMonto, FranquiciaMontoVencido;


    $("#btnSyncPagos").click(function () {
        $.confirm({
            title: '¡Confirmar!',
            content: 'Esto podría tomar unos segundos',
            type: 'red',
            buttons: {
                cancel: {
                    text: 'Cancelar',
                    action: function () {
                        $('#VentasRefresh1').show();
                        $('#VentasRefresh1').hide();
                    }
                },
                confirm: {
                    text: 'Confirmar',
                    action: function () {
                        $('#VentasRefresh1').show();
		                $.post('@Url.Action("SincronizarPagos", "MetasCobranza")', function (data) {
			                if (data != null) {
                                if (data.Code == 200) {
                                    ObtenerMetas(1);
                                    ObtenerFacturaDetalle(1);
                                    $('#meta-mayoreo').val('');
                                    $('#meta-retail').val('');
                                    $('#meta-internet').val('');
                                    $('#meta-franquicia').val('');

                                    $('#tab-2').removeClass('active');
                                    $('#tab-3').removeClass('active');
                                    $('#tab-4').removeClass('active');
                                    $('#tab-1').addClass('active');
                                    $('#VentasRefresh1').hide();
					                swal({
						                title: 'Correcto',
						                text: 'La sincronización se realizo con éxito.',
						                icon: 'success'
					                });
				                }
				                else{
					                swal({
					                title: 'Error',
					                text: 'no fue posible hacer la sincronización: ' + data.Message,
					                icon: 'error'
				                });
				                }
			                } else {
				                swal({
					                title: 'Error',
					                text: 'no fue posible hacer la sincronización',
					                icon: 'error'
				                });
                            }

                        });
                        $('#VentasRefresh1').hide();

                    }
                }
            }
        });



    });

    $("#btnPagos").click(function () {
        var drp = $('#fecha-meta').data('daterangepicker');
        var Del = drp.startDate.format('YYYY/MM/DD');
        var Al = drp.endDate.format('YYYY/MM/DD');
        FechaMeta = Del;

        $.confirm({
            title: '¡Confirmar!',
            content: 'Esto podría tomar unos segundos',
            type: 'Info',
            buttons: {
                cancel: {
                    text: 'Cancelar',
                    action: function() {
                        $('#VentasRefresh').show();
                        $('#VentasRefresh').hide();
                    }
                },
                confirm: {
                    text: 'Confirmar',
                    action: function() {
                        $('#VentasRefresh').show();
                        var blok = 0;

                        $.post('@Url.Action("AcumuladoVencidas", "MetasCobranza")', {
                            Del: Del,
                            Al: Al,
                            Tipo: 1 // fecha de la meta
                        }, function (data) {
                            if (data.Context != null) {
                                VencidoAnioActual = data.Context.Acumulado.toFixed(2);
                                if ($.isArray(data.Context.Canales)) {
                                    $.each(data.Context.Canales, function(index, value) {
                                        if (value.Nombre == 'INTERNET') {
                                            InternetNombre = 'INTERNET';
                                            InternetMontoVencido = value.Total;
                                            $("#lb-internet-anterior").html(formatNumber.new(value.Total.toFixed(2), "$"));

                                            if (data.Context.MetasExistentes.length > 0) {
                                                $.each(data.Context.MetasExistentes, function (index1, value1) {
                                                    if (value1.Nombre == 'INTERNET') {
                                                        if (value1.MontoMeta != 0) {
                                                            $("#meta-internet").val(value1.MontoMeta.toFixed(2));
                                                            MetaExistente += 1;
                                                            InternetMetaMonto = value1.MontoMeta.toFixed(2);
                                                        }
                                                        else {
                                                            $("#meta-internet").val((value.Total * (@System.Configuration.ConfigurationManager.AppSettings["PorcentajeMeta"])).toFixed(2));
                                                            InternetMetaMonto = (value.Total * (@System.Configuration.ConfigurationManager.AppSettings["PorcentajeMeta"])).toFixed(2);
                                                            MetaExistente += 0;
                                                        }
                                                    }
                                                });
                                            } else {
                                                $("#meta-internet").val((value.Total * (@System.Configuration.ConfigurationManager.AppSettings["PorcentajeMeta"])).toFixed(2));
                                                InternetMetaMonto = (value.Total * (@System.Configuration.ConfigurationManager.AppSettings["PorcentajeMeta"])).toFixed(2);
                                                MetaExistente += 0;
                                            }
                                        }
                                        if (value.Nombre == 'MAYOREO') {
                                            MayoreoNombre = 'MAYOREO';
                                            MayoreoMontoVencido = value.Total;
                                            $("#lb-mayoreo-anterior").html(formatNumber.new(value.Total.toFixed(2), "$"));

                                            if (data.Context.MetasExistentes.length > 0) {
                                                $.each(data.Context.MetasExistentes, function (index1, value1) {
                                                    if (value1.Nombre == 'MAYOREO') {
                                                        if (value1.MontoMeta != 0) {
                                                            $("#meta-mayoreo").val(value1.MontoMeta.toFixed(2));
                                                            MetaExistente += 1;
                                                            MayoreoMetaMonto = value1.MontoMeta.toFixed(2);
                                                        }
                                                        else {
                                                            $("#meta-mayoreo").val((value.Total * (@System.Configuration.ConfigurationManager.AppSettings["PorcentajeMeta"])).toFixed(2));
                                                            MayoreoMetaMonto = (value.Total * (@System.Configuration.ConfigurationManager.AppSettings["PorcentajeMeta"])).toFixed(2);
                                                            MetaExistente += 0;
                                                        }
                                                    }
                                                });
                                            }
                                            else {
                                                $("#meta-mayoreo").val((value.Total * (@System.Configuration.ConfigurationManager.AppSettings["PorcentajeMeta"])).toFixed(2));
                                                MayoreoMetaMonto = (value.Total * (@System.Configuration.ConfigurationManager.AppSettings["PorcentajeMeta"])).toFixed(2);
                                                MetaExistente += 0;
                                            }
                                        }
                                        if (value.Nombre == 'RETAIL') {
                                            RetailNombre = 'RETAIL';
                                            RetailMontoVencido = value.Total;
                                            $("#lb-retail-anterior").html(formatNumber.new(value.Total.toFixed(2), "$"));

                                            if (data.Context.MetasExistentes.length > 0) {
                                                $.each(data.Context.MetasExistentes, function (index1, value1) {
                                                    if (value1.Nombre == 'RETAIL') {
                                                        if (value1.MontoMeta != 0) {

                                                            $("#meta-retail").val(value1.MontoMeta.toFixed(2));
                                                            MetaExistente += 1;
                                                            RetailMetaMonto = value1.MontoMeta.toFixed(2);
                                                        }
                                                        else {
                                                            $("#meta-retail").val((value.Total * (@System.Configuration.ConfigurationManager.AppSettings["PorcentajeMeta"])).toFixed(2));
                                                            RetailMetaMonto = (value.Total * (@System.Configuration.ConfigurationManager.AppSettings["PorcentajeMeta"])).toFixed(2);
                                                            MetaExistente += 0;
                                                        }
                                                    }
                                                });
                                            } else {
                                                $("#meta-retail").val((value.Total * (@System.Configuration.ConfigurationManager.AppSettings["PorcentajeMeta"])).toFixed(2));
                                                RetailMetaMonto = (value.Total * (@System.Configuration.ConfigurationManager.AppSettings["PorcentajeMeta"])).toFixed(2);
                                                MetaExistente += 0;
                                            }
                                        }
                                        if (value.Nombre == 'FRANQUICIA') {
                                            FranquiciaNombre = 'FRANQUICIA';
                                            FranquiciaMontoVencido = value.Total;
                                            $("#lb-franquicia-anterior").html(formatNumber.new(value.Total.toFixed(2), "$"));

                                            if (data.Context.MetasExistentes.length > 0) {
                                                $.each(data.Context.MetasExistentes, function (index1, value1) {
                                                    if (value1.Nombre == 'FRANQUICIA') {
                                                        if (value1.MontoMeta != 0) {
                                                            $("#meta-franquicia").val(value1.MontoMeta.toFixed(2));
                                                            MetaExistente += 1;
                                                            RetailMetaMonto = value1.MontoMeta.toFixed(2);
                                                        }
                                                        else {
                                                            $("#meta-franquicia").val((value.Total * (@System.Configuration.ConfigurationManager.AppSettings["PorcentajeMeta"])).toFixed(2));
                                                            RetailMetaMonto = (value.Total * (@System.Configuration.ConfigurationManager.AppSettings["PorcentajeMeta"])).toFixed(2);
                                                            MetaExistente += 0;
                                                        }
                                                    }
                                                });
                                            } else {
                                                $("#meta-franquicia").val((value.Total * (@System.Configuration.ConfigurationManager.AppSettings["PorcentajeMeta"])).toFixed(2));
                                                RetailMetaMonto = (value.Total * (@System.Configuration.ConfigurationManager.AppSettings["PorcentajeMeta"])).toFixed(2);
                                                MetaExistente += 0;
                                            }
                                        }
                                    });
                                }
                                $("#acumulado-vencidas-anio-anterior").html(formatNumber.new(data.Context.Acumulado.toFixed(2), "$"));

                                blok++;

                                if (blok >= 2) {
                                    $('#VentasRefresh').hide();
                                }

                            } else {
                                $("#acumulado-vencidas-anio-anterior").html("no se pudo obtener la información");
                                $('#VentasRefresh').hide();
                            }


                        });

                        $.post('@Url.Action("AcumuladoVencidas", "MetasCobranza")', {
                            Del: Del,
                            Al: Al,
                            Tipo: 2 // fecha del dia de hoy
                        }, function (data) {
                            if (data.Context != null) {
                                VencidoAnioActual = data.Context.Acumulado.toFixed(2);
                                if ($.isArray(data.Context.Canales)) {
                                    $.each(data.Context.Canales, function(index, value) {
                                        if (value.Nombre == 'INTERNET') {
                                            $("#lb-internet-actual").html(formatNumber.new(value.Total.toFixed(2), "$"));
                                        }
                                        if (value.Nombre == 'MAYOREO') {
                                            $("#lb-mayoreo-actual").html(formatNumber.new(value.Total.toFixed(2), "$"));
                                        }
                                        if (value.Nombre == 'RETAIL') {
                                            $("#lb-retail-actual").html(formatNumber.new(value.Total.toFixed(2), "$"));
                                        }
                                        if (value.Nombre == 'FRANQUICIA') {
                                            $("#lb-franquicia-actual").html(formatNumber.new(value.Total.toFixed(2), "$"));
                                        }
                                    });
                                }
                                $("#acumulado-vencidas-anio-actual").html(formatNumber.new(data.Context.Acumulado.toFixed(2), "$"));

                                blok++;

                                if (blok >= 2) {
                                    $('#VentasRefresh').hide();
                                }

                            } else {
                                $("#acumulado-vencidas-anio-actual").html("no se pudo obtener la información");
                                $('#VentasRefresh').hide();
                            }
                            });
                        $('#tab-2').removeClass('active');
                        $('#tab-3').removeClass('active');
                        $('#tab-4').removeClass('active');
                        $('#tab-1').addClass('active');
                        ObtenerFacturaDetalle(1);

                        $("#btnGuardarMeta").show();
                    }
                }
            }
        });
    });




    $("#btnGuardarMeta").click(function () {
        $('#VentasRefresh').show();
        var mensaje = "";

        if (MetaExistente >= 1) {
            mensaje = "¿Ya existen metas asignadas para esta fecha, esta seguro de reemplazar?";
        } else {
            mensaje = "¿Esta seguro de agregar las metas?";
        }
        swal({
            html: "true",
            title: "Cuidado!",
            text: mensaje,
            icon: "warning",
            buttons: [
                'No, cancelar',
                'Si, estoy seguro'
            ],
            dangerMode: true
        }).then(function (isConfirm) {
            if (isConfirm) {
                if (MetaExistente == 0) {
                    $.post('@Url.Action("GuardarMetas", "MetasCobranza")', {
                        FechaMeta: FechaMeta,
                        Detalles: [{
                            Sequence: 1,
                            Nombre: MayoreoNombre,
                            MontoVencido: MayoreoMontoVencido,
                            MontoMeta: $("#meta-mayoreo").val()
                        }, {
                                Sequence: 2,
                                Nombre: RetailNombre,
                                MontoVencido: RetailMontoVencido,
                                MontoMeta: $("#meta-retail").val()
                            },
                            {
                                Sequence: 3,
                                Nombre: InternetNombre,
                                MontoVencido: InternetMontoVencido,
                                MontoMeta: $("#meta-internet").val()
                            },{
                                Sequence: 4,
                                Nombre: FranquiciaNombre,
                                MontoVencido: FranquiciaMontoVencido,
                                MontoMeta: $("#meta-franquicia").val()
                            }]
                    }, function (data) {
                        if (data != null) {
                            if (data.Context == "Erro API: AddMetodoCobranza") {
                                $("#btnGuardarMeta").hide();
                                swal("Error en la api: MetasCobranza/GuardarMetas");
                            } else {
                                //swal({
                                //    title: 'Operación exitosa',
                                //    text: 'El resultado de la peticion arrojo los siguientes resultados ' + data.Context,
                                //    //text: 'Los datos se guardaron correctamente ' + data.Context,
                                //    icon: 'success'
                                //});
                                $('#meta-mayoreo').val('');
                                $('#meta-retail').val('');
                                $('#meta-internet').val('');
                                $('#meta-franquicia').val('');

                                $('#tab-2').removeClass('active');
                                $('#tab-3').removeClass('active');
                                $('#tab-4').removeClass('active');
                                $('#tab-1').addClass('active');



                                $("#btnGuardarMeta").hide();
                                ObtenerMetas(1);
                                ObtenerFacturaDetalle(1);
                            }
                        } else {
                            $("#btnGuardarMeta").hide();
                            swal("Error en la api: MetasCobranza/GuardarMetas");
                        }
                        MetaExistente = 0;
                        $('#VentasRefresh').hide();
                    });
                } else {
                    $.post('@Url.Action("ActualizarMetas", "MetasCobranza")', {
                        FechaMeta: FechaMeta,
                        Detalles: [{
                            Sequence: 1,
                            Nombre: MayoreoNombre,
                            MontoVencido: MayoreoMontoVencido,
                            MontoMeta: $("#meta-mayoreo").val()
                        }, {
                            Sequence: 2,
                            Nombre: RetailNombre,
                            MontoVencido: RetailMontoVencido,
                            MontoMeta: $("#meta-retail").val()
                        },
                        {
                            Sequence: 3,
                            Nombre: InternetNombre,
                            MontoVencido: InternetMontoVencido,
                            MontoMeta: $("#meta-internet").val()
                        }, {
                            Sequence: 4,
                            Nombre: FranquiciaNombre,
                            MontoVencido: FranquiciaMontoVencido,
                            MontoMeta: $("#meta-franquicia").val()
                        }]
                    }, function (data) {
                        if (data != null) {
                            //swal({
                            //    title: 'Operación exitosa',
                            //    text: 'El resultado de la peticion arrojo los siguientes resultados actualizados ' + data.Context,
                            //    icon: 'success'
                            //});
                            $('#meta-mayoreo').val('');
                            $('#meta-retail').val('');
                            $('#meta-internet').val('');
                            $('#meta-franquicia').val('');

                            $("#btnGuardarMeta").hide();

                            $('#tab-2').removeClass('active');
                            $('#tab-3').removeClass('active');
                            $('#tab-4').removeClass('active');
                            $('#tab-1').addClass('active');

                            ObtenerMetas(1);
                            ObtenerFacturaDetalle(1);
                        } else {
                            $("#btnGuardarMeta").hide();
                            swal("Error en la api: MetasCobranza/ActualizarMetas");
                        }
                        MetaExistente = 0;
                        $('#VentasRefresh').hide();
                    });
                }
            } else {
                $('#VentasRefresh').hide();
                swal("Cancelado", "La operación fue cancelada por el usuario.", "error");
            }
        });
    });

    var formatNumber = {
        separador: ",", // separador para los miles
        sepDecimal: '.', // separador para los decimales
        formatear: function (num) {
            num += '';
            var splitStr = num.split('.');
            var splitLeft = splitStr[0];
            var splitRight = splitStr.length > 1 ? this.sepDecimal + splitStr[1] : '';
            var regx = /(\d+)(\d{3})/;
            while (regx.test(splitLeft)) {
                splitLeft = splitLeft.replace(regx, '$1' + this.separador + '$2');
            }
            return this.simbol + splitLeft + splitRight;
        },
        new: function (num, simbol) {
            this.simbol = simbol || '';
            return this.formatear(num);
        }
    }
</script>
