
@{
    ViewBag.Title = "Index";
}

<section class="content-header">
    <h1>
        Tarimas
        <small>Inicio</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Tarimas</a></li>
        <li class="active">Inicio</li>
        <li> LVV</li>
    </ol>
</section>

<section class="content">
    <div class="row">
        <div class="col-md-3 col-sm-4 col-xs-12">
            <div class="box box-danger">
                <div class="box-header with-border">
                    <i class="fa fa-refresh"></i>

                    <h3 class="box-title">Sincronización</h3>

                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="box-body">
                    <div class="row">
                        <div class="col-md-6 col-sm-6 col-xs-6">
                            <ul class="list-inline pull-left">
                                <li><button type="button" class="btn btn-success SyncSIE">Sincronizar SIE</button></li>
                            </ul>
                        </div>
                        <div class="col-md-6 col-sm-6 col-xs-6">
                            <ul class="list-inline pull-left">
                                <!--data-toggle="modal" data-target="#modal-danger"-->
                                <li><button type="button" class="btn btn-danger SyncSAP">Sincronizar SAP</button></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="box-footer">

                </div>
                <div id="ButtonsWait" style="display:none;" class="overlay">
                    <i class="fa fa-refresh fa-spin"></i>
                </div>
            </div>
        </div>
        <div class="col-md-9 col-sm-8 col-xs-12">
            <div class="box box-danger">
                <div class="box-header with-border">
                    <i class="fa fa-filter"></i>

                    <h3 class="box-title">Filtros</h3>

                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="box-body">
                    <div class="row">
                        <div class="col-md-6 col-sm-12 col-xs-12">
                            <div class="form-group">
                                <div class="input-group">
                                    <div class="input-group-addon">
                                        <i class="fa fa-calendar"></i>
                                    </div>
                                    <input type="text" class="form-control pull-right" id="RangoFechas">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-sm-12 col-xs-12">
                            <ul class="list-inline pull-right">
                                <li><button type="button" class="btn btn-success BuscarSIE">Buscar</button></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="box-footer">

                </div>
                <div id="FiltrosWait" style="display:none;" class="overlay">
                    <i class="fa fa-refresh fa-spin"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="box box-danger">
                <div class="box-header with-border">
                    <i class="fa fa-database"></i>

                    <h3 class="box-title">Detalles</h3>

                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="box-body">
                    <div class="row">
                        <div class="col-md-3 col-sm-3 col-xs-6">
                            <div class="info-box bg-aqua pull-left">
                                <span class="info-box-icon"><i class="fa fa-dollar"></i></span>

                                <div class="info-box-content">
                                    <span class="info-box-text">Monto total de pedidos</span>
                                    <span class="info-box-number" id="MontoTotalDinero"></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-3 col-xs-6">
                            <div class="info-box bg-green pull-right">
                                <span class="info-box-icon"><i class="fa">#</i></span>

                                <div class="info-box-content">
                                    <span class="info-box-text">Total pedidos</span>
                                    <span class="info-box-number" id="TotalPedidos"></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-3 col-xs-6">
                            <div class="info-box bg-yellow pull-left">
                                <span class="info-box-icon"><i class="fa">#</i></span>

                                <div class="info-box-content">
                                    <span class="info-box-text">Total clientes</span>
                                    <span class="info-box-number" id="TotalClientes"></span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 col-sm-3 col-xs-6">
                            <div class="info-box bg-red pull-right">
                                <span class="info-box-icon"><i class="fa">#</i></span>

                                <div class="info-box-content">
                                    <span class="info-box-text">Total piezas</span>
                                    <span class="info-box-number" id="TotalPiezas"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table table-responsive">
                        <table id="Cabecera" class="table table-bordered">
                            <thead>
                                <tr>
                                    <td style="width: 140px !important;"><input type="checkbox" id="cbxTodos" />Seleccionar todos</td>
                                    <th>Sequence</th>
                                    <th>Factura</th>
                                    <th>Código cliente</th>
                                    <th>Nombre cliente</th>
                                    <th>Fecha(MM/dd/YYYY)</th>
                                    <th>Tarimas</th>
                                    <th>No. piezas</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="Detalles"></tbody>
                        </table>
                    </div>
                </div>
                <div class="box-footer">

                </div>
                <div id="DetallesWait" style="display:none;" class="overlay">
                    <i class="fa fa-refresh fa-spin"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="modal modal-danger fade" id="modal-danger">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">Sincronizar a SAP</h4>
                </div>
                <div class="modal-body">
                    @*<span class="input-group-addon">Almacenes:</span>
                        <select name="cbxEmisor" id="cbxEmisor" class="form-control">
                            foreach (var td in this.Model.Emisores)
                            {
                                <option value="td">td </option>
                            }
                        </select>*@
                    <div class="form-group">
                        <label>Total tarimas:</label>
                        <div class="input-group">
                            <div class="input-group-addon">
                                <i class="fa fa-bars"></i>
                            </div>
                            <input id="tarimas" type="number" class="form-control pull-right">
                        </div>
                        <!-- /.input group -->
                    </div>
                    <div class="form-group">
                        <label>Items completados(separados por comas):</label>
                        <div class="input-group">
                            <div class="input-group-addon">
                                <i class="fa fa-bars"></i>
                            </div>
                            <input id="completados" type="text" class="form-control pull-right">
                        </div>
                        <!-- /.input group -->
                    </div>
                    <div class="form-group">
                        <label>Items cacelados(separados por comas):</label>
                        <div class="input-group">
                            <div class="input-group-addon">
                                <i class="fa fa-bars"></i>
                            </div>
                            <input id="cancelados" type="text" class="form-control pull-right">
                        </div>
                        <!-- /.input group -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline pull-left" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-outline">Sincronizar</button>
                </div>
            </div>
        </div>
    </div>
</section>
<script>

    $("#cbxTodos").on("click", function () {
        $(".procesar").prop("checked", this.checked);

    });

    $(".BuscarSIE").click(function () {
        showOverlays();

        var drp = $('#RangoFechas').data('daterangepicker');
        var Del = drp.startDate.format('YYYY/MM/DD');
        var Al = drp.endDate.format('YYYY/MM/DD');

        $.confirm({
            title: '¡Confirmar!',
            content: '¿Los parametros de busqueda son correctos?.',
            type: 'blue',
            buttons: {
                confirm: {
                    text: 'Confirmar',
                    action: function () {
                        $.post('@Url.Action("Buscar", "Tarimas")', {
                            Inicio: Del,
                            Termino: Al
                        }, function (data) {
                            hideOverlays();
                            if (data.Code == -1) {
                                swal({
                                    title: "Error!",
                                    text: data.Message,
                                    icon: "error",
                                    button: "ok",
                                });
                            } else {
                                if (data.Context.Tarimas.length <= 0) {
                                    swal({
                                        title: "Advertencia!",
                                        text: "No se encontraron registros para los filtros especificados.",
                                        icon: "warning",
                                        button: "ok",
                                    });
                                }
                                else {
                                    if (data.Context != null && $.isArray(data.Context.Tarimas)) {
                                        var VP = $('#Cabecera').DataTable();
                                        VP.destroy();
                                        $("#Detalles").html('');

                                        //Asignamos los valores a los recuadros de resumen
                                        $("#MontoTotalDinero").html(formatNumber.new(data.Context.MontoTotalPedidos.toFixed(2), "$"));
                                        $("#TotalPedidos").html(data.Context.NoPedidos);
                                        $("#TotalClientes").html(data.Context.NoClientes);
                                        $("#TotalPiezas").html(data.Context.NoPiezas);

                                        $.each(data.Context.Tarimas, function (index, value) {
                                            $("#Detalles").append('<tr>\
                                                <td><input value="'+ value.Identifier + '" type="checkbox" class="procesar" tarimas="' + value.NoCajas +'" style="max - width: 50px;"/></td>\
                                        <td>' + value.Identifier + '</td>\
							            <td>' + value.DocNum + '</td>\
                                        <td>' + value.CardCodeCliente + '</td>\
                                        <td>' + value.CardNameCliente + '</td>\
							            <td>' + moment(value.DocDate).format('L') + '</td>\
							            <td>' + value.NoCajas + '</td>\
							            <td>' + value.NoPiezas + '</td>\
							            <td>' + formatNumber.new(value.DocTotal.toFixed(2), "$") + '</td>\
						             </tr>\>');
                                        });

                                        $('#Cabecera').DataTable({
                                            "dom": "Bfrtip",
                                            "buttons": [
                                                "excel", "pdf"
                                            ],
                                            "paging": true,
                                            "pageLength": 100,
                                            "lengthChange": true,
                                            "searching": true,
                                            "ordering": true,
                                            "info": true,
                                            "autoWidth": true,
                                            "language": {
                                                "url": "//cdn.datatables.net/plug-ins/1.10.13/i18n/Spanish.json"
                                            }
                                        });
                                    }
                                }
                            }
                        });
                    }
                },
                cancel: {
                    text: 'Cancelar',
                    action: function () {
                        hideOverlays();
                        $.alert('La busqueda ha sido cancelada por el usuario.');
                    }
                }
            }
        });
    });

    //Sincronización a SIE
    $(".SyncSIE").click(function () {
        showOverlays();

        $.confirm({
            title: '¡Confirmar!',
            content: '¿Esta seguro de realizar la sincronización a SIE?.',
            type: 'blue',
            buttons: {
                confirm: {
                    text: 'Confirmar',
                    action: function () {
                        $.post('@Url.Action("SincronizarSIE", "Tarimas")', {
                        }, function (data) {
                            if (data.Code == -1) {
                                swal({
                                    title: "Error!",
                                    text: data.Message,
                                    icon: "error",
                                    button: "ok",
                                });
                            } else if (data.Context < 0) {
                                swal({
                                    title: "Error!",
                                    text: "Ocurrio un error al procesar la petición en la base de datos.",
                                    icon: "error",
                                    button: "ok",
                                });
                            } else {
                                if (data != null) {
                                    if (data.Context == 0) {
                                        swal({
                                            title: "Precaución",
                                            text: "No hay registros pendientes por agregar, la base de datos está actualizada.",
                                            icon: "warning",
                                            button: "estiendo",
                                        });
                                    } else if (data.Context > 0) {
                                        swal({
                                            title: "Correcto",
                                            text: "Se han agregado " + data.Context + " registros.",
                                            icon: "success",
                                            button: "ok",
                                        });
                                    }

                                }
                            }
                            hideOverlays();
                        });
                    }
                },
                cancel: {
                    text: 'Cancelar',
                    action: function () {
                        hideOverlays();
                        $.alert('La sincronización ha sido cancelada por el usuario.');
                    }
                }
            }
        });
    });

    //Sincronización a SAP
    $(".SyncSAP").click(function (e) {
        e.preventDefault();
        showOverlays();
        var cancelados = "";
        $('.procesar:not(:checked)').each(function (index, value) {
            //alert(JSON.stringify($(this).val()));
            cancelados = cancelados + $(this).val() + ","
        });

        var completados = "";
        var tarimas = 0.0;
        $('.procesar:checked').each(function (index, value) {
            //alert(JSON.stringify($(this).val()));
            completados = completados + $(this).val() + ",";
            tarimas = tarimas + parseFloat($(this).attr("tarimas"));
        });

        if (tarimas <= 0) {
            swal({
                title: "Error!",
                text: "El valor de las tarimas debé ser mayor a 0",
                icon: "error",
                button: "ok",
            });
            hideOverlays();
            return;
        }

        if (completados <= "") {
            swal({
                title: "Error!",
                text: "No hay pedidos para procesar",
                icon: "error",
                button: "ok",
            });
            hideOverlays();
            return;
        }

        $.confirm({
            title: '¡Confirmar!',
            content: '¿Esta seguro de realizar la sincronización a SAP?',
            type: 'red',
            buttons: {
                confirm: {
                    text: 'Confirmar',
                    action: function () {
                        $.post('@Url.Action("SincronizarSAP", "Tarimas")', {
                            Tarimas: tarimas,
                            Completados: completados,
                            Cancelados: cancelados
                        }, function (data) {
                            if (data.Code == -1) {
                                swal({
                                    title: "Error!",
                                    text: data.Message,
                                    icon: "error",
                                    button: "ok",
                                });
                            } else {
                                swal({
                                    title: "Correcto",
                                    text: "Sincronización a SAP exitosa.",
                                    icon: "success",
                                    button: "ok",
                                }).then((value) => {
                                    location.reload();
                                });


                            }

                            hideOverlays();
                            $("#tarimas").val("");
                            $("#completados").val("");
                            $("#cancelados").val("");

                            $("#modal-danger").modal('hide');
                        });
                    }
                },
                cancel: {
                    text: 'Cancelar',
                    action: function () {
                        hideOverlays();
                        $("#tarimas").val("");
                        $("#completados").val("");
                        $("#cancelados").val("");

                        $("#modal-danger").modal('hide');
                        $.alert('La sincronización ha sido cancelada por el usuario.');
                    }
                }
            }
        });
    });
    /*$(".SyncSAP").click(function () {
        showOverlays();

        var drp = $('#RangoFechas').data('daterangepicker');
        var Del = drp.startDate.format('YYYY/MM/DD');
        var Al = drp.endDate.format('YYYY/MM/DD');

        $.confirm({
            title: '¡Confirmar!',
            content: '¿Esta seguro de realizar la sincronización a SAP?',
            type: 'red',
            buttons: {
                confirm: {
                    text: 'Confirmar',
                    action: function () {
                        $.post('Url.Action("SincronizarSAP", "Tarimas")', {
                            Inicio: Del,
                            Termino: Al
                        }, function (data) {
                            if (data.Code == -1) {
                                swal({
                                    title: "Error!",
                                    text: data.Message,
                                    icon: "error",
                                    button: "ok",
                                });
                            } else {
                                swal({
                                    title: "Correcto",
                                    text: "Sincronización a SAP exitosa.",
                                    icon: "success",
                                    button: "ok",
                                }).then((value) => {
                                    location.reload();
                                });


                            }

                            hideOverlays();
                        });
                    }
                },
                cancel: {
                    text: 'Cancelar',
                    action: function () {
                        hideOverlays();
                        $.alert('La sincronización ha sido cancelada por el usuario.');
                    }
                }
            }
        });
    });*/

    function showOverlays() {
        $("#ButtonsWait").show();
        $("#FiltrosWait").show();
        $("#DetallesWait").show();
    }

    function hideOverlays() {
        $("#ButtonsWait").hide();
        $("#FiltrosWait").hide();
        $("#DetallesWait").hide();
    }

    $("#RangoFechas").daterangepicker({
        locale: {
            cancelLabel: "Clear",
            daysOfWeek: ["Do", "Lu", "Ma", "Mi", "Ju", "Vi", "Sa"],
            monthNames: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]
        }

    }).on('apply.daterangepicker', function (ev, picker) {//Cuando se oprime el boton de aceptar
            hideOverlays();
        }).on('show.daterangepicker', function (ev, picker) {//Cuando se muestra
            showOverlays();
        }).on('hide.daterangepicker', function (ev, picker) {//Cuando se esconde
            hideOverlays();
        });

    var formatNumber = {
        separador: ",", // separador para los miles
        sepDecimal: '.', // separador para los decimales
        formatear: function (num) {
            num += '';
            var splitStr = num.split('.');
            var splitLeft = splitStr[0];
            var splitRight = splitStr.length > 1 ? this.sepDecimal + splitStr[1] : '';
            var regx = /(\d+)(\d{3})/;
            while (regx.test(splitLeft)) {
                splitLeft = splitLeft.replace(regx, '$1' + this.separador + '$2');
            }
            return this.simbol + splitLeft + splitRight;
        },
        new: function (num, simbol) {
            this.simbol = simbol || '';
            return this.formatear(num);
        }
    }

</script>
